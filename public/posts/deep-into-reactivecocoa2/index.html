<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <title>
ReactiveCocoa2实战
</title>
  <link rel="stylesheet" href="/assets/main.css?gkCPK9ibGk2PIXzFp9c+CG7gIjpFY2pNyZ+E7aXMGlU=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/deep-into-reactivecocoa2/">

<meta name="twitter:title" content="ReactiveCocoa2实战">
<meta property="og:title" content="ReactiveCocoa2实战">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center opacity-80 bg-black h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;">ReactiveCocoa2实战</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2014-06-06</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <p>之前已经写过两篇关于 ReactiveCocoa(以下简称 RAC)的文章了，但主要也是在阐述基本的概念和使用，这篇文章将会从实战的角度来看看 RAC 到底解决了哪些问题，带来了哪些方便，以及遇到的一些坑。</p>
<h3 id="gai-shu">概述</h3>
<h4 id="wei-shi-yao-yao-shi-yong-rac">为什么要使用 RAC？</h4>
<p>一个怪怪的东西，从 Demo 看也没有让代码变得更好、更短，相反还造成理解上的困难，真的有必要去学它么？相信这是大多数人在接触 RAC 时的想法。RAC 不是单一功能的模块，它是一个 Framework，提供了一整套解决方案。其核心思想是「响应数据的变化」，在这个基础上有了 Signal 的概念，进而可以帮助减少状态变量(可以参考 jspahrsummers 的<a href="https://github.com/jspahrsummers/enemy-of-the-state">PPT</a>)，使用 MVVM 架构，统一的异步编程模型等等。</p>
<p>为什么 RAC 更加适合编写 Cocoa App？说这个之前，我们先来看下 Web 前端编程，因为有些相似之处。目前很火的 AngularJS 有一个很重要的特性：数据与视图绑定。就是当数据变化时，视图不需要额外的处理，便可正确地呈现最新的数据。而这也是 RAC 的亮点之一。RAC 与 Cocoa 的编程模式，有点像 AngularJS 和 jQuery。所以要了解 RAC，需要先在观念上做调整。</p>
<p>以下面这个 Cell 为例</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-demo.png"
    srcset="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-demo.png 160.5w,&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-demo.png 160.5w"
    sizes="(max-width: 160.5px) 100vw, 160.5px" width="160.5" /></p>
<p>正常的写法可能是这样，很直观。</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)configureWithItem</span><span style="color:#3e999f;">:</span><span>(HBItem </span><span style="color:#3e999f;">*</span><span>)item
</span><span>{
</span><span>	</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">username</span><span>.</span><span style="color:#c82728;">text </span><span style="color:#3e999f;">=</span><span> item.</span><span style="color:#c82728;">text</span><span>;
</span><span>	[</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">avatarImageView</span><span> setImageWithURL</span><span style="color:#3e999f;">:</span><span> item.</span><span style="color:#c82728;">avatarURL</span><span>];
</span><span>	</span><span style="color:#8e908c;">// 其他的一些设置
</span><span>}
</span></code></pre>
<p>但如果用 RAC，可能就是这样</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">id</span><span>)init
</span><span>{
</span><span>	</span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">self </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">init</span><span>]) {
</span><span>		@</span><span style="color:#c82728;">weakify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>		[</span><span style="color:#c82728;">RACObserve</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, viewModel)</span><span> subscribeNext</span><span style="color:#3e999f;">:^</span><span>(HBItemViewModel </span><span style="color:#3e999f;">*</span><span>viewModel) {
</span><span>			@</span><span style="color:#c82728;">strongify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>			</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">username</span><span>.</span><span style="color:#c82728;">text </span><span style="color:#3e999f;">=</span><span> viewModel.</span><span style="color:#c82728;">item</span><span>.</span><span style="color:#c82728;">text</span><span>;
</span><span>			[</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">avatarImageView</span><span> setImageWithURL</span><span style="color:#3e999f;">:</span><span> viewModel.</span><span style="color:#c82728;">item</span><span>.</span><span style="color:#c82728;">avatarURL</span><span>];
</span><span>			</span><span style="color:#8e908c;">// 其他的一些设置
</span><span>		}];
</span><span>	}
</span><span>}
</span></code></pre>
<p>也就是先把数据绑定，接下来只要数据有变化，就会自动响应变化。在这里，每次 viewModel 改变时，内容就会自动变成该 viewModel 的内容。</p>
<h4 id="signal">Signal</h4>
<p>Signal 是 RAC 的核心，为了帮助理解，画了这张简化图</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-signal.png"
    srcset="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-signal.png 371.5w,&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-signal.png 371.5w"
    sizes="(max-width: 371.5px) 100vw, 371.5px" width="371.5" /></p>
<p>这里的数据源和 sendXXX，可以理解为函数的参数和返回值。当 Signal 处理完数据后，可以向下一个 Signal 或 Subscriber 传送数据。可以看到上半部分的两个 Signal 是冷的(cold)，相当于实现了某个函数，但该函数没有被调用。同时也说明了 Signal 可以被组合使用，比如<code>RACSignal *signalB = [signalA map:^id(id x){return x}]</code>，或<code>RACSignal *signalB = [signalA take:1]</code>等等。</p>
<p>当 signal 被 subscribe 时，就会处于热(hot)的状态，也就是该函数会被执行。比如上面的第二张图，首先 signalA 可能发了一个网络请求，拿到结果后，把数据通过<code>sendNext</code>方法传递到下一个 signal，signalB 可以根据需要做进一步处理，比如转换成相应的 Model，转换完后再<code>sendNext</code>到 subscriber，subscriber 拿到数据后，再改变 ViewModel，同时因为 View 已经绑定了 ViewModel，所以拿到的数据会自动在 View 里呈现。</p>
<p>还有，一个 signal 可以被多个 subscriber 订阅，这里怕显得太乱就没有画出来，但每次被新的 subscriber 订阅时，都会导致数据源的处理逻辑被触发一次，这很有可能导致意想不到的结果，需要注意一下。</p>
<p>当数据从 signal 传送到 subscriber 时，还可以通过<code>doXXX</code>来做点事情，比如打印数据。</p>
<p>通过这张图可以看到，这非常像中学时学的函数，比如 <code>f(x) = y</code>，某一个函数的输出又可以作为另一个函数的输入，比如 <code>f(f(x)) = z</code>，这也正是「函数响应式编程」(FRP)的核心。</p>
<p>有些地方需要注意下，比如把 signal 作为 local 变量时，如果没有被 subscribe，那么方法执行完后，该变量会被 dealloc。但如果 signal 有被 subscribe，那么 subscriber 会持有该 signal，直到 signal sendCompleted 或 sendError 时，才会解除持有关系，signal 才会被 dealloc。</p>
<h4 id="raccommand">RACCommand</h4>
<p><code>RACCommand</code>是 RAC 很重要的组成部分，可以节省很多时间并且让你的 App 变得更 Robust，<a href="http://codeblog.shape.dk/blog/2013/12/05/reactivecocoa-essentials-understanding-and-using-raccommand/">这篇文章</a>可以帮助你更深入的理解，这里简单做一下介绍。</p>
<p><code>RACCommand</code> 通常用来表示某个 Action 的执行，比如点击 Button。它有几个比较重要的属性：executionSignals / errors / executing。</p>
<ul>
<li><code>executionSignals</code>是 signal of signals，如果直接 subscribe 的话会得到一个 signal，而不是我们想要的 value，所以一般会配合<code>switchToLatest</code>。</li>
<li><code>errors</code>。跟正常的 signal 不一样，<code>RACCommand</code>的错误不是通过<code>sendError</code>来实现的，而是通过<code>errors</code>属性传递出来的。</li>
<li><code>executing</code>表示该 command 当前是否正在执行。</li>
</ul>
<p>假设有这么个需求：当图片载入完后，分享按钮才可用。那么可以这样：</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>RACSignal </span><span style="color:#3e999f;">*</span><span>imageAvailableSignal </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">RACObserve</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, imageView.</span><span style="color:#c82728;">image</span><span style="color:#4271ae;">)</span><span> map</span><span style="color:#3e999f;">:</span><span style="color:#8959a8;">id</span><span style="color:#3e999f;">^</span><span>(</span><span style="color:#8959a8;">id </span><span>x){</span><span style="color:#8959a8;">return</span><span> x </span><span style="color:#3e999f;">?</span><span> @</span><span style="color:#f07219;">YES </span><span style="color:#3e999f;">:</span><span> @</span><span style="color:#f07219;">NO</span><span>}];
</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">shareButton</span><span>.</span><span style="color:#c82728;">rac_command </span><span style="color:#3e999f;">= </span><span>[[RACCommand </span><span style="color:#4271ae;">alloc</span><span>] initWithEnabled</span><span style="color:#3e999f;">:</span><span>imageAvailableSignal signalBlock</span><span style="color:#3e999f;">:^</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>(</span><span style="color:#8959a8;">id </span><span>input) {
</span><span>	</span><span style="color:#8e908c;">// do share logic
</span><span>}];
</span></code></pre>
<p>除了与<code>UIControl</code>绑定之外，也可以手动执行某个 command，比如双击图片点赞，就可以这么实现。</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8e908c;">// ViewModel.m
</span><span style="color:#3e999f;">- </span><span>(instancetype)init
</span><span>{
</span><span>    </span><span style="color:#c82728;">self </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">init</span><span>];
</span><span>    </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">self</span><span>) {
</span><span>        </span><span style="color:#8959a8;">void </span><span>(</span><span style="color:#3e999f;">^</span><span>updatePinLikeStatus)() </span><span style="color:#3e999f;">= ^</span><span>{
</span><span>            </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">likedCount </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">hasLiked </span><span style="color:#3e999f;">? </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">likedCount </span><span style="color:#3e999f;">- </span><span style="color:#f07219;">1 </span><span style="color:#3e999f;">: </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">likedCount </span><span style="color:#3e999f;">+ </span><span style="color:#f07219;">1</span><span>;
</span><span>            </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">hasLiked </span><span style="color:#3e999f;">= !</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">hasLiked</span><span>;
</span><span>        };
</span><span>
</span><span>        _likeCommand </span><span style="color:#3e999f;">= </span><span>[[RACCommand </span><span style="color:#4271ae;">alloc</span><span>] initWithSignalBlock</span><span style="color:#3e999f;">:^</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>(</span><span style="color:#8959a8;">id </span><span>input) {
</span><span>            </span><span style="color:#8e908c;">// 先展示效果，再发送请求
</span><span>            </span><span style="color:#c82728;">updatePinLikeStatus</span><span style="color:#4271ae;">()</span><span>;
</span><span>            </span><span style="color:#8959a8;">return </span><span>[[HBAPIManager </span><span style="color:#4271ae;">sharedManager</span><span>] likePinWithPinID</span><span style="color:#3e999f;">:</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pin</span><span>.</span><span style="color:#c82728;">pinID</span><span>];
</span><span>        }];
</span><span>
</span><span>        [_likeCommand.</span><span style="color:#c82728;">errors</span><span> subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x) {
</span><span>            </span><span style="color:#8e908c;">// 发生错误时，回滚
</span><span>            </span><span style="color:#c82728;">updatePinLikeStatus</span><span style="color:#4271ae;">()</span><span>;
</span><span>        }];
</span><span>    }
</span><span>    </span><span style="color:#8959a8;">return </span><span style="color:#c82728;">self</span><span>;
</span><span>}
</span><span>
</span><span style="color:#8e908c;">// ViewController.m
</span><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)viewDidLoad
</span><span>{
</span><span>	[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">viewDidLoad</span><span>];
</span><span>	</span><span style="color:#8e908c;">// ...
</span><span>    @</span><span style="color:#c82728;">weakify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>    [</span><span style="color:#c82728;">RACObserve</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, viewModel.</span><span style="color:#c82728;">hasLiked</span><span style="color:#4271ae;">)</span><span> subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x){
</span><span>        @</span><span style="color:#c82728;">strongify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>        </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">pinLikedCountLabel</span><span>.</span><span style="color:#c82728;">text </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">viewModel</span><span>.</span><span style="color:#c82728;">likedCount</span><span>;
</span><span>        </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">likePinImageView</span><span>.</span><span style="color:#c82728;">image </span><span style="color:#3e999f;">= </span><span>[UIImage </span><span style="color:#4271ae;">imageNamed:</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">viewModel</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">hasLiked </span><span style="color:#3e999f;">? </span><span style="color:#839c00;">@&quot;pin_liked&quot; </span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;pin_like&quot;</span><span>];
</span><span>    }];
</span><span>
</span><span>    UITapGestureRecognizer </span><span style="color:#3e999f;">*</span><span>tapGesture </span><span style="color:#3e999f;">= </span><span>[[UITapGestureRecognizer </span><span style="color:#4271ae;">alloc</span><span>] init];
</span><span>    tapGesture.</span><span style="color:#c82728;">numberOfTapsRequired </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">2</span><span>;
</span><span>    [[tapGesture </span><span style="color:#4271ae;">rac_gestureSignal</span><span>] subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x) {
</span><span>        [</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">viewModel</span><span>.</span><span style="color:#c82728;">likeCommand</span><span> execute</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">nil</span><span>];
</span><span>    }];
</span><span>}
</span></code></pre>
<p>再比如某个 App 要通过 Twitter 登录，同时允许取消登录，就可以这么做 (<a href="https://github.com/ReactiveCocoa/ReactiveCocoa/issues/1326">source</a>)</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>_twitterLoginCommand </span><span style="color:#3e999f;">= </span><span>[[RACCommand </span><span style="color:#4271ae;">alloc</span><span>] initWithSignalBlock</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>_) {
</span><span>      @</span><span style="color:#c82728;">strongify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>      </span><span style="color:#8959a8;">return </span><span>[[</span><span style="color:#c82728;">self
</span><span>          twitterSignInSignal]
</span><span>          takeUntil</span><span style="color:#3e999f;">:</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">cancelCommand</span><span>.</span><span style="color:#c82728;">executionSignals</span><span>];
</span><span>    }];
</span><span>
</span><span style="color:#c82728;">RAC</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">authenticatedUser</span><span style="color:#4271ae;">) </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">twitterLoginCommand</span><span>.</span><span style="color:#c82728;">executionSignals</span><span> switchToLatest];
</span></code></pre>
<h3 id="chang-yong-de-mo-shi">常用的模式</h3>
<h4 id="map-switchtolatest">map + switchToLatest</h4>
<p><code>switchToLatest:</code> 的作用是自动切换 signal of signals 到最后一个，比如之前的 command.executionSignals 就可以使用<code>switchToLatest:</code>。</p>
<p><code>map:</code>的作用很简单，对<code>sendNext</code>的 value 做一下处理，返回一个新的值。</p>
<p>如果把这两个结合起来就有意思了，想象这么个场景，当用户在搜索框输入文字时，需要通过网络请求返回相应的 hints，每当文字有变动时，需要取消上一次的请求，就可以使用这个配搭。这里用另一个 Demo，简单演示一下</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#c99e00;">NSArray </span><span style="color:#3e999f;">*</span><span>pins </span><span style="color:#3e999f;">=</span><span> @[@</span><span style="color:#f07219;">172230988</span><span>, @</span><span style="color:#f07219;">172230947</span><span>, @</span><span style="color:#f07219;">172230899</span><span>, @</span><span style="color:#f07219;">172230777</span><span>, @</span><span style="color:#f07219;">172230707</span><span>];
</span><span>__block </span><span style="color:#c99e00;">NSInteger</span><span> index </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span>;
</span><span>
</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>signal </span><span style="color:#3e999f;">= </span><span>[[[[RACSignal </span><span style="color:#4271ae;">interval:</span><span style="color:#f07219;">0.1 </span><span style="color:#4271ae;">onScheduler:[RACScheduler scheduler]</span><span>]
</span><span>						take</span><span style="color:#3e999f;">:</span><span>pins.</span><span style="color:#c82728;">count</span><span>]
</span><span>						map</span><span style="color:#3e999f;">:^</span><span style="color:#8959a8;">id</span><span>(</span><span style="color:#8959a8;">id </span><span>value) {
</span><span>							</span><span style="color:#8959a8;">return </span><span>[[[HBAPIManager </span><span style="color:#4271ae;">sharedManager</span><span>] fetchPinWithPinID</span><span style="color:#3e999f;">:</span><span>[pins[index</span><span style="color:#3e999f;">++</span><span>] intValue]] doNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x) {
</span><span>								</span><span style="color:#4271ae;">NSLog</span><span>(</span><span style="color:#839c00;">@&quot;这里只会执行一次&quot;</span><span>);
</span><span>							}];
</span><span>						}]
</span><span>						switchToLatest];
</span><span>
</span><span>[signal </span><span style="color:#4271ae;">subscribeNext:</span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">(HBPin </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">pin) {
</span><span style="color:#4271ae;">	NSLog(</span><span style="color:#839c00;">@&quot;pinID:</span><span>%d</span><span style="color:#839c00;">&quot;</span><span style="color:#4271ae;">, pin.</span><span style="color:#c82728;">pinID</span><span style="color:#4271ae;">);
</span><span style="color:#4271ae;">} completed:</span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">{
</span><span style="color:#4271ae;">	NSLog(</span><span style="color:#839c00;">@&quot;completed&quot;</span><span style="color:#4271ae;">);
</span><span style="color:#4271ae;">}</span><span>];
</span><span>
</span><span style="color:#8e908c;">// output
</span><span style="color:#8e908c;">// 2014-06-05 17:40:49.851 这里只会执行一次
</span><span style="color:#8e908c;">// 2014-06-05 17:40:49.851 pinID:172230707
</span><span style="color:#8e908c;">// 2014-06-05 17:40:49.851 completed
</span></code></pre>
<h4 id="takeuntil">takeUntil</h4>
<p><code>takeUntil:someSignal</code> 的作用是当 someSignal sendNext 时，当前的 signal 就<code>sendCompleted</code>，someSignal 就像一个拳击裁判，哨声响起就意味着比赛终止。</p>
<p>它的常用场景之一是处理 cell 的 button 的点击事件，比如点击 Cell 的详情按钮，需要 push 一个 VC，就可以这样：</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>[[[cell.</span><span style="color:#c82728;">detailButton
</span><span>	rac_signalForControlEvents</span><span style="color:#3e999f;">:</span><span>UIControlEventTouchUpInside]
</span><span>	takeUntil</span><span style="color:#3e999f;">:</span><span>cell.</span><span style="color:#c82728;">rac_prepareForReuseSignal</span><span>]
</span><span>	subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x) {
</span><span>		</span><span style="color:#8e908c;">// generate and push ViewController
</span><span>}];
</span></code></pre>
<p>如果不加<code>takeUntil:cell.rac_prepareForReuseSignal</code>，那么每次 Cell 被重用时，该 button 都会被<code>addTarget:selector</code>。</p>
<h4 id="ti-huan-delegate">替换 Delegate</h4>
<p>出现这种需求，通常是因为需要对 Delegate 的多个方法做统一的处理，这时就可以造一个 signal 出来，每次该 Delegate 的某些方法被触发时，该 signal 就会<code>sendNext</code>。</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">@implementation </span><span>UISearchDisplayController (RAC)
</span><span>- (RACSignal </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#4271ae;">rac_isActiveSignal </span><span>{
</span><span>    </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">delegate </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>;
</span><span>    RACSignal </span><span style="color:#3e999f;">*</span><span>signal </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">objc_getAssociatedObject</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, </span><span style="color:#c82728;">_cmd</span><span style="color:#4271ae;">)</span><span>;
</span><span>    </span><span style="color:#8959a8;">if </span><span>(signal </span><span style="color:#3e999f;">!= </span><span style="color:#f07219;">nil</span><span>) </span><span style="color:#8959a8;">return</span><span> signal;
</span><span>
</span><span>    </span><span style="color:#8e908c;">/* Create two signals and merge them */
</span><span>    RACSignal </span><span style="color:#3e999f;">*</span><span>didBeginEditing </span><span style="color:#3e999f;">= </span><span>[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">rac_signalForSelector:</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(searchDisplayControllerDidBeginSearch:)
</span><span style="color:#4271ae;">                                        fromProtocol:</span><span style="color:#8959a8;">@protocol</span><span style="color:#4271ae;">(UISearchDisplayDelegate)</span><span>] mapReplace</span><span style="color:#3e999f;">:</span><span>@</span><span style="color:#f07219;">YES</span><span>];
</span><span>    RACSignal </span><span style="color:#3e999f;">*</span><span>didEndEditing </span><span style="color:#3e999f;">= </span><span>[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">rac_signalForSelector:</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(searchDisplayControllerDidEndSearch:)
</span><span style="color:#4271ae;">                                      fromProtocol:</span><span style="color:#8959a8;">@protocol</span><span style="color:#4271ae;">(UISearchDisplayDelegate)</span><span>] mapReplace</span><span style="color:#3e999f;">:</span><span>@</span><span style="color:#f07219;">NO</span><span>];
</span><span>    signal </span><span style="color:#3e999f;">= </span><span>[RACSignal </span><span style="color:#4271ae;">merge:@[didBeginEditing, didEndEditing]</span><span>];
</span><span>
</span><span>
</span><span>    </span><span style="color:#c82728;">objc_setAssociatedObject</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, </span><span style="color:#c82728;">_cmd</span><span style="color:#4271ae;">, signal, OBJC_ASSOCIATION_RETAIN_NONATOMIC)</span><span>;
</span><span>    </span><span style="color:#8959a8;">return</span><span> signal;
</span><span>}
</span><span style="color:#8959a8;">@end
</span></code></pre>
<p>代码源于<a href="http://spin.atomicobject.com/2014/02/03/objective-c-delegate-pattern/">此文</a></p>
<h4 id="shi-yong-reactiveviewmodel-de-didbecomactivesignal">使用 ReactiveViewModel 的 didBecomActiveSignal</h4>
<p><a href="https://github.com/ReactiveCocoa/ReactiveViewModel">ReactiveViewModel</a>是另一个 project， 后面的 MVVM 中会讲到，通常的做法是在 VC 里设置 VM 的<code>active</code>属性(RVMViewModel 自带该属性)，然后在 VM 里 subscribeNext <code>didBecomActiveSignal</code>，比如当 Active 时，获取 TableView 的最新数据。</p>
<h4 id="racsubject-de-shi-yong-chang-jing">RACSubject 的使用场景</h4>
<p>一般不推荐使用<code>RACSubject</code>，因为它过于灵活，滥用的话容易导致复杂度的增加。但有一些场景用一下还是比较方便的，比如 ViewModel 的 errors。</p>
<p>ViewModel 一般会有多个<code>RACCommand</code>，那这些 commands 如果出现 error 了该如何处理呢？比较方便的方法如下：</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8e908c;">// HBCViewModel.h
</span><span>
</span><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&quot;RVMViewModel.h&quot;
</span><span>
</span><span style="color:#8959a8;">@class</span><span> RACSubject;
</span><span>
</span><span style="color:#8959a8;">@interface </span><span>HBCViewModel : </span><span style="color:#839c00;">RVMViewModel
</span><span style="color:#8959a8;">@property </span><span>(</span><span style="color:#8959a8;">nonatomic</span><span>) RACSubject </span><span style="color:#3e999f;">*</span><span>errors;
</span><span style="color:#8959a8;">@end
</span><span>
</span><span>
</span><span>
</span><span style="color:#8e908c;">// HBCViewModel.m
</span><span>
</span><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&quot;HBCViewModel.h&quot;
</span><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&lt;ReactiveCocoa.h&gt;
</span><span>
</span><span style="color:#8959a8;">@implementation </span><span>HBCViewModel
</span><span>
</span><span>- (instancetype)</span><span style="color:#4271ae;">init
</span><span>{
</span><span>    </span><span style="color:#c82728;">self </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">init</span><span>];
</span><span>    </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">self</span><span>) {
</span><span>        _errors </span><span style="color:#3e999f;">= </span><span>[RACSubject </span><span style="color:#4271ae;">subject</span><span>];
</span><span>    }
</span><span>    </span><span style="color:#8959a8;">return </span><span style="color:#c82728;">self</span><span>;
</span><span>}
</span><span>
</span><span>- (</span><span style="color:#8959a8;">void</span><span>)</span><span style="color:#4271ae;">dealloc
</span><span>{
</span><span>    [_errors </span><span style="color:#4271ae;">sendCompleted</span><span>];
</span><span>}
</span><span style="color:#8959a8;">@end
</span><span>
</span><span style="color:#8e908c;">// Some Other ViewModel inherit HBCViewModel
</span><span>
</span><span style="color:#3e999f;">- </span><span>(instancetype)init
</span><span>{
</span><span>	_fetchLatestCommand </span><span style="color:#3e999f;">= </span><span>[RACCommand </span><span style="color:#4271ae;">alloc</span><span>] initWithSignalBlock</span><span style="color:#3e999f;">:^</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>(</span><span style="color:#8959a8;">id </span><span>input){
</span><span>		</span><span style="color:#8e908c;">// fetch latest data
</span><span>	}];
</span><span>
</span><span>	_fetchMoreCommand </span><span style="color:#3e999f;">= </span><span>[RACCommand </span><span style="color:#4271ae;">alloc</span><span>] initWithSignalBlock</span><span style="color:#3e999f;">:^</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>(</span><span style="color:#8959a8;">id </span><span>input){
</span><span>		</span><span style="color:#8e908c;">// fetch more data
</span><span>	}];
</span><span>
</span><span>	[</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">didBecomeActiveSignal</span><span> subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x) {
</span><span>		[_fetchLatestCommand </span><span style="color:#4271ae;">execute:</span><span style="color:#f07219;">nil</span><span>];
</span><span>	}];
</span><span>
</span><span>	[[RACSignal
</span><span>		merge</span><span style="color:#3e999f;">:</span><span>@[
</span><span>				_fetchMoreCommand.</span><span style="color:#c82728;">errors</span><span>,
</span><span>				_fetchLatestCommand.</span><span style="color:#c82728;">errors
</span><span>				]] subscribe</span><span style="color:#3e999f;">:</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">errors</span><span>];
</span><span>
</span><span>}
</span></code></pre>
<h4 id="rac-signalforselector">rac_signalForSelector</h4>
<p><code>rac_signalForSelector:</code> 这个方法会返回一个 signal，当 selector 执行完时，会 sendNext，也就是当某个方法调用完后再额外做一些事情。用在 category 会比较方便，因为 Category 重写父类的方法时，不能再通过<code>[super XXX]</code>来调用父类的方法，当然也可以手写 Swizzle 来实现，不过有了<code>rac_signalForSelector:</code>就方便多了。</p>
<p><code>rac_signalForSelector: fromProtocol:</code> 可以直接实现对 protocol 的某个方法的实现（听着有点别扭呢），比如，我们想实现 UIScrollViewDelegate 的某些方法，可以这么写</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">rac_signalForSelector:</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(scrollViewDidEndDecelerating:) fromProtocol:</span><span style="color:#8959a8;">@protocol</span><span style="color:#4271ae;">(UIScrollViewDelegate)</span><span>] subscribeNext</span><span style="color:#3e999f;">:^</span><span>(RACTuple </span><span style="color:#3e999f;">*</span><span>tuple) {
</span><span>    </span><span style="color:#8e908c;">// do something
</span><span>}];
</span><span>
</span><span>[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">rac_signalForSelector:</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(scrollViewDidScroll:) fromProtocol:</span><span style="color:#8959a8;">@protocol</span><span style="color:#4271ae;">(UIScrollViewDelegate)</span><span>] subscribeNext</span><span style="color:#3e999f;">:^</span><span>(RACTuple </span><span style="color:#3e999f;">*</span><span>tuple) {
</span><span>	</span><span style="color:#8e908c;">// do something
</span><span>}];
</span><span>
</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">scrollView</span><span>.</span><span style="color:#c82728;">delegate </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">nil</span><span>;
</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">scrollView</span><span>.</span><span style="color:#c82728;">delegate </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>;
</span></code></pre>
<p>注意，这里的 delegate 需要先设置为 nil，再设置为 self，而不能直接设置为 self，如果 self 已经是该 scrollView 的 Delegate 的话。</p>
<p>有时，我们想对 selector 的返回值做一些处理，但很遗憾 RAC 不支持，如果真的有需要的话，可以使用<a href="https://github.com/steipete/Aspects">Aspects</a></p>
<h3 id="mvvm">MVVM</h3>
<p>这是一个大话题，如果有耐心，且英文还不错的话，可以看一下 Cocoa Samurai 的这<a href="http://cocoasamurai.blogspot.fr/2013/03/basic-mvvm-with-reactivecocoa.html">两篇</a><a href="http://cocoamanifest.net/articles/2013/10/mvc-mvvm-frp-and-building-bridges.html">文章</a>。PS: Facebook Paper 就是基于 MVVM 构建的。</p>
<p>MVVM 是 Model-View-ViewModel 的简称，它们之间的关系如下</p>
<p><img src="https://camo.githubusercontent.com/3999b9fdff783edb6cee9117a08524f3b2e7c653/68747470733a2f2f662e636c6f75642e6769746875622e636f6d2f6173736574732f3433323533362f3836373938342f32393165643338302d663736302d313165322d393130362d6433313538333230616633392e706e67" alt="" /></p>
<p>可以看到 View(其实是 ViewController)持有 ViewModel，这样做的好处是 ViewModel 更加独立且可测试，ViewModel 里不应包含任何 View 相关的元素，哪怕换了一个 View 也能正常工作。而且这样也能让 View/ViewController「瘦」下来。</p>
<p>ViewModel 主要做的事情是作为 View 的数据源，所以通常会包含网络请求。</p>
<p>或许你会疑惑，ViewController 哪去了？在 MVVM 的世界里，ViewController 已经成为了 View 的一部分。它的主要职责是将 VM 与 View 绑定、响应 VM 数据的变化、调用 VM 的某个方法、与其他的 VC 打交道。</p>
<p>而 RAC 为 MVVM 带来很大的便利，比如<code>RACCommand</code>, UIKit 的 RAC Extension 等等。使用 MVVM 不一定能减少代码量，但能降低代码的复杂度。</p>
<p>以下面这个需求为例，要求大图滑动结束时，底部的缩略图滚动到对应的位置，并高亮该缩略图；同时底部的缩略图被选中时，大图也要变成该缩略图的大图。</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-mvvm.png"
    srcset="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-mvvm.png 160w,&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-mvvm.png 160w"
    sizes="(max-width: 160px) 100vw, 160px" width="160" /></p>
<p>我的思路是横向滚动的大图是一个 collectionView，该 collectionView 是当前页面 VC 的一个 property。底部可以滑动的缩略图是一个 childVC 的 collectionView，这两个 collectionView 共用一套 VM，并且各自 RACObserve 感兴趣的 property。</p>
<p>比如大图滑到下一页时，会改变 VM 的 indexPath 属性，而底部的 collectionView 所在的 VC 正好对该 indexPath 感兴趣，只要 indexPath 变化就滚动到相应的 Item</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8e908c;">// childVC
</span><span>
</span><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)viewDidLoad
</span><span>{
</span><span>	[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">viewDidLoad</span><span>];
</span><span>
</span><span>	@</span><span style="color:#c82728;">weakify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>	[</span><span style="color:#c82728;">RACObserve</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, viewModel.</span><span style="color:#c82728;">indexPath</span><span style="color:#4271ae;">)</span><span> subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#c99e00;">NSNumber </span><span style="color:#3e999f;">*</span><span>index) {
</span><span>        @</span><span style="color:#c82728;">strongify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>        [</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">scrollToIndexPath</span><span>];
</span><span>    }];
</span><span>}
</span><span>
</span><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)scrollToIndexPath
</span><span>{
</span><span>    </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">collectionView</span><span>.</span><span style="color:#c82728;">subviews</span><span>.</span><span style="color:#c82728;">count</span><span>) {
</span><span>        </span><span style="color:#c99e00;">NSIndexPath </span><span style="color:#3e999f;">*</span><span>indexPath </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">viewModel</span><span>.</span><span style="color:#c82728;">indexPath</span><span>;
</span><span>        [</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">collectionView</span><span> scrollToItemAtIndexPath</span><span style="color:#3e999f;">:</span><span>indexPath atScrollPosition</span><span style="color:#3e999f;">:</span><span>UICollectionViewScrollPositionCenteredHorizontally animated</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">YES</span><span>];
</span><span>        [</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">collectionView</span><span>.</span><span style="color:#c82728;">subviews</span><span> enumerateObjectsUsingBlock</span><span style="color:#3e999f;">:^</span><span>(UIView </span><span style="color:#3e999f;">*</span><span>view, </span><span style="color:#c99e00;">NSUInteger</span><span> idx, </span><span style="color:#8959a8;">BOOL </span><span style="color:#3e999f;">*</span><span>stop) {
</span><span>            view.</span><span style="color:#c82728;">layer</span><span>.</span><span style="color:#c82728;">borderWidth </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span>;
</span><span>        }];
</span><span>        UIView </span><span style="color:#3e999f;">*</span><span>view </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">collectionView</span><span> cellForItemAtIndexPath</span><span style="color:#3e999f;">:</span><span>indexPath];
</span><span>        view.</span><span style="color:#c82728;">layer</span><span>.</span><span style="color:#c82728;">borderWidth </span><span style="color:#3e999f;">= </span><span>kHBPinsNaviThumbnailPadding;
</span><span>        view.</span><span style="color:#c82728;">layer</span><span>.</span><span style="color:#c82728;">borderColor </span><span style="color:#3e999f;">= </span><span>[UIColor </span><span style="color:#4271ae;">whiteColor</span><span>].</span><span style="color:#c82728;">CGColor</span><span>;
</span><span>    }
</span><span>}
</span></code></pre>
<p>当点击底部的缩略图时，上面的大图也要做出变化，也同样可以通过 RACObserve indexPath 来实现</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8e908c;">// PinsViewController.m
</span><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)viewDidLoad
</span><span>{
</span><span>	[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">viewDidLoad</span><span>];
</span><span>	@</span><span style="color:#c82728;">weakify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>    [[</span><span style="color:#c82728;">RACObserve</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, viewModel.</span><span style="color:#c82728;">indexPath</span><span style="color:#4271ae;">)
</span><span>        skip</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">1</span><span>]
</span><span>        subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#c99e00;">NSIndexPath </span><span style="color:#3e999f;">*</span><span>indexPath) {
</span><span>            @</span><span style="color:#c82728;">strongify</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">)</span><span>;
</span><span>            [</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">collectionView</span><span> scrollToItemAtIndexPath</span><span style="color:#3e999f;">:</span><span>indexPath atScrollPosition</span><span style="color:#3e999f;">:</span><span>UICollectionViewScrollPositionCenteredHorizontally animated</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">YES</span><span>];
</span><span>    }];
</span><span>}
</span></code></pre>
<p>这里有一个小技巧，当 Cell 里的元素比较复杂时，我们可以给 Cell 也准备一个 ViewModel，这个 CellViewModel 可以由上一层的 ViewModel 提供，这样 Cell 如果需要相应的数据，直接跟 CellViewModel 要即可，CellViewModel 也可以包含一些 command，比如 likeCommand。假如点击 Cell 时，要做一些处理，也很方便。</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8e908c;">// CellViewModel已经在ViewModel里准备好了
</span><span style="color:#3e999f;">- </span><span>(UICollectionViewCell </span><span style="color:#3e999f;">*</span><span>)collectionView</span><span style="color:#3e999f;">:</span><span>(UICollectionView </span><span style="color:#3e999f;">*</span><span>)collectionView cellForItemAtIndexPath</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSIndexPath </span><span style="color:#3e999f;">*</span><span>)indexPath
</span><span>{
</span><span>    HBPinsCell </span><span style="color:#3e999f;">*</span><span>cell </span><span style="color:#3e999f;">= </span><span>[collectionView </span><span style="color:#4271ae;">dequeueReusableCellWithReuseIdentifier:cellIdentifier forIndexPath:indexPath</span><span>];
</span><span>    cell.</span><span style="color:#c82728;">viewModel </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">viewModel</span><span>.</span><span style="color:#c82728;">cellViewModels</span><span>[indexPath.</span><span style="color:#c82728;">row</span><span>];
</span><span>    </span><span style="color:#8959a8;">return</span><span> cell;
</span><span>}
</span><span>
</span><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)collectionView</span><span style="color:#3e999f;">:</span><span>(UICollectionView </span><span style="color:#3e999f;">*</span><span>)collectionView didSelectItemAtIndexPath</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSIndexPath </span><span style="color:#3e999f;">*</span><span>)indexPath
</span><span>{
</span><span>    HBCellViewModel </span><span style="color:#3e999f;">*</span><span>cellViewModel </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">viewModel</span><span>.</span><span style="color:#c82728;">cellViewModels</span><span>[indexPath.</span><span style="color:#c82728;">row</span><span>];
</span><span>	</span><span style="color:#8e908c;">// 对cellViewModel执行某些操作，因为Cell已经与cellViewModel绑定，所以cellViewModel的改变也会反映到Cell上
</span><span>	</span><span style="color:#8e908c;">// 或拿到cellViewModel的数据来执行某些操作
</span><span>}
</span></code></pre>
<h4 id="viewmodel-zhong-signal-property-command-de-shi-yong">ViewModel 中 signal, property, command 的使用</h4>
<p>初次使用 RAC+MVVM 时，往往会疑惑，什么时候用 signal，什么时候用 property，什么时候用 command？</p>
<p>一般来说可以使用 property 的就直接使用，没必要再转换成 signal，外部 RACObserve 即可。使用 signal 的场景一般是涉及到多个 property 或多个 signal 合并为一个 signal。command 往往与 UIControl/网络请求挂钩。</p>
<h3 id="chang-jian-chang-jing-de-chu-li">常见场景的处理</h3>
<h4 id="jian-cha-ben-di-huan-cun-ru-guo-shi-xiao-ze-qu-qing-qiu-wang-luo-shu-ju-bing-huan-cun-dao-ben-di">检查本地缓存，如果失效则去请求网络数据并缓存到本地</h4>
<p><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/issues/1166">来源</a></p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(RACSignal </span><span style="color:#3e999f;">*</span><span>)loadData {
</span><span>    </span><span style="color:#8959a8;">return </span><span>[[RACSignal
</span><span>        createSignal</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id</span><span>&lt;RACSubscriber&gt; subscriber) {
</span><span>            </span><span style="color:#8e908c;">// If the cache is valid then we can just immediately send the
</span><span>            </span><span style="color:#8e908c;">// cached data and be done.
</span><span>            </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">cacheValid</span><span>) {
</span><span>                [subscriber </span><span style="color:#4271ae;">sendNext:</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">cachedData</span><span>];
</span><span>                [subscriber </span><span style="color:#4271ae;">sendCompleted</span><span>];
</span><span>            } </span><span style="color:#8959a8;">else </span><span>{
</span><span>                [subscriber </span><span style="color:#4271ae;">sendError:</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">staleCacheError</span><span>];
</span><span>            }
</span><span>        }]
</span><span>        </span><span style="color:#8e908c;">// Do the subscription work on some random scheduler, off the main
</span><span>        </span><span style="color:#8e908c;">// thread.
</span><span>        subscribeOn</span><span style="color:#3e999f;">:</span><span>[RACScheduler </span><span style="color:#4271ae;">scheduler</span><span>]];
</span><span>}
</span><span>
</span><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)update {
</span><span>    [[[[</span><span style="color:#c82728;">self
</span><span>        loadData]
</span><span>        </span><span style="color:#8e908c;">// Catch the error from -loadData. It means our cache is stale. Update
</span><span>        </span><span style="color:#8e908c;">// our cache and save it.
</span><span>        catch</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span>error) {
</span><span>            </span><span style="color:#8959a8;">return </span><span>[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">updateCachedData</span><span>] doNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>data) {
</span><span>                [</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">cacheData:data</span><span>];
</span><span>            }];
</span><span>        }]
</span><span>        </span><span style="color:#8e908c;">// Our work up until now has been on a background scheduler. Get our
</span><span>        </span><span style="color:#8e908c;">// results delivered on the main thread so we can do UI work.
</span><span>        deliverOn</span><span style="color:#3e999f;">:</span><span>RACScheduler.</span><span style="color:#c82728;">mainThreadScheduler</span><span>]
</span><span>        subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>data) {
</span><span>            </span><span style="color:#8e908c;">// Update your UI based on `data`.
</span><span>
</span><span>            </span><span style="color:#8e908c;">// Update again after `updateInterval` seconds have passed.
</span><span>            [[RACSignal </span><span style="color:#4271ae;">interval:updateInterval</span><span>] take</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">1</span><span>] subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>_) {
</span><span>                [</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">update</span><span>];
</span><span>            }];
</span><span>        }];
</span><span>}
</span></code></pre>
<h4 id="jian-ce-yong-hu-ming-shi-fou-ke-yong">检测用户名是否可用</h4>
<p><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/issues/1236">来源</a></p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)setupUsernameAvailabilityChecking {
</span><span>    </span><span style="color:#c82728;">RAC</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">, availabilityStatus) </span><span style="color:#3e999f;">= </span><span>[[[</span><span style="color:#c82728;">RACObserve</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">userTemplate</span><span style="color:#4271ae;">, username)
</span><span>                                      throttle</span><span style="color:#3e999f;">:</span><span>kUsernameCheckThrottleInterval] </span><span style="color:#8e908c;">//throttle表示interval时间内如果有sendNext，则放弃该nextValue
</span><span>                                      map</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>username) {
</span><span>                                          </span><span style="color:#8959a8;">if </span><span>(username.</span><span style="color:#c82728;">length </span><span style="color:#3e999f;">== </span><span style="color:#f07219;">0</span><span>) </span><span style="color:#8959a8;">return </span><span>[RACSignal </span><span style="color:#4271ae;">return:@(UsernameAvailabilityCheckStatusEmpty)</span><span>];
</span><span>                                          </span><span style="color:#8959a8;">return </span><span>[[[[[FIBAPIClient </span><span style="color:#4271ae;">sharedInstance</span><span>]
</span><span>                                                getUsernameAvailabilityFor</span><span style="color:#3e999f;">:</span><span>username ignoreCache</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">NO</span><span>]
</span><span>                                              map</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>result) {
</span><span>                                                  </span><span style="color:#c99e00;">NSNumber </span><span style="color:#3e999f;">*</span><span>existsNumber </span><span style="color:#3e999f;">=</span><span> result[</span><span style="color:#839c00;">@&quot;exists&quot;</span><span>];
</span><span>                                                  </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#3e999f;">!</span><span>existsNumber) </span><span style="color:#8959a8;">return</span><span> @(UsernameAvailabilityCheckStatusFailed);
</span><span>                                                  UsernameAvailabilityCheckStatus status </span><span style="color:#3e999f;">= </span><span>[existsNumber </span><span style="color:#4271ae;">boolValue</span><span>] </span><span style="color:#3e999f;">?</span><span> UsernameAvailabilityCheckStatusUnavailable </span><span style="color:#3e999f;">:</span><span> UsernameAvailabilityCheckStatusAvailable;
</span><span>                                                  </span><span style="color:#8959a8;">return</span><span> @(status);
</span><span>                                              }]
</span><span>                                             catch</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span>error) {
</span><span>                                                  </span><span style="color:#8959a8;">return </span><span>[RACSignal </span><span style="color:#4271ae;">return:@(UsernameAvailabilityCheckStatusFailed)</span><span>];
</span><span>                                              }] startWith</span><span style="color:#3e999f;">:</span><span>@(UsernameAvailabilityCheckStatusChecking)];
</span><span>                                      }]
</span><span>                                      switchToLatest];
</span><span>}
</span></code></pre>
<p>可以看到这里也使用了<code>map</code> + <code>switchToLatest</code>模式，这样就可以自动取消上一次的网络请求。</p>
<p><code>startWith</code>的内部实现是<code>concat</code>，这里表示先将状态置为 checking，然后再根据网络请求的结果设置状态。</p>
<h4 id="shi-yong-takeuntil-lai-chu-li-cell-de-button-dian-ji">使用 takeUntil:来处理 Cell 的 button 点击</h4>
<p>这个上面已经提到过了。</p>
<h4 id="token-guo-qi-hou-zi-dong-huo-qu-xin-de">token 过期后自动获取新的</h4>
<p>开发 APIClient 时，会用到 AccessToken，这个 Token 过一段时间会过期，需要去请求新的 Token。比较好的用户体验是当 token 过期后，自动去获取新的 Token，拿到后继续上一次的请求，这样对用户是透明的。</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>RACSignal </span><span style="color:#3e999f;">*</span><span>requestSignal </span><span style="color:#3e999f;">= </span><span>[RACSignal </span><span style="color:#4271ae;">createSignal:</span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">RACDisposable </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">(</span><span style="color:#8959a8;">id</span><span style="color:#4271ae;">&lt;RACSubscriber&gt; subscriber) {
</span><span style="color:#4271ae;">        </span><span style="color:#8e908c;">// suppose first time send request, access token is expired or invalid
</span><span style="color:#4271ae;">        </span><span style="color:#8e908c;">// and next time it is correct.
</span><span style="color:#4271ae;">        </span><span style="color:#8e908c;">// the block will be triggered twice.
</span><span style="color:#4271ae;">        </span><span style="color:#8959a8;">static BOOL</span><span style="color:#4271ae;"> isFirstTime </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">        </span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">url </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">@&quot;http://httpbin.org/ip&quot;</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">        </span><span style="color:#8959a8;">if </span><span style="color:#4271ae;">(</span><span style="color:#3e999f;">!</span><span style="color:#4271ae;">isFirstTime) {
</span><span style="color:#4271ae;">            url </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">@&quot;http://nonexists.com/error&quot;</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">            isFirstTime </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">1</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">        }
</span><span style="color:#4271ae;">        NSLog(</span><span style="color:#839c00;">@&quot;url:</span><span>%@</span><span style="color:#839c00;">&quot;</span><span style="color:#4271ae;">, url);
</span><span style="color:#4271ae;">        [[AFHTTPRequestOperationManager manager] GET</span><span style="color:#3e999f;">:</span><span style="color:#4271ae;">url parameters</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">nil</span><span style="color:#4271ae;"> success</span><span style="color:#3e999f;">:^</span><span style="color:#4271ae;">(AFHTTPRequestOperation </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">operation, </span><span style="color:#8959a8;">id </span><span style="color:#4271ae;">responseObject) {
</span><span style="color:#4271ae;">            [subscriber sendNext:responseObject];
</span><span style="color:#4271ae;">            [subscriber sendCompleted];
</span><span style="color:#4271ae;">        } failure</span><span style="color:#3e999f;">:^</span><span style="color:#4271ae;">(AFHTTPRequestOperation </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">operation, </span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">error) {
</span><span style="color:#4271ae;">            [subscriber sendError:error];
</span><span style="color:#4271ae;">        }];
</span><span style="color:#4271ae;">        </span><span style="color:#8959a8;">return </span><span style="color:#f07219;">nil</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">    }</span><span>];
</span><span>
</span><span>    self.</span><span style="color:#c82728;">statusLabel</span><span>.</span><span style="color:#c82728;">text </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">@&quot;sending request...&quot;</span><span>;
</span><span>    [[requestSignal </span><span style="color:#4271ae;">catch:</span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">RACSignal </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">(</span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">error) {
</span><span style="color:#4271ae;">        </span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">statusLabel</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">text </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">@&quot;oops, invalid access token&quot;</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">
</span><span style="color:#4271ae;">        </span><span style="color:#8e908c;">// simulate network request, and we fetch the right access token
</span><span style="color:#4271ae;">        </span><span style="color:#8959a8;">return </span><span style="color:#4271ae;">[[RACSignal createSignal:</span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">RACDisposable </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">(</span><span style="color:#8959a8;">id</span><span style="color:#4271ae;">&lt;RACSubscriber&gt; subscriber) {
</span><span style="color:#4271ae;">            </span><span style="color:#8959a8;">double</span><span style="color:#4271ae;"> delayInSeconds </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">1.0</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">            dispatch_time_t popTime </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">dispatch_time</span><span style="color:#4271ae;">(DISPATCH_TIME_NOW, (</span><span style="color:#c99e00;">int64_t</span><span style="color:#4271ae;">)(delayInSeconds </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;"> NSEC_PER_SEC));
</span><span style="color:#4271ae;">            </span><span style="color:#c82728;">dispatch_after</span><span style="color:#4271ae;">(popTime, </span><span style="color:#c82728;">dispatch_get_main_queue</span><span style="color:#4271ae;">(), </span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">(</span><span style="color:#8959a8;">void</span><span style="color:#4271ae;">){
</span><span style="color:#4271ae;">                [subscriber sendNext:@</span><span style="color:#f07219;">YES</span><span style="color:#4271ae;">];
</span><span style="color:#4271ae;">                [subscriber sendCompleted];
</span><span style="color:#4271ae;">            });
</span><span style="color:#4271ae;">            </span><span style="color:#8959a8;">return </span><span style="color:#f07219;">nil</span><span style="color:#4271ae;">;
</span><span style="color:#4271ae;">        }] concat</span><span style="color:#3e999f;">:</span><span style="color:#4271ae;">requestSignal];
</span><span style="color:#4271ae;">    }</span><span>] subscribeNext</span><span style="color:#3e999f;">:^</span><span>(</span><span style="color:#8959a8;">id </span><span>x) {
</span><span>        </span><span style="color:#8959a8;">if </span><span>([x </span><span style="color:#4271ae;">isKindOfClass:[</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#4271ae;">class]</span><span>]) {
</span><span>            </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">statusLabel</span><span>.</span><span style="color:#c82728;">text </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c99e00;">NSString </span><span style="color:#4271ae;">stringWithFormat:</span><span style="color:#839c00;">@&quot;result:</span><span>%@</span><span style="color:#839c00;">&quot;</span><span style="color:#4271ae;">, x[</span><span style="color:#839c00;">@&quot;origin&quot;</span><span style="color:#4271ae;">]</span><span>];
</span><span>        }
</span><span>    } completed</span><span style="color:#3e999f;">:^</span><span>{
</span><span>        </span><span style="color:#4271ae;">NSLog</span><span>(</span><span style="color:#839c00;">@&quot;completed&quot;</span><span>);
</span><span>    }];
</span></code></pre>
<h3 id="zhu-yi-shi-xiang">注意事项</h3>
<p>RAC 我自己感觉遇到的几个难点是: 1) 理解 RAC 的理念。 2) 熟悉常用的 API。3) 针对某些特定的场景，想出比较合理的 RAC 处理方式。不过看多了，写多了，想多了就会慢慢适应。下面是我在实践过程中遇到的一些小坑。</p>
<h4 id="reactivecocoalayout">ReactiveCocoaLayout</h4>
<p>有时 Cell 的内容涉及到动态的高度，就会想到用 Autolayout 来布局，但 RAC 已经为我们准备好了<a href="https://github.com/ReactiveCocoa/ReactiveCocoaLayout">ReactiveCocoaLayout</a>，所以我想不妨就拿来用一下。</p>
<p><code>ReactiveCocoaLayout</code>的使用好比「批地」和「盖房」，先通过<code>insetWidth:height:nullRect</code>从某个 View 中划出一小块，拿到之后还可以通过<code>divideWithAmount:padding:fromEdge</code> 再分成两块，或<code>sliceWithAmount:fromEdge</code>再分出一块。这些方法返回的都是 signal，所以可以通过<code>RAC(self.view, frame) = someRectSignal</code> 这样来实现绑定。但在实践中发现性能不是很好，多批了几块地就容易造成主线程卡顿。</p>
<p>所以<code>ReactiveCocoaLayout</code>最好不用或少用。</p>
<h4 id="diao-shi">调试</h4>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-debug.png"
    srcset="&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-debug.png 138w,&#x2F;posts&#x2F;deep-into-reactivecocoa2&#x2F;rac-debug.png 138w"
    sizes="(max-width: 138px) 100vw, 138px" width="138" /></p>
<p>刚开始写 RAC 时，往往会遇到这种情况，满屏的调用栈信息都是 RAC 的，要找出真正出现问题的地方不容易。曾经有一次在使用<code>[RACSignal combineLatest: reduce:^id{}]</code>时，忘了在 Block 里返回 value，而 Xcode 也没有提示 warning，然后就是莫名其妙地挂起了，跳到了汇编上，也没有调用栈信息，这时就只能通过最古老的注释代码的方式来找到问题的根源。</p>
<p>不过写多了之后，一般不太会犯这种低级错误。</p>
<h4 id="strongify-weakify-dance">strongify / weakify dance</h4>
<p>因为 RAC 很多操作都是在 Block 中完成的，这块最常见的问题就是在 block 直接把 self 拿来用，造成 block 和 self 的 retain cycle。所以需要通过<code>@strongify</code>和<code>@weakify</code>来消除循环引用。</p>
<p>有些地方很容易被忽略，比如<code>RACObserve(thing, keypath)</code>，看上去并没有引用 self，所以在<code>subscribeNext</code>时就忘记了 weakify/strongify。但事实上<code>RACObserve</code>总是会引用 self，即使 target 不是 self，所以只要有<code>RACObserve</code>的地方都要使用 weakify/strongify。</p>
<h3 id="xiao-jie">小结</h3>
<p>以上是我在做花瓣客户端和 side project 时总结的一些经验，但愿能带来一些帮助，有误的地方也欢迎指正和探讨。</p>
<p>推荐一下 jspahrsummers 的<a href="https://github.com/jspahrsummers/GroceryList">这个 project</a>，虽然是用 RAC3.0 写的，但很多理念也可以用到 RAC2 上面。</p>
<p>最后感谢 Github 的 iOS 工程师们，感谢你们带来了 RAC，以及在 Issues 里的耐心解答。</p>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/rac/">RAC</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // 都是为了 iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>