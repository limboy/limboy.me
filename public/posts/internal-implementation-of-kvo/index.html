<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <link rel="icon" href="https://fav.farm/ğŸ‘»" />
  <title>
(è¯‘)KVOçš„å†…éƒ¨å®ç°
</title>
  <link rel="stylesheet" href="/assets/main.css?gkCPK9ibGk2PIXzFp9c+CG7gIjpFY2pNyZ+E7aXMGlU=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/internal-implementation-of-kvo/">

<meta name="twitter:title" content="(è¯‘)KVOçš„å†…éƒ¨å®ç°">
<meta property="og:title" content="(è¯‘)KVOçš„å†…éƒ¨å®ç°">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center opacity-80 bg-black h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;internal-implementation-of-kvo&#x2F;">(è¯‘)KVOçš„å†…éƒ¨å®ç°</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2013-08-15</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <p>09 å¹´çš„<a href="http://www.mikeash.com/pyblog/friday-qa-2009-01-23.html">ä¸€ç¯‡æ–‡ç« </a>ï¼Œæ¯”è¾ƒæ·±å…¥åœ°é˜è¿°äº† KVO çš„å†…éƒ¨å®ç°ã€‚</p>
<p>KVO æ˜¯å®ç° Cocoa Bindings çš„åŸºç¡€ï¼Œå®ƒæä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå½“æŸä¸ªå±æ€§æ”¹å˜æ—¶ï¼Œç›¸åº”çš„ objects ä¼šè¢«é€šçŸ¥åˆ°ã€‚åœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œè¿™ç§è§‚å¯Ÿè€…æ¨¡å¼é€šå¸¸éœ€è¦å•ç‹¬å®ç°ï¼Œè€Œåœ¨ Objective-C ä¸­ï¼Œé€šå¸¸æ— é¡»å¢åŠ é¢å¤–ä»£ç å³å¯ä½¿ç”¨ã€‚</p>
<p>###æ¦‚è§ˆ
è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå…¶å®è¿™éƒ½æ˜¯é€šè¿‡ Objective-C å¼ºå¤§çš„è¿è¡Œæ—¶(runtime)å®ç°çš„ã€‚å½“ä½ ç¬¬ä¸€æ¬¡è§‚å¯ŸæŸä¸ª object æ—¶ï¼Œruntime ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç»§æ‰¿åŸå…ˆ class çš„ subclassã€‚åœ¨è¿™ä¸ªæ–°çš„ class ä¸­ï¼Œå®ƒé‡å†™äº†æ‰€æœ‰è¢«è§‚å¯Ÿçš„ keyï¼Œç„¶åå°† object çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘æ–°åˆ›å»ºçš„ classï¼ˆè¿™ä¸ªæŒ‡é’ˆå‘Šè¯‰ Objective-C è¿è¡Œæ—¶æŸä¸ª object åˆ°åº•æ˜¯å“ªç§ç±»å‹çš„ objectï¼‰ã€‚æ‰€ä»¥ object ç¥å¥‡åœ°å˜æˆäº†æ–°çš„å­ç±»çš„å®ä¾‹ã€‚</p>
<p>è¿™äº›è¢«é‡å†™çš„æ–¹æ³•å®ç°äº†å¦‚ä½•é€šçŸ¥è§‚å¯Ÿè€…ä»¬ã€‚å½“æ”¹å˜ä¸€ä¸ª key æ—¶ï¼Œä¼šè§¦å‘<code>setKey</code>æ–¹æ³•ï¼Œä½†è¿™ä¸ªæ–¹æ³•è¢«é‡å†™äº†ï¼Œå¹¶ä¸”åœ¨å†…éƒ¨æ·»åŠ äº†å‘é€é€šçŸ¥æœºåˆ¶ã€‚ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä¸èµ° setXXX æ–¹æ³•ï¼Œæ¯”å¦‚ç›´æ¥ä¿®æ”¹ iVarï¼Œä½†ä¸æ¨èè¿™ä¹ˆåšï¼‰ã€‚</p>
<p>æœ‰æ„æ€çš„æ˜¯ï¼šè‹¹æœä¸å¸Œæœ›è¿™ä¸ªæœºåˆ¶æš´éœ²åœ¨å¤–éƒ¨ã€‚é™¤äº† settersï¼Œè¿™ä¸ªåŠ¨æ€ç”Ÿæˆçš„å­ç±»åŒæ—¶ä¹Ÿé‡å†™äº†<code>-class</code>æ–¹æ³•ï¼Œä¾æ—§è¿”å›åŸå…ˆçš„ classï¼å¦‚æœä¸ä»”ç»†çœ‹çš„è¯ï¼Œè¢« KVO è¿‡çš„ object çœ‹èµ·æ¥å’ŒåŸå…ˆçš„ object æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚</p>
<p>###æ·±å…¥æ¢ç©¶
ä¸‹é¢æ¥çœ‹çœ‹è¿™äº›æ˜¯å¦‚ä½•å®ç°çš„ã€‚æˆ‘å†™äº†ä¸ªç¨‹åºæ¥æ¼”ç¤ºéšè—åœ¨ KVO èƒŒåçš„æœºåˆ¶ã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8e908c;">// gcc -o kvoexplorer -framework Foundation kvoexplorer.m
</span><span>
</span><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&lt;Foundation/Foundation.h&gt;
</span><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&lt;objc/runtime.h&gt;
</span><span>
</span><span style="color:#8959a8;">@interface </span><span>TestClass : </span><span style="color:#839c00;">NSObject
</span><span>{
</span><span style="color:#8959a8;">int</span><span> x;
</span><span style="color:#8959a8;">int</span><span> y;
</span><span style="color:#8959a8;">int</span><span> z;
</span><span>}
</span><span style="color:#8959a8;">@property int</span><span> x;
</span><span style="color:#8959a8;">@property int</span><span> y;
</span><span style="color:#8959a8;">@property int</span><span> z;
</span><span style="color:#8959a8;">@end
</span><span>
</span><span style="color:#8959a8;">@implementation </span><span>TestClass
</span><span style="color:#8959a8;">@synthesize</span><span> x, y, z;
</span><span style="color:#8959a8;">@end
</span><span>
</span><span style="color:#8959a8;">static </span><span style="color:#c99e00;">NSArray </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">ClassMethodNames</span><span>(</span><span style="color:#8959a8;">Class </span><span style="color:#f07219;">c</span><span>)
</span><span>{
</span><span style="color:#c99e00;">NSMutableArray </span><span style="color:#3e999f;">*</span><span>array </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c99e00;">NSMutableArray </span><span style="color:#4271ae;">array</span><span>];
</span><span style="color:#8959a8;">unsigned int</span><span> methodCount </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span>;
</span><span>Method \</span><span style="color:#3e999f;">*</span><span>methodList </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">class_copyMethodList</span><span style="color:#4271ae;">(c, </span><span style="color:#3e999f;">&amp;</span><span style="color:#4271ae;">methodCount)</span><span>;
</span><span style="color:#8959a8;">unsigned int</span><span> i;
</span><span style="color:#8959a8;">for</span><span>(i </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span>; i </span><span style="color:#3e999f;">&lt;</span><span> methodCount; i</span><span style="color:#3e999f;">++</span><span>)
</span><span>[array </span><span style="color:#4271ae;">addObject: NSStringFromSelector(</span><span style="color:#c82728;">method_getName</span><span style="color:#4271ae;">(methodList[i]))</span><span>];
</span><span style="color:#4271ae;">free(methodList)</span><span>;
</span><span style="color:#8959a8;">return</span><span> array;
</span><span>}
</span><span>
</span><span style="color:#8959a8;">static void </span><span style="color:#4271ae;">PrintDescription</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span style="color:#f07219;">name</span><span>, </span><span style="color:#8959a8;">id </span><span style="color:#f07219;">obj</span><span>)
</span><span>{
</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>str </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c99e00;">NSString </span><span style="color:#4271ae;">stringWithFormat:
</span><span style="color:#839c00;">@&quot;</span><span>%@</span><span style="color:#839c00;">: </span><span>%@</span><span style="color:#f07219;">\n\t</span><span style="color:#839c00;">NSObject class </span><span>%s</span><span style="color:#f07219;">\n\t</span><span style="color:#839c00;">libobjc class </span><span>%s</span><span style="color:#f07219;">\n\t</span><span style="color:#839c00;">implements methods &lt;</span><span>%@</span><span style="color:#839c00;">&gt;&quot;</span><span style="color:#4271ae;">,
</span><span style="color:#4271ae;">name,
</span><span style="color:#4271ae;">obj,
</span><span style="color:#c82728;">class_getName</span><span style="color:#4271ae;">([obj class]),
</span><span style="color:#c82728;">class_getName</span><span style="color:#4271ae;">(obj-&gt;isa),
</span><span style="color:#4271ae;">[</span><span style="color:#c82728;">ClassMethodNames</span><span style="color:#4271ae;">(obj-&gt;isa) componentsJoinedByString</span><span style="color:#3e999f;">:</span><span style="color:#839c00;">@&quot;, &quot;</span><span style="color:#4271ae;">]</span><span>];
</span><span style="color:#4271ae;">printf(</span><span style="color:#839c00;">&quot;</span><span>%s</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;</span><span style="color:#4271ae;">, [str UTF8String])</span><span>;
</span><span>}
</span><span>
</span><span style="color:#8959a8;">int </span><span style="color:#4271ae;">main</span><span>(</span><span style="color:#8959a8;">int </span><span style="color:#f07219;">argc</span><span>, </span><span style="color:#8959a8;">char</span><span> \</span><span style="color:#3e999f;">**</span><span style="color:#f07219;">argv</span><span>)
</span><span>{
</span><span>[</span><span style="color:#c99e00;">NSAutoreleasePool </span><span style="color:#4271ae;">new</span><span>];
</span><span>TestClass </span><span style="color:#3e999f;">*</span><span>x </span><span style="color:#3e999f;">= </span><span>[[TestClass </span><span style="color:#4271ae;">alloc</span><span>] init];
</span><span>TestClass </span><span style="color:#3e999f;">*</span><span>y </span><span style="color:#3e999f;">= </span><span>[[TestClass </span><span style="color:#4271ae;">alloc</span><span>] init];
</span><span>TestClass </span><span style="color:#3e999f;">*</span><span>xy </span><span style="color:#3e999f;">= </span><span>[[TestClass </span><span style="color:#4271ae;">alloc</span><span>] init];
</span><span>TestClass \</span><span style="color:#3e999f;">*</span><span>control </span><span style="color:#3e999f;">= </span><span>[[TestClass </span><span style="color:#4271ae;">alloc</span><span>] init];
</span><span>[x </span><span style="color:#4271ae;">addObserver:x forKeyPath:</span><span style="color:#839c00;">@&quot;x&quot; </span><span style="color:#4271ae;">options:</span><span style="color:#f07219;">0 </span><span style="color:#4271ae;">context:</span><span style="color:#f07219;">NULL</span><span>];
</span><span>[xy </span><span style="color:#4271ae;">addObserver:xy forKeyPath:</span><span style="color:#839c00;">@&quot;x&quot; </span><span style="color:#4271ae;">options:</span><span style="color:#f07219;">0 </span><span style="color:#4271ae;">context:</span><span style="color:#f07219;">NULL</span><span>];
</span><span>[y </span><span style="color:#4271ae;">addObserver:y forKeyPath:</span><span style="color:#839c00;">@&quot;y&quot; </span><span style="color:#4271ae;">options:</span><span style="color:#f07219;">0 </span><span style="color:#4271ae;">context:</span><span style="color:#f07219;">NULL</span><span>];
</span><span>[xy </span><span style="color:#4271ae;">addObserver:xy forKeyPath:</span><span style="color:#839c00;">@&quot;y&quot; </span><span style="color:#4271ae;">options:</span><span style="color:#f07219;">0 </span><span style="color:#4271ae;">context:</span><span style="color:#f07219;">NULL</span><span>];
</span><span style="color:#c82728;">PrintDescription</span><span style="color:#4271ae;">(</span><span style="color:#839c00;">@&quot;control&quot;</span><span style="color:#4271ae;">, control)</span><span>;
</span><span style="color:#c82728;">PrintDescription</span><span style="color:#4271ae;">(</span><span style="color:#839c00;">@&quot;x&quot;</span><span style="color:#4271ae;">, x)</span><span>;
</span><span style="color:#c82728;">PrintDescription</span><span style="color:#4271ae;">(</span><span style="color:#839c00;">@&quot;y&quot;</span><span style="color:#4271ae;">, y)</span><span>;
</span><span style="color:#c82728;">PrintDescription</span><span style="color:#4271ae;">(</span><span style="color:#839c00;">@&quot;xy&quot;</span><span style="color:#4271ae;">, xy)</span><span>;
</span><span style="color:#4271ae;">printf(</span><span style="color:#839c00;">&quot;Using NSObject methods, normal setX: is </span><span>%p</span><span style="color:#839c00;">, overridden setX: is </span><span>%p</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;</span><span style="color:#4271ae;">,
</span><span style="color:#4271ae;">[control methodForSelector:</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(setX:)],
</span><span style="color:#4271ae;">[x methodForSelector:</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(setX:)])</span><span>;
</span><span style="color:#4271ae;">printf(</span><span style="color:#839c00;">&quot;Using libobjc functions, normal setX: is </span><span>%p</span><span style="color:#839c00;">, overridden setX: is </span><span>%p</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;</span><span style="color:#4271ae;">,
</span><span style="color:#c82728;">method_getImplementation</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">class_getInstanceMethod</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">object_getClass</span><span style="color:#4271ae;">(control),
</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(setX:))),
</span><span style="color:#c82728;">method_getImplementation</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">class_getInstanceMethod</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">object_getClass</span><span style="color:#4271ae;">(x),
</span><span style="color:#8959a8;">@selector</span><span style="color:#4271ae;">(setX:))))</span><span>;
</span><span style="color:#8959a8;">return </span><span style="color:#f07219;">0</span><span>;
</span><span>}
</span></code></pre>
<p>æˆ‘ä»¬ä»å¤´åˆ°å°¾ç»†ç»†çœ‹æ¥ã€‚</p>
<p>é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code>TestClass</code>çš„ç±»ï¼Œå®ƒæœ‰ 3 ä¸ªå±æ€§ã€‚</p>
<p>ç„¶åå®šä¹‰äº†ä¸€äº›æ–¹ä¾¿è°ƒè¯•çš„æ–¹æ³•ã€‚<code>ClassMethodNames</code>ä½¿ç”¨ Objective-C è¿è¡Œæ—¶æ–¹æ³•æ¥éå†ä¸€ä¸ª classï¼Œå¾—åˆ°æ–¹æ³•åˆ—è¡¨ã€‚æ³¨æ„ï¼Œè¿™äº›æ–¹æ³•ä¸åŒ…æ‹¬çˆ¶ç±»çš„æ–¹æ³•ã€‚<code>PrintDescription</code>æ‰“å° object çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ class ä¿¡æ¯ï¼ˆåŒ…æ‹¬<code>-class</code>å’Œé€šè¿‡è¿è¡Œæ—¶å¾—åˆ°çš„ classï¼‰ï¼Œä»¥åŠè¿™ä¸ª class å®ç°çš„æ–¹æ³•ã€‚</p>
<p>ç„¶ååˆ›å»ºäº† 4 ä¸ª<code>TestClass</code>å®ä¾‹ï¼Œæ¯ä¸€ä¸ªéƒ½ä½¿ç”¨äº†ä¸åŒçš„è§‚å¯Ÿæ–¹å¼ã€‚<code>x</code>å®ä¾‹æœ‰ä¸€ä¸ªè§‚å¯Ÿè€…è§‚å¯Ÿ<code>x</code>keyï¼Œ<code>y</code>, <code>xy</code>ä¹Ÿç±»ä¼¼ã€‚ä¸ºäº†åšæ¯”è¾ƒï¼Œ<code>z</code>key æ²¡æœ‰è§‚å¯Ÿè€…ã€‚æœ€å<code>control</code>å®ä¾‹æ²¡æœ‰ä»»ä½•è§‚å¯Ÿè€…ã€‚</p>
<p>ç„¶åæ‰“å°å‡º 4 ä¸ª objects çš„ descriptionã€‚</p>
<p>ä¹‹åç»§ç»­æ‰“å°è¢«é‡å†™çš„ setter å†…å­˜åœ°å€ï¼Œä»¥åŠæœªè¢«é‡å†™çš„ setter çš„å†…å­˜åœ°å€åšæ¯”è¾ƒã€‚è¿™é‡Œåšäº†ä¸¤æ¬¡ï¼Œæ˜¯å› ä¸º<code>-methodForSelector:</code>æ²¡èƒ½å¾—åˆ°é‡å†™çš„æ–¹æ³•ã€‚KVO è¯•å›¾æ©ç›–å®ƒå®é™…ä¸Šåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ subclass è¿™ä¸ªäº‹å®ï¼ä½†æ˜¯ä½¿ç”¨è¿è¡Œæ—¶çš„æ–¹æ³•å°±åŸå½¢æ¯•éœ²äº†ã€‚</p>
<p>###è¿è¡Œä»£ç 
çœ‹çœ‹è¿™æ®µä»£ç çš„è¾“å‡º</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>control</span><span style="color:#3e999f;">: &lt;</span><span>TestClass</span><span style="color:#3e999f;">: </span><span style="color:#f07219;">0x104b20</span><span style="color:#3e999f;">&gt;
</span><span style="color:#c99e00;">NSObject</span><span> class TestClass
</span><span>libobjc class </span><span style="color:#4271ae;">TestClass
</span><span>implements methods </span><span style="color:#3e999f;">&lt;</span><span>setX</span><span style="color:#3e999f;">:</span><span>, x, setY</span><span style="color:#3e999f;">:</span><span>, y, setZ</span><span style="color:#3e999f;">:</span><span>, z</span><span style="color:#3e999f;">&gt;
</span><span>x</span><span style="color:#3e999f;">: &lt;</span><span>TestClass</span><span style="color:#3e999f;">: </span><span style="color:#f07219;">0x103280</span><span style="color:#3e999f;">&gt;
</span><span style="color:#c99e00;">NSObject</span><span> class TestClass
</span><span>libobjc class NSKVONotifying_TestClass
</span><span>implements methods </span><span style="color:#3e999f;">&lt;</span><span>setY</span><span style="color:#3e999f;">:</span><span>, setX</span><span style="color:#3e999f;">:</span><span>, class, dealloc, \_isKVOA</span><span style="color:#3e999f;">&gt;
</span><span>y</span><span style="color:#3e999f;">: &lt;</span><span>TestClass</span><span style="color:#3e999f;">: </span><span style="color:#f07219;">0x104b00</span><span style="color:#3e999f;">&gt;
</span><span style="color:#c99e00;">NSObject</span><span> class TestClass
</span><span>libobjc class NSKVONotifying_TestClass
</span><span>implements methods </span><span style="color:#3e999f;">&lt;</span><span>setY</span><span style="color:#3e999f;">:</span><span>, setX</span><span style="color:#3e999f;">:</span><span>, class, dealloc, \_isKVOA</span><span style="color:#3e999f;">&gt;
</span><span>xy</span><span style="color:#3e999f;">: &lt;</span><span>TestClass</span><span style="color:#3e999f;">: </span><span style="color:#f07219;">0x104b10</span><span style="color:#3e999f;">&gt;
</span><span style="color:#c99e00;">NSObject</span><span> class TestClass
</span><span>libobjc class NSKVONotifying_TestClass
</span><span>implements methods </span><span style="color:#3e999f;">&lt;</span><span>setY</span><span style="color:#3e999f;">:</span><span>, setX</span><span style="color:#3e999f;">:</span><span>, class, dealloc, \_isKVOA</span><span style="color:#3e999f;">&gt;
</span><span>Using </span><span style="color:#c99e00;">NSObject</span><span> methods, normal setX</span><span style="color:#3e999f;">:</span><span> is </span><span style="color:#f07219;">0x195e</span><span>, overridden setX</span><span style="color:#3e999f;">:</span><span> is </span><span style="color:#f07219;">0x195e
</span><span>Using libobjc functions, normal setX</span><span style="color:#3e999f;">:</span><span> is </span><span style="color:#f07219;">0x195e</span><span>, overridden setX</span><span style="color:#3e999f;">:</span><span> is </span><span style="color:#f07219;">0x96a1a550
</span></code></pre>
<p>é¦–å…ˆï¼Œå®ƒè¾“å‡ºäº†<code>control</code>objectï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå®ƒçš„ class æ˜¯<code>TestClass</code>ï¼Œå¹¶ä¸”å®ç°äº† 6 ä¸ª set/get æ–¹æ³•ã€‚</p>
<p>ç„¶åæ˜¯ 3 ä¸ªè¢«è§‚å¯Ÿçš„ objectsã€‚æ³¨æ„<code>-class</code>ä»ç„¶æ˜¾ç¤ºçš„æ˜¯<code>TestClass</code>ï¼Œä½¿ç”¨<code>object_getClass</code>æ˜¾ç¤ºäº†è¿™ä¸ª object çš„çœŸé¢ç›®ï¼šå®ƒæ˜¯<code>NSKVONotifying_TestClass</code>çš„ä¸€ä¸ªå®ä¾‹ã€‚è¿™ä¸ª<code>NSKVONotifying_TestClass</code>å°±æ˜¯åŠ¨æ€ç”Ÿæˆçš„ subclassï¼</p>
<p>æ³¨æ„ï¼Œå®ƒæ˜¯å¦‚ä½•å®ç°è¿™ä¸¤ä¸ªè¢«è§‚å¯Ÿçš„ setters çš„ã€‚ä½ ä¼šå‘ç°ï¼Œå®ƒå¾ˆèªæ˜ï¼Œæ²¡æœ‰é‡å†™<code>-setZ:</code>ï¼Œè™½ç„¶å®ƒä¹Ÿæ˜¯ä¸ª setterï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«è§‚å¯Ÿã€‚åŒæ—¶æ³¨æ„åˆ°ï¼Œ3 ä¸ªå®ä¾‹å¯¹åº”çš„æ˜¯åŒä¸€ä¸ª classï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤ä¸ª setters éƒ½è¢«é‡å†™äº†ï¼Œå°½ç®¡å…¶ä¸­çš„ä¸¤ä¸ªå®ä¾‹åªè§‚å¯Ÿäº†ä¸€ä¸ªå±æ€§ã€‚è¿™ä¼šå¸¦æ¥ä¸€ç‚¹æ•ˆç‡ä¸Šçš„é—®é¢˜ï¼Œå› ä¸ºå³ä½¿æ²¡æœ‰è¢«è§‚å¯Ÿçš„ property ä¹Ÿä¼šèµ°è¢«é‡å†™çš„ setterï¼Œä½†è‹¹æœæ˜¾ç„¶è§‰å¾—è¿™æ¯”åˆ†å¼€ç”ŸæˆåŠ¨æ€çš„ subclass æ›´å¥½ï¼Œæˆ‘ä¹Ÿè§‰å¾—è¿™æ˜¯ä¸ªæ­£ç¡®çš„é€‰æ‹©ã€‚</p>
<p>ä½ ä¼šçœ‹åˆ° 3 ä¸ªå…¶ä»–çš„æ–¹æ³•ã€‚æœ‰ä¹‹å‰æåˆ°è¿‡çš„è¢«é‡å†™çš„<code>-class</code>æ–¹æ³•ï¼Œå‡è£…è‡ªå·±è¿˜æ˜¯åŸæ¥çš„ classã€‚è¿˜æœ‰<code>-dealloc</code>æ–¹æ³•å¤„ç†ä¸€äº›æ”¶å°¾å·¥ä½œã€‚è¿˜æœ‰ä¸€ä¸ª<code>_isKVOA</code>æ–¹æ³•ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¾“å‡º<code>-setX:</code>çš„å®ç°ã€‚ä½¿ç”¨<code>-methodForSelector:</code>è¿”å›çš„æ˜¯ç›¸åŒçš„å€¼ã€‚å› ä¸º<code>-setX:</code>å·²ç»åœ¨å­ç±»è¢«é‡å†™äº†ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€<code>methodForSelector:</code>åœ¨å†…éƒ¨å®ç°ä¸­ä½¿ç”¨äº†<code>-class</code>ï¼Œäºæ˜¯å¾—åˆ°äº†é”™è¯¯çš„ç»“æœã€‚</p>
<p>æœ€åæˆ‘ä»¬é€šè¿‡è¿è¡Œæ—¶å¾—åˆ°äº†ä¸åŒçš„è¾“å‡ºç»“æœã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªä¼˜ç§€çš„æ¢ç´¢è€…ï¼Œæˆ‘ä»¬è¿›å…¥ debugger æ¥çœ‹çœ‹è¿™ç¬¬äºŒä¸ªæ–¹æ³•çš„å®ç°åˆ°åº•æ˜¯æ€æ ·çš„ï¼š</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>(gdb) </span><span style="color:#c82728;">print </span><span style="color:#4271ae;">(</span><span style="color:#8959a8;">IMP</span><span style="color:#4271ae;">)</span><span style="color:#f07219;">0x96a1a550
</span><span>$</span><span style="color:#f07219;">1 </span><span style="color:#3e999f;">= </span><span>(</span><span style="color:#8959a8;">IMP</span><span>) </span><span style="color:#f07219;">0x96a1a550 </span><span style="color:#3e999f;">&lt;</span><span>\_NSSetIntValueAndNotify</span><span style="color:#3e999f;">&gt;
</span></code></pre>
<p>çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ï¼Œå¯¹<code>Foundation</code>ä½¿ç”¨<code>nm -a</code>å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„ç§æœ‰æ–¹æ³•åˆ—è¡¨ï¼š</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#f07219;">0013</span><span style="font-style:italic;color:#c82829;">df80</span><span> t __NSSetBoolValueAndNotify
</span><span style="color:#f07219;">000</span><span style="font-style:italic;color:#c82829;">a0480</span><span> t __NSSetCharValueAndNotify
</span><span style="color:#f07219;">0013e120</span><span> t __NSSetDoubleValueAndNotify
</span><span style="color:#f07219;">0013e1</span><span style="font-style:italic;color:#c82829;">f0</span><span> t __NSSetFloatValueAndNotify
</span><span style="color:#f07219;">000e3550</span><span> t __NSSetIntValueAndNotify
</span><span style="color:#f07219;">0013e390</span><span> t __NSSetLongLongValueAndNotify
</span><span style="color:#f07219;">0013e2</span><span style="font-style:italic;color:#c82829;">c0</span><span> t __NSSetLongValueAndNotify
</span><span style="color:#f07219;">000</span><span style="font-style:italic;color:#c82829;">89df0</span><span> t __NSSetObjectValueAndNotify
</span><span style="color:#f07219;">0013e6</span><span style="font-style:italic;color:#c82829;">f0</span><span> t __NSSetPointValueAndNotify
</span><span style="color:#f07219;">0013e7</span><span style="font-style:italic;color:#c82829;">d0</span><span> t __NSSetRangeValueAndNotify
</span><span style="color:#f07219;">0013e8</span><span style="font-style:italic;color:#c82829;">b0</span><span> t __NSSetRectValueAndNotify
</span><span style="color:#f07219;">0013e550</span><span> t __NSSetShortValueAndNotify
</span><span style="color:#f07219;">000</span><span style="font-style:italic;color:#c82829;">8ab20</span><span> t __NSSetSizeValueAndNotify
</span><span style="color:#f07219;">0013e050</span><span> t __NSSetUnsignedCharValueAndNotify
</span><span style="color:#f07219;">000</span><span style="font-style:italic;color:#c82829;">9fcd0</span><span> t __NSSetUnsignedIntValueAndNotify
</span><span style="color:#f07219;">0013e470</span><span> t __NSSetUnsignedLongLongValueAndNotify
</span><span style="color:#f07219;">000</span><span style="font-style:italic;color:#c82829;">9fc00</span><span> t __NSSetUnsignedLongValueAndNotify
</span><span style="color:#f07219;">0013e620</span><span> t __NSSetUnsignedShortValueAndNotify
</span></code></pre>
<p>è¿™ä¸ªåˆ—è¡¨ä¹Ÿèƒ½å‘ç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ã€‚æ¯”å¦‚è‹¹æœä¸ºæ¯ä¸€ç§ primitive type éƒ½å†™äº†å¯¹åº”çš„å®ç°ã€‚Objective-C çš„ object ä¼šç”¨åˆ°çš„å…¶å®åªæœ‰<code>__NSSetObjectValueAndNotify</code>ï¼Œä½†éœ€è¦ä¸€æ•´å¥—æ¥å¯¹åº”å‰©ä¸‹çš„ï¼Œè€Œä¸”çœ‹èµ·æ¥ä¹Ÿæ²¡æœ‰å®ç°å®Œå…¨ï¼Œæ¯”å¦‚<code>long dobule</code>æˆ–<code>_Bool</code>éƒ½æ²¡æœ‰ã€‚ç”šè‡³æ²¡æœ‰ä¸ºé€šç”¨æŒ‡é’ˆç±»å‹(generic pointer type)æä¾›æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œä¸åœ¨è¿™ä¸ªæ–¹æ³•åˆ—è¡¨é‡Œçš„å±æ€§å…¶å®æ˜¯ä¸æ”¯æŒ KVO çš„ã€‚</p>
<p>KVO æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„å·¥å…·ï¼Œæœ‰æ—¶å€™è¿‡äºå¼ºå¤§äº†ï¼Œå°¤å…¶æ˜¯æœ‰äº†è‡ªåŠ¨è§¦å‘é€šçŸ¥æœºåˆ¶ã€‚ç°åœ¨ä½ çŸ¥é“å®ƒå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„äº†ï¼Œè¿™äº›çŸ¥è¯†æˆ–è®¸èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ä½¿ç”¨å®ƒï¼Œæˆ–åœ¨å®ƒå‡ºé”™æ—¶æ›´æ–¹ä¾¿è°ƒè¯•ã€‚</p>
<p>å¦‚æœä½ æ‰“ç®—ä½¿ç”¨ KVOï¼Œæˆ–è®¸å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« <a href="http://www.mikeash.com/?page=pyblog/key-value-observing-done-right.html">Key-Value Observing Done Right</a></p>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/ios/">iOS</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/translation/">translation</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // éƒ½æ˜¯ä¸ºäº† iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>