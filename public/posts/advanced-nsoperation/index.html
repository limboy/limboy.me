<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <link rel="icon" href="https://fav.farm/ğŸ‘»" />
  <title>
Advanced NSOperation
</title>
  <link rel="stylesheet" href="/assets/main.css?gkCPK9ibGk2PIXzFp9c+CG7gIjpFY2pNyZ+E7aXMGlU=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/advanced-nsoperation/">

<meta name="twitter:title" content="Advanced NSOperation">
<meta property="og:title" content="Advanced NSOperation">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center opacity-80 bg-black h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;advanced-nsoperation&#x2F;">Advanced NSOperation</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2015-08-08</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <h3 id="qian-yan">å‰è¨€</h3>
<p>è¿™ç¯‡æ–‡ç« æ˜¯å¯¹ <a href="https://developer.apple.com/videos/wwdc/2015/?id=226">WWDC 2015 Session 226: Advanced NSOperations</a> çš„ä¸€ä¸ªå°ç»“ï¼Œåœ¨é‚£ä¸ªè§†é¢‘ä¸­ï¼Œ<a href="https://twitter.com/davedelong">Dave DeLong</a> åˆ†äº«äº† NSOperation çš„é«˜çº§ç©æ³•ï¼ŒWWDC App å°±æ˜¯åŸºäºè¿™å¥—ç©æ³•åšçš„ï¼Œè¿˜æ˜¯æŒºå¼€é˜”æ€è·¯çš„ã€‚</p>
<h3 id="nsoperation-he-nsoperationqueue-jian-jie">NSOperation å’Œ NSOperationQueue ç®€ä»‹</h3>
<p>æˆ‘ä»¬çŸ¥é“ NSOperation å¯ä»¥æ‰§è¡Œä¸€äº›åå°æ“ä½œï¼Œå¦‚ HTTP è¯·æ±‚ï¼Œåœ¨ iOS 4.0 ä¹‹å‰æ˜¯åŸºäº NSThread æ¥å®ç°çš„ï¼ŒiOS 4.0 å¸¦äº† GCDï¼ŒNSOperation åº•å±‚ä¹ŸåŸºäº GCD é‡å†™äº†åº•å±‚å®ç°ã€‚</p>
<p>æ‰€ä»¥ NSOperation æ˜¯ GCD çš„é«˜å±‚å°è£…ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€äº›æ›´åŠ ä¾¿åˆ©çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å–æ¶ˆä»»åŠ¡ï¼Œè®¾ç½®ä¾èµ–ç­‰ã€‚åœ¨è¿›å…¥é«˜çº§ç©æ³•å‰ï¼Œå…ˆç®€å•çš„ä»‹ç»ä¸‹ NSOperation å’Œ NSOperationQueueã€‚</p>
<h4 id="nsoperationqueue-maxconcurrentoperationcount">NSOperationQueue maxConcurrentOperationCount</h4>
<p>è¿™ä¸ªå±æ€§è¡¨ç¤ºçš„æ˜¯ NSOperationQueue æœ€å¤šå¯ä»¥åŒæ—¶å¤„ç†å‡ ä¸ªä»»åŠ¡ï¼Œå‡å¦‚æˆ‘ä»¬å¸Œæœ›å®ƒä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯çº¿æ€§ Queueï¼Œå¯ä»¥è®¾ç½® <code>maxConcurrentOperationCount = 1</code></p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;advanced-nsoperation&#x2F;nsoperation-1.png"
        width="674" /></p>
<p>ä¸­é—´çš„ç‚¹è¡¨ç¤ºä»»åŠ¡çš„çŠ¶æ€ï¼Œåœ¨ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆå‰ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ª workerã€‚</p>
<p>å¦‚æœå¸Œæœ›ä¸€æ¬¡èƒ½å¤„ç†å¤šä¸ªï¼Œå°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºå¤§äº 1 å³å¯ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¾ç½®ä¸€ä¸ªåˆç†çš„æœ€å¤§å€¼ã€‚</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;advanced-nsoperation&#x2F;nsoperation-2.png"
        width="674" /></p><h4 id="nsoperation-cancel">NSOperation cancel</h4>
<p>ä»ä¸Šé¢çš„å›¾å¯ä»¥çœ‹åˆ°ï¼Œæ­£åœ¨è¢«æ‰§è¡Œçš„ä»»åŠ¡çš„çŠ¶æ€è·Ÿåœ¨åé¢æ’é˜Ÿçš„çŠ¶æ€æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ‰è¿™ä¹ˆå‡ ç§çŠ¶æ€ï¼špending, ready, executing, finished, cancelledã€‚</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;advanced-nsoperation&#x2F;nsoperation-3.png"
        width="297" /></p>
<p>ä¹‹å‰æåˆ°è¿‡ NSOperation ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§æ˜¯å¯ä»¥è¢«å–æ¶ˆï¼Œä½†ä¸åŒçŠ¶æ€çš„å–æ¶ˆå¤„ç†ä¹Ÿä¸ä¸€æ ·ã€‚æ¯”å¦‚å½“ Operation å¤„äº pending, ready çŠ¶æ€æ—¶ï¼Œç³»ç»Ÿå¯ä»¥å»çœ‹ä¸€ä¸‹è¿™ä¸ª Operation æ˜¯å¦å·²ç»è¢«å–æ¶ˆäº†(åˆ¤æ–­ self.cancelled)ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸æ‰§è¡Œä»»åŠ¡äº†ã€‚ä½†æ˜¯å½“ Operation å¤„äº executing çŠ¶æ€æ—¶ï¼Œå–æ¶ˆçš„æ“ä½œå°±åªèƒ½è‡ªå·±å¤„ç†äº†ï¼Œæ¯”å¦‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">@implementation </span><span>MyOperation: </span><span style="color:#839c00;">NSOperation
</span><span>- (</span><span style="color:#8959a8;">void</span><span>)</span><span style="color:#4271ae;">main
</span><span>{
</span><span>    </span><span style="color:#8e908c;">// ...
</span><span>    </span><span style="color:#8959a8;">while </span><span>(</span><span style="color:#3e999f;">!</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">cancelled</span><span>) {
</span><span>        </span><span style="color:#8e908c;">// executing
</span><span>    }
</span><span>}
</span><span style="color:#8959a8;">@end
</span></code></pre>
<h4 id="nsoperation-dependency">NSOperation dependency</h4>
<p>NSOperation è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§æ˜¯å¯ä»¥è®¾ç½®ä¾èµ–</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;advanced-nsoperation&#x2F;nsoperation-4.png"
        width="301" /></p>
<p>ä»»åŠ¡ A éœ€è¦ç­‰å¾… ä»»åŠ¡ B å’Œ ä»»åŠ¡ C å®Œæˆï¼Œæ‰èƒ½è¢«æ‰§è¡Œï¼Œè€Œä»»åŠ¡ B éœ€è¦ç­‰åˆ° ä»»åŠ¡ D å®Œæˆæ‰èƒ½è¢«æ‰§è¡Œã€‚</p>
<p>å½“ç„¶å‰ææ˜¯è¿™äº› Operation éƒ½éœ€è¦è¢«æ”¾åˆ°æŸä¸ª Queue é‡Œï¼Œè¿™æ ·å®ƒä»¬çš„çŠ¶æ€æ‰ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
<h3 id="gao-ji-wan-fa">é«˜çº§ç©æ³•</h3>
<p>å¼€å‘ App çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€äº›é€»è¾‘æ˜¯å¯ä»¥å…±ç”¨çš„ï¼Œæ¯”å¦‚ç™»å½•ã€ç½‘ç»œçŠ¶å†µç­‰ï¼Œæœ€å¥½å¯ä»¥ç»„è£…èµ·æ¥ï¼Œå°±åƒè¶…èƒ½é™†æˆ˜é˜Ÿé‡Œçš„ megabot ä¸€æ ·</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;advanced-nsoperation&#x2F;megabot.jpg"
        width="480" /></p>
<p>åŸºäºå‰é¢æåˆ°çš„ NSOperation / NSOperationQueue çš„ä¸€äº›ç‰¹ç‚¹ï¼Œè‹¹æœçš„å·¥ç¨‹å¸ˆä»¬æƒ³åˆ°äº†ä»–ä»¬çš„è§£å†³æ–¹æ³•ã€‚</p>
<h4 id="condition">Condition</h4>
<p>Conditionï¼Œä¹Ÿå°±æ˜¯æ¡ä»¶ï¼Œå®ƒå¯ä»¥è¢«é™„åŠ åˆ° Operation ä¸Šï¼Œåªæœ‰å½“ Condition è¢«æ»¡è¶³æ—¶ï¼ŒOperation æ‰èƒ½è¢«æ‰§è¡Œã€‚æ¯”å¦‚åªæœ‰åœ¨æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹æ‰èƒ½è¿›è¡Œäº¤æ˜“ï¼Œè¿™æ—¶ã€Œç½‘ç»œçŠ¶å†µã€å°±æ˜¯é™„åŠ ç»™ã€Œäº¤æ˜“ã€çš„ Conditionã€‚</p>
<p>ä¸€ä¸ª Condition ä¸»è¦åŒ…å«äº† 3 ä¸ªæ–¹æ³•ï¼š</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8e908c;">// 1
</span><span style="color:#8959a8;">static var</span><span> isMutuallyExclusive: </span><span style="color:#c99e00;">Bool</span><span> { </span><span style="color:#8959a8;">get</span><span> }
</span><span style="color:#8e908c;">// 2
</span><span style="color:#8959a8;">func </span><span>dependencyForOperation(operation: Operation) </span><span style="color:#3e999f;">-&gt;</span><span> NSOperation?
</span><span>// 3
</span><span>func evaluateForOperation(operation: Operation, completion: OperationConditionResult -&gt; </span><span style="color:#c99e00;">Void</span><span>)
</span></code></pre>
<ol>
<li>è¿™ä¸ªå±æ€§ç”¨æ¥è¡¨æ˜è¿™ä¸ª Condtion æ˜¯å¦æ˜¯æ’ä»–çš„ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒåŒä¸€æ—¶é—´åªèƒ½å‡ºç°ä¸€ä¸ªè¯¥ç±»å‹çš„å®ä¾‹ï¼Œç±»å‹çš„æŒ‡å®šæ˜¯é€šè¿‡è®¾ç½® <code>name</code> æ¥å®ç°çš„ã€‚</li>
<li>ä¸ºä¼ å…¥çš„ operation è¿”å›ä¸€ä¸ªä¾èµ–çš„ operationï¼Œæ¯”å¦‚ã€Œå–œæ¬¢ã€è¿™ä¸ª Operation éœ€è¦ç”¨æˆ·å·²å¤„äºç™»å½•çŠ¶æ€ï¼Œé‚£ä¹ˆã€Œç™»å½•ã€è¿™ä¸ª Condition çš„è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è¿”å›ä¸€ä¸ªã€Œç™»å½•ã€çš„ Operationã€‚</li>
<li>è¿™ä¸ªæ–¹æ³•æ˜¯æŸ¥çœ‹è¿™ä¸ª Condition çš„æ‰§è¡Œç»“æœï¼Œæ¯”å¦‚å‰é¢çš„ã€Œç™»å½•ã€Operation ç»“æŸåï¼Œç³»ç»Ÿå°†è¦æ‰§è¡Œã€Œå–œæ¬¢ã€è¿™ä¸ª Operationï¼Œç„¶åè¿™ä¸ªæ–¹æ³•å°±ä¼šè¢«è§¦å‘ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯å‘ç”Ÿçš„è¯ï¼Œå°±æ‰§è¡Œã€Œå–œæ¬¢ã€ï¼Œå¦‚æœæœ‰é”™è¯¯å‘ç”Ÿã€Œå–œæ¬¢ã€å°±ä¼šè‡ªåŠ¨ç»“æŸã€‚</li>
</ol>
<p>æ‰€ä»¥æ€»ç»“èµ·æ¥ Condition ä¸»è¦å¹²äº†è¿™ä¹ˆä¸‰ä»¶äº‹</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;advanced-nsoperation&#x2F;nsoperation-condition.png"
        width="412" /></p>
<p>æ¥çœ‹ä¸€ä¸ªç®€å•çš„ Condition (æ¥è‡ª WWDC Sample)</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">struct</span><span> ReachabilityCondition: OperationCondition {
</span><span>    </span><span style="color:#8959a8;">static let</span><span> hostKey </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">&quot;Host&quot;
</span><span>    </span><span style="color:#8959a8;">static let</span><span> name </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">&quot;Reachability&quot;
</span><span>    </span><span style="color:#8959a8;">static let</span><span> isMutuallyExclusive </span><span style="color:#3e999f;">= </span><span style="color:#8959a8;">false
</span><span>
</span><span>    </span><span style="color:#8959a8;">let</span><span> host: NSURL
</span><span>
</span><span>    </span><span style="color:#8e908c;">// 1
</span><span>    </span><span style="color:#8959a8;">init</span><span>(host: NSURL) {
</span><span>        </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>host </span><span style="color:#3e999f;">=</span><span> host
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8e908c;">// 2
</span><span>    </span><span style="color:#8959a8;">func </span><span>dependencyForOperation(operation: Operation) </span><span style="color:#3e999f;">-&gt;</span><span> NSOperation? {
</span><span>        </span><span style="color:#8959a8;">return </span><span>nil
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8959a8;">func </span><span>evaluateForOperation(operation: Operation, completion: OperationConditionResult </span><span style="color:#3e999f;">-&gt; </span><span style="color:#c99e00;">Void</span><span>) {
</span><span>        ReachabilityController</span><span style="color:#3e999f;">.</span><span>requestReachability(host) { reachable </span><span style="color:#8959a8;">in
</span><span>            </span><span style="color:#8959a8;">if</span><span> reachable {
</span><span>                </span><span style="color:#8e908c;">// 3
</span><span>                completion(</span><span style="color:#3e999f;">.</span><span>Satisfied)
</span><span>            }
</span><span>            </span><span style="color:#8959a8;">else</span><span> {
</span><span>                </span><span style="color:#8959a8;">let</span><span> error </span><span style="color:#3e999f;">=</span><span> NSError(code: </span><span style="color:#3e999f;">.</span><span>ConditionFailed, userInfo: [
</span><span>                    OperationConditionKey: </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span style="color:#8959a8;">dynamicType</span><span style="color:#3e999f;">.</span><span>name,
</span><span>                    </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span style="color:#8959a8;">dynamicType</span><span style="color:#3e999f;">.</span><span>hostKey: </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>host
</span><span>                ])
</span><span>                </span><span style="color:#8e908c;">// 4
</span><span>                completion(</span><span style="color:#3e999f;">.</span><span>Failed(error))
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<ol>
<li>Condtion åˆå§‹åŒ–æ—¶å¯ä»¥ä¼ å‚æ•°è¿›æ¥ã€‚</li>
<li>è¿™ä¸ª Condition æ²¡æœ‰ç”Ÿæˆä¸€ä¸ª <code>dependencyForOperation</code>ï¼Œå› ä¸ºç”Ÿæˆä¾èµ– Operation çš„ç›®çš„æ˜¯å½“è¿™ä¸ª Operation è¿è¡Œå®Œåï¼Œå¯ä»¥åœ¨ evaluateForOperation æ—¶è·å–ä¹‹å‰çš„è¿è¡Œç»“æœï¼Œè€Œè¿™é‡Œç›´æ¥è°ƒç”¨ ReachabilityController çš„ requestReachability æ–¹æ³•å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥å°±å…å»äº†è¿™ä¸€æ­¥ã€‚</li>
<li>å½“ç»“æœç¬¦åˆé¢„æœŸæ—¶ï¼Œè°ƒç”¨ <code>completion(.Satisfied)</code></li>
<li>å½“å‡ºç°å¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ <code>completion(.Failed(error))</code></li>
</ol>
<h4 id="operation">Operation</h4>
<p><code>Operation</code> ç»§æ‰¿è‡ª <code>NSOperation</code>ï¼ŒåŒæ—¶æ·»åŠ äº†ä¸€äº›æ–¹æ³•ï¼Œä¸»è¦å¯ä»¥åˆ†ä¸º 4 éƒ¨åˆ†</p>
<ul>
<li>è®¾ç½®çŠ¶æ€å˜é‡ï¼ŒåŒæ—¶æ‰‹åŠ¨è®¾ç½® KVO</li>
<li>æ‰§è¡Œ conditions çš„ <code>evaluateForOperation</code> æ–¹æ³•</li>
<li>æ·»åŠ  Observer</li>
<li>æ·»åŠ  Condtion</li>
</ul>
<h5 id="she-zhi-zhuang-tai-bian-liang-tong-shi-shou-dong-she-zhi-kvo">è®¾ç½®çŠ¶æ€å˜é‡ï¼ŒåŒæ—¶æ‰‹åŠ¨è®¾ç½® KVO</h5>
<p>åœ¨ç³»ç»Ÿæä¾›çš„çŠ¶æ€çš„åŸºç¡€ä¸Šï¼Œåˆæ·»åŠ äº†ä¸€äº›æ–°çš„çŠ¶æ€ï¼Œå¦‚ <code>EvaluatingConditions</code>, <code>Pending</code> ç­‰ï¼Œè¿™äº›çŠ¶æ€çš„æ”¹å˜éƒ½éœ€è¦è§¦å‘å†…ç½®çŠ¶æ€çš„ KVOï¼Œå¦‚ <code>isExecuting</code>, <code>isFinished</code>, <code>isReady</code> ç­‰ã€‚é€šå¸¸çš„åšæ³•ä¼šæ˜¯è¿™æ ·ï¼š</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">willChangeValueForKey:</span><span style="color:#839c00;">@&quot;isExecuting&quot;</span><span>];
</span><span>_state </span><span style="color:#3e999f;">=</span><span> Executing;
</span><span>[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">didChangeValueForKey:</span><span style="color:#839c00;">@&quot;isExecuting&quot;</span><span>];
</span></code></pre>
<p>å½“åªæœ‰å°‘é‡çš„çŠ¶æ€æ”¹å˜æ—¶ï¼Œåœ¨å‰ååŒ…ä¸€å±‚è¿˜å¯ä»¥æ¥å—ï¼Œä½†å¦‚æœå¤šäº†çš„è¯ï¼Œå°±ä¸ç¾è§‚äº†ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ KVO çš„ä¸€ä¸ªæ–¹æ³• <code>+ keyPathsForValuesAffectingValueForKey:</code>ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œå“ªäº› keyPaths çš„æ”¹å˜ä¼šå¯¼è‡´ <code>Key</code> å‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥å¯ä»¥å®šä¹‰è¿™å‡ ä¸ªæ–¹æ³•ï¼Œç„¶åæ­£å¸¸è®¾ç½® <code>state</code> å°±å¯ä»¥äº†ã€‚</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">class func </span><span>keyPathsForValuesAffectingIsReady() </span><span style="color:#3e999f;">-&gt;</span><span> Set&lt;NSObject&gt; {
</span><span>    </span><span style="color:#8959a8;">return</span><span> [</span><span style="color:#839c00;">&quot;state&quot;</span><span>]
</span><span>}
</span><span>
</span><span style="color:#8959a8;">class func </span><span>keyPathsForValuesAffectingIsExecuting() </span><span style="color:#3e999f;">-&gt;</span><span> Set&lt;NSObject&gt; {
</span><span>    </span><span style="color:#8959a8;">return</span><span> [</span><span style="color:#839c00;">&quot;state&quot;</span><span>]
</span><span>}
</span><span>
</span><span style="color:#8959a8;">class func </span><span>keyPathsForValuesAffectingIsFinished() </span><span style="color:#3e999f;">-&gt;</span><span> Set&lt;NSObject&gt; {
</span><span>    </span><span style="color:#8959a8;">return</span><span> [</span><span style="color:#839c00;">&quot;state&quot;</span><span>]
</span><span>}
</span></code></pre>
<p>å½“ç„¶ï¼Œè¿™åªæ˜¯å®Œæˆäº†ä¸€åŠï¼Œç³»ç»ŸçŸ¥é“ state å˜äº†åï¼Œ <code>isReady</code> ä¼šå˜ï¼Œç„¶åå°±ä¼šè°ƒç”¨ <code>ready</code> æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸‰ä¸ªæ–¹æ³•æˆ‘ä»¬ä¹Ÿè¦ä¸€å¹¶è¦†ç›–æ‰ã€‚</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">override var</span><span> executing: </span><span style="color:#c99e00;">Bool</span><span> {
</span><span>    </span><span style="color:#8959a8;">return</span><span> state </span><span style="color:#3e999f;">== .</span><span>Executing
</span><span>}
</span><span>
</span><span style="color:#8959a8;">override var</span><span> finished: </span><span style="color:#c99e00;">Bool</span><span> {
</span><span>    </span><span style="color:#8959a8;">return</span><span> state </span><span style="color:#3e999f;">== .</span><span>Finished
</span><span>}
</span><span>
</span><span style="color:#8959a8;">override var</span><span> ready: </span><span style="color:#c99e00;">Bool</span><span> {
</span><span>    </span><span style="color:#8959a8;">switch</span><span> state {
</span><span>
</span><span>        </span><span style="color:#8959a8;">case </span><span style="color:#3e999f;">.</span><span>Pending:
</span><span>            </span><span style="color:#8e908c;">// çœå»ä¸ç›¸å…³çš„ä»£ç 
</span><span>            </span><span style="color:#8959a8;">if super</span><span style="color:#3e999f;">.</span><span>ready {
</span><span>                </span><span style="color:#8e908c;">// 1
</span><span>                evaluateConditions()
</span><span>            }
</span><span>
</span><span>            </span><span style="color:#8e908c;">// Until conditions have been evaluated, &quot;isReady&quot; returns false
</span><span>            </span><span style="color:#8959a8;">return false
</span><span>
</span><span>        </span><span style="color:#8959a8;">case </span><span style="color:#3e999f;">.</span><span>Ready:
</span><span>            </span><span style="color:#8959a8;">return super</span><span style="color:#3e999f;">.</span><span>ready </span><span style="color:#3e999f;">||</span><span> cancelled
</span><span>
</span><span>        </span><span style="color:#8959a8;">default</span><span>:
</span><span>            </span><span style="color:#8959a8;">return false
</span><span>    }
</span><span>}
</span><span>
</span></code></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå½“ç³»ç»Ÿåœ¨é—®æŸä¸ª Operation æ˜¯å¦ ready æ—¶ï¼Œ<code>evaluateConditions</code> æ–¹æ³•ä¼šè¢«è§¦å‘ï¼Œè¿™é‡ŒåŒ…å«äº†è¯¥ Operation çš„æ‰€æœ‰ Conditions çš„ <code>evaluateForOperation</code> çš„æ‰§è¡Œç»“æœã€‚</li>
</ol>
<h5 id="zhi-xing-conditions-de-evaluateforoperation-fang-fa">æ‰§è¡Œ conditions çš„ <code>evaluateForOperation</code> æ–¹æ³•</h5>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">private func </span><span>evaluateConditions() {
</span><span>    assert(state </span><span style="color:#3e999f;">== .</span><span>Pending </span><span style="color:#3e999f;">&amp;&amp; !</span><span>cancelled, </span><span style="color:#839c00;">&quot;evaluateConditions() was called out-of-order&quot;</span><span>)
</span><span>
</span><span>    state </span><span style="color:#3e999f;">= .</span><span>EvaluatingConditions
</span><span>
</span><span>    </span><span style="color:#8e908c;">// 1
</span><span>    OperationConditionEvaluator</span><span style="color:#3e999f;">.</span><span>evaluate(conditions, operation: </span><span style="color:#8959a8;">self</span><span>) { failures </span><span style="color:#8959a8;">in
</span><span>        </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>_internalErrors</span><span style="color:#3e999f;">.</span><span>extend(failures)
</span><span>        </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>state </span><span style="color:#3e999f;">= .</span><span>Ready
</span><span>    }
</span><span>}
</span></code></pre>
<ol>
<li>éå†å½“å‰ Operation çš„ conditionsï¼Œæ‰§è¡Œå®ƒä»¬çš„ <code>evaluateForOperation</code> æ–¹æ³•ï¼Œç„¶åå°†é”™è¯¯ä¿å­˜åœ¨ <code>_internalErrors</code> é‡Œï¼ŒåŒæ—¶å°†å½“å‰çš„çŠ¶æ€è®¾ç½®ä¸º <code>.Ready</code>ã€‚</li>
</ol>
<p>æˆ–è®¸ä½ ä¼šé—®ï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œæ˜¯ä¸æ˜¯è¡¨ç¤ºæ¡ä»¶ä¸æ»¡è¶³ï¼Œå¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å°†çŠ¶æ€è®¾ç½®ä¸º <code>.Ready</code>ï¼Ÿ è¿™æ˜¯å› ä¸ºå½“çŠ¶æ€è®¾ç½®ä¸º <code>.Ready</code> åï¼Œå°±ä¼šæ‰§è¡Œ <code>main</code> æ–¹æ³•ï¼Œåœ¨é‚£é‡Œä¼šå¯¹ <code>_internalErrors</code> åšç»Ÿä¸€åˆ¤æ–­ã€‚</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">override final func </span><span>main() {
</span><span>    assert(state </span><span style="color:#3e999f;">== .</span><span>Ready, </span><span style="color:#839c00;">&quot;This operation must be performed on an operation queue.&quot;</span><span>)
</span><span>
</span><span>    </span><span style="color:#8959a8;">if</span><span> _internalErrors</span><span style="color:#3e999f;">.</span><span>isEmpty </span><span style="color:#3e999f;">&amp;&amp; !</span><span>cancelled {
</span><span>        state </span><span style="color:#3e999f;">= .</span><span>Executing
</span><span>
</span><span>        </span><span style="color:#8e908c;">// 1
</span><span>        </span><span style="color:#8959a8;">for</span><span> observer </span><span style="color:#8959a8;">in</span><span> observers {
</span><span>            observer</span><span style="color:#3e999f;">.</span><span>operationDidStart(</span><span style="color:#8959a8;">self</span><span>)
</span><span>        }
</span><span>
</span><span>        execute()
</span><span>    }
</span><span>    </span><span style="color:#8959a8;">else</span><span> {
</span><span>        finish()
</span><span>    }
</span><span>}
</span></code></pre>
<ol>
<li>è¿™é‡Œå‡ºç°äº† observerï¼Œå½“ Operation å¤„äºä¸åŒçŠ¶æ€æ—¶ï¼Œä¼šè°ƒç”¨ observers çš„ä¸åŒæ–¹æ³•</li>
</ol>
<h5 id="tian-jia-observers">æ·»åŠ  Observers</h5>
<p>observer çš„å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ª Protocolï¼Œæ‰€æœ‰çš„ observer éƒ½éœ€è¦å®ç°è¿™ä¸ª Protocol é‡Œçš„æ–¹æ³•ï¼Œç„¶å Operation å†…ç½®ä¸€ä¸ªæ•°ç»„ä½œä¸ºå®¹å™¨ï¼Œ<code>addObserver</code> æ—¶ï¼Œå°† observer æ·»åŠ åˆ°å®¹å™¨ï¼Œå½“å¤„äºä¸åŒçŠ¶æ€æ—¶ï¼Œéå†å®¹å™¨é‡Œçš„ observerï¼Œè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚</p>
<p>è¿™ä¸å…è®©æˆ‘ä»¬æƒ³èµ·äº† delegateï¼Œè·Ÿ delegate ç›¸æ¯”ï¼Œobserver çš„å¥½å¤„å°±åœ¨äºå¯ä»¥æŒ‡å®šå¤šä¸ªè§‚å¯Ÿè€…ï¼Œè€Œ delegate åªèƒ½æŒ‡å®šä¸€ä¸ªã€‚</p>
<h5 id="tian-jia-condtions">æ·»åŠ  Condtions</h5>
<p>è·Ÿ observer çš„å®ç°æ€è·¯åŸºæœ¬ä¸€è‡´ã€‚ä½ æˆ–è®¸ä¼šé—®ï¼Œæ·»åŠ çš„è¿™äº› Conditions ä»€ä¹ˆæ—¶å€™ä¼šè¢«è§¦å‘å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯åœ¨å°† Operation æ·»åŠ åˆ° OperationQueue æ—¶ã€‚</p>
<h4 id="operationqueue">OperationQueue</h4>
<p><code>OperationQueue</code> ä¹Ÿæ˜¯ç»§æ‰¿è‡ªç³»ç»Ÿçš„ <code>NSOperationQueue</code>ï¼ŒåŒæ—¶é‡å†™äº† <code>addOperation</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº† 3 ä»¶äº‹</p>
<ul>
<li>ç»™ Operation æ·»åŠ  observer</li>
<li>å¤„ç† Operation çš„ dependencies çš„ <code>dependencyForOperation</code></li>
<li>å¤„ç† Operation çš„ dependencies çš„æ’ä»–æ€§</li>
</ul>
<h5 id="gei-operation-tian-jia-observer">ç»™ Operation æ·»åŠ  observer</h5>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">let</span><span> delegate </span><span style="color:#3e999f;">=</span><span> BlockObserver(
</span><span>    startHandler: nil,
</span><span>    produceHandler: { [</span><span style="color:#8959a8;">weak self</span><span>] </span><span style="color:#8959a8;">in
</span><span>        </span><span style="color:#8e908c;">// 1
</span><span>        </span><span style="color:#8959a8;">self</span><span>?</span><span style="color:#3e999f;">.</span><span>addOperation($</span><span style="color:#f07219;">1</span><span>)
</span><span>    },
</span><span>    finishHandler: { [</span><span style="color:#8959a8;">weak self</span><span>] </span><span style="color:#8959a8;">in
</span><span>        </span><span style="color:#8959a8;">if let</span><span> q </span><span style="color:#3e999f;">= </span><span style="color:#8959a8;">self</span><span> {
</span><span>            </span><span style="color:#8e908c;">// 2
</span><span>            q</span><span style="color:#3e999f;">.</span><span>delegate?</span><span style="color:#3e999f;">.</span><span>operationQueue?(q, operationDidFinish: $</span><span style="color:#f07219;">0</span><span>, withErrors: $</span><span style="color:#f07219;">1</span><span>)
</span><span>        }
</span><span>    }
</span><span>)
</span><span>op</span><span style="color:#3e999f;">.</span><span>addObserver(delegate)
</span></code></pre>
<ol>
<li>æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œä¸€ä¸ª Operation å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ Operationï¼Œè¿™ä¸ª Operation ç”Ÿæˆåä¹Ÿéœ€è¦è¢«æ”¾åˆ° Queue é‡Œï¼Œè¿™ä¸ªæ”¾ç½®çš„è¿‡ç¨‹å°±æ˜¯åœ¨è¿™ä¸ª delegate é‡Œå®ç°çš„ã€‚</li>
<li>operationQueue è‡ªå·±æœ‰ä¸€ä¸ª delegateï¼Œå½“ queue é‡Œçš„ä¸€ä¸ª operation æ‰§è¡Œå®Œæ—¶ï¼Œä¼šå‘ delegate æŠ¥å‘Šã€‚</li>
</ol>
<h5 id="chu-li-operation-de-dependencies-de-dependencyforoperation">å¤„ç† Operation çš„ dependencies çš„ dependencyForOperation</h5>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8e908c;">// Extract any dependencies needed by this operation.
</span><span style="color:#8959a8;">let</span><span> dependencies </span><span style="color:#3e999f;">=</span><span> op</span><span style="color:#3e999f;">.</span><span>conditions</span><span style="color:#3e999f;">.</span><span>flatMap {
</span><span>    $</span><span style="color:#f07219;">0</span><span style="color:#3e999f;">.</span><span>dependencyForOperation(op)
</span><span>}
</span><span>
</span><span style="color:#8959a8;">for</span><span> dependency </span><span style="color:#8959a8;">in</span><span> dependencies {
</span><span>    op</span><span style="color:#3e999f;">.</span><span>addDependency(dependency)
</span><span>
</span><span>    </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>addOperation(dependency)
</span><span>}
</span></code></pre>
<p>è¿™ä¸ªå°±å¾ˆç®€å•äº†ï¼Œè°ƒç”¨ <code>dependencyForOperation</code> æ–¹æ³•ï¼Œæ‹¿åˆ° operationï¼Œç„¶åå°†å½“å‰çš„ op ä¾èµ–è¯¥ operationï¼ŒåŒæ—¶å°†è¿™ä¸ª operation æ”¾åˆ° queue é‡Œï¼Œæ‰€ä»¥åœ¨ conditions çš„ operations æ‰§è¡Œå®Œä¹‹å‰ï¼Œop æ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚</p>
<h5 id="chu-li-operation-de-dependencies-de-pai-ta-xing">å¤„ç† Operation çš„ dependencies çš„æ’ä»–æ€§</h5>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">let</span><span> concurrencyCategories: [</span><span style="color:#c99e00;">String</span><span>] </span><span style="color:#3e999f;">=</span><span> op</span><span style="color:#3e999f;">.</span><span>conditions</span><span style="color:#3e999f;">.</span><span>flatMap { condition </span><span style="color:#8959a8;">in
</span><span>    </span><span style="color:#8959a8;">if </span><span style="color:#3e999f;">!</span><span>condition</span><span style="color:#3e999f;">.</span><span style="color:#8959a8;">dynamicType</span><span style="color:#3e999f;">.</span><span>isMutuallyExclusive { </span><span style="color:#8959a8;">return </span><span>nil }
</span><span>
</span><span>    </span><span style="color:#8959a8;">return </span><span style="color:#839c00;">&quot;</span><span>\(condition</span><span style="color:#3e999f;">.</span><span style="color:#8959a8;">dynamicType</span><span>)</span><span style="color:#839c00;">&quot;
</span><span>}
</span><span>
</span><span style="color:#8959a8;">if </span><span style="color:#3e999f;">!</span><span>concurrencyCategories</span><span style="color:#3e999f;">.</span><span>isEmpty {
</span><span>    </span><span style="color:#8e908c;">// Set up the mutual exclusivity dependencies.
</span><span>    </span><span style="color:#8959a8;">let</span><span> exclusivityController </span><span style="color:#3e999f;">=</span><span> ExclusivityController</span><span style="color:#3e999f;">.</span><span>sharedExclusivityController
</span><span>
</span><span>    exclusivityController</span><span style="color:#3e999f;">.</span><span>addOperation(op, categories: concurrencyCategories)
</span><span>
</span><span>    op</span><span style="color:#3e999f;">.</span><span>addObserver(BlockObserver { operation, _ </span><span style="color:#8959a8;">in
</span><span>        exclusivityController</span><span style="color:#3e999f;">.</span><span>removeOperation(operation, categories: concurrencyCategories)
</span><span>    })
</span><span>}
</span></code></pre>
<p>åœ¨è¿™é‡Œå¯èƒ½çœ‹ä¸å‡ºã€Œæ’ä»–ã€çš„å®ç°ï¼Œå› ä¸ºæ˜¯åœ¨ <code>exclusivityController</code> é‡Œé¢å®ç°çš„ï¼Œè°ƒç”¨äº†å®ƒçš„ <code>addOperation</code> æ–¹æ³•åï¼Œå®ƒä¼šå»æŸ¥çœ‹è¿™ä¸ªç±»å‹çš„æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±è®©è¿™ä¸ª operation ä¾èµ–æ•°ç»„çš„æœ€åä¸€ä¸ªã€‚è¿™æ ·åœ¨ä¹‹å‰çš„ operation æ‰§è¡Œå®Œä¹‹å‰ï¼Œè¿™ä¸ª operation æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ã€‚</p>
<h3 id="shi-yong">ä½¿ç”¨</h3>
<p>æœ‰äº† Operation å’Œ OperationQueue ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹ç”Ÿäº§ megabot äº†ï¼Œæ¥çœ‹ä¸€ä¸ªã€ŒæŸ¥çœ‹åŸç½‘é¡µã€çš„ Operationï¼Œè¿™ä¸ª Operation çš„ä½œç”¨å°±æ˜¯å±•ç¤ºä¼ å…¥çš„ URLã€‚</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">import </span><span style="color:#c99e00;">Foundation
</span><span style="color:#8959a8;">import </span><span style="color:#c99e00;">SafariServices
</span><span>
</span><span style="color:#8e908c;">/// An `Operation` to display an `NSURL` in an app-modal `SFSafariViewController`.
</span><span style="color:#8959a8;">class</span><span> MoreInformationOperation: Operation {
</span><span>
</span><span>    </span><span style="color:#8959a8;">let</span><span> URL: NSURL
</span><span>
</span><span>    </span><span style="color:#8959a8;">init</span><span>(URL: NSURL) {
</span><span>        </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>URL </span><span style="color:#3e999f;">=</span><span> URL
</span><span>        </span><span style="color:#8959a8;">super</span><span style="color:#3e999f;">.</span><span style="color:#8959a8;">init</span><span>()
</span><span>        </span><span style="color:#8e908c;">// 1
</span><span>        addCondition(MutuallyExclusive</span><span style="color:#3e999f;">&lt;</span><span>UIViewController</span><span style="color:#3e999f;">&gt;</span><span>())
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8959a8;">override func </span><span>execute() {
</span><span>        dispatch_async(dispatch_get_main_queue()) {
</span><span>            </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>showSafariViewController()
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8959a8;">private func </span><span>showSafariViewController() {
</span><span>        </span><span style="color:#8959a8;">if let</span><span> context </span><span style="color:#3e999f;">=</span><span> UIApplication</span><span style="color:#3e999f;">.</span><span>sharedApplication()</span><span style="color:#3e999f;">.</span><span>keyWindow?</span><span style="color:#3e999f;">.</span><span>rootViewController {
</span><span>            </span><span style="color:#8959a8;">let</span><span> safari </span><span style="color:#3e999f;">=</span><span> SFSafariViewController(URL: URL, entersReaderIfAvailable: </span><span style="color:#8959a8;">false</span><span>)
</span><span>            safari</span><span style="color:#3e999f;">.</span><span>delegate </span><span style="color:#3e999f;">= </span><span style="color:#8959a8;">self
</span><span>            context</span><span style="color:#3e999f;">.</span><span>presentViewController(safari, animated: </span><span style="color:#8959a8;">true</span><span>, completion: nil)
</span><span>        }
</span><span>        </span><span style="color:#8959a8;">else</span><span> {
</span><span>            finish()
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#8959a8;">extension</span><span> MoreInformationOperation: SFSafariViewControllerDelegate {
</span><span>    </span><span style="color:#8959a8;">func </span><span>safariViewControllerDidFinish(controller: SFSafariViewController) {
</span><span>        controller</span><span style="color:#3e999f;">.</span><span>dismissViewControllerAnimated(</span><span style="color:#8959a8;">true</span><span>) {
</span><span>            </span><span style="color:#8e908c;">// 2
</span><span>            </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>finish()
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<ol>
<li>å› ä¸ºè¿™æ˜¯ä¸€ä¸ª <code>ViewController</code> ç›¸å…³çš„ Operationï¼Œæ‰€ä»¥å…¶ä»–åŒç±»å‹çš„ Operationï¼Œéœ€è¦ç­‰æˆ‘å®Œæˆåæ‰èƒ½è¢«æ‰§è¡Œã€‚</li>
<li>å½“è¿™ä¸ª controller è¢«å…³é—­æ—¶ï¼Œè¡¨ç¤ºè¿™ä¸ª Operation ç»“æŸï¼Œè°ƒç”¨ä¸€ä¸‹ <code>finish</code> æ–¹æ³•ã€‚</li>
</ol>
<p>å¦‚æœéœ€è¦çš„è¯ï¼Œå¯ä»¥ç»™è¿™ä¸ª Operation å†åŠ ä¸€ä¸ª <code>ReachabilityCondition</code>ï¼Œå½“æ²¡æœ‰ç½‘ç»œæ—¶å°±ä¸æ‰“å¼€äº†ã€‚</p>
<p>å†æ¥çœ‹çœ‹åœ¨ VC å±‚é¢çš„ä½¿ç”¨ã€‚</p>
<pre data-lang="swift" style="background-color:#f9f9f9;color:#111111;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#8959a8;">override func </span><span>tableView(tableView: UITableView, didSelectRowAtIndexPath indexPath: NSIndexPath) {
</span><span>
</span><span>    </span><span style="color:#8e908c;">// 1
</span><span>    </span><span style="color:#8959a8;">let</span><span> operation </span><span style="color:#3e999f;">=</span><span> BlockOperation {
</span><span>        </span><span style="color:#8959a8;">self</span><span style="color:#3e999f;">.</span><span>performSegueWithIdentifier(</span><span style="color:#839c00;">&quot;showEarthquake&quot;</span><span>, sender: nil)
</span><span>    }
</span><span>
</span><span>    operation</span><span style="color:#3e999f;">.</span><span>addCondition(MutuallyExclusive</span><span style="color:#3e999f;">&lt;</span><span>UIViewController</span><span style="color:#3e999f;">&gt;</span><span>())
</span><span>
</span><span>    </span><span style="color:#8e908c;">// 2
</span><span>    </span><span style="color:#8959a8;">let</span><span> blockObserver </span><span style="color:#3e999f;">=</span><span> BlockObserver { _, errors </span><span style="color:#8959a8;">in
</span><span>        </span><span style="color:#8e908c;">/*
</span><span style="color:#8e908c;">            If the operation errored (ex: a condition failed) then the segue
</span><span style="color:#8e908c;">            isn&#39;t going to happen. We shouldn&#39;t leave the row selected.
</span><span style="color:#8e908c;">        */
</span><span>        </span><span style="color:#8959a8;">if </span><span style="color:#3e999f;">!</span><span>errors</span><span style="color:#3e999f;">.</span><span>isEmpty {
</span><span>            dispatch_async(dispatch_get_main_queue()) {
</span><span>                tableView</span><span style="color:#3e999f;">.</span><span>deselectRowAtIndexPath(indexPath, animated: </span><span style="color:#8959a8;">true</span><span>)
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    operation</span><span style="color:#3e999f;">.</span><span>addObserver(blockObserver)
</span><span>
</span><span>    </span><span style="color:#8e908c;">// 3
</span><span>    operationQueue</span><span style="color:#3e999f;">.</span><span>addOperation(operation)
</span><span>}
</span></code></pre>
<ol>
<li>ç±»ä¼¼ <code>NSBlockOperation</code>ï¼Œ <code>BlockOperation</code> ä¹Ÿå¯ä»¥å¿«é€Ÿç”Ÿæˆä¸€ä¸ª Operationã€‚</li>
<li><code>BlockObserver</code> ä¹Ÿæ˜¯ä¸€ä¸ªå¿«é€Ÿç”Ÿæˆ observer çš„æ–¹æ³•ï¼Œè¿™é‡Œæè¿°äº†å½“ Operation å®Œæˆåçš„å¤„ç†ã€‚</li>
<li>è°ƒç”¨æ–¹éœ€è¦æ–°å»ºä¸€ä¸ª queueï¼Œç„¶åæŠŠ Operation æ”¾åˆ°è¿™ä¸ª queue é‡Œã€‚</li>
</ol>
<p>ç›¸æ¯”èµ·æ­£å¸¸çš„è°ƒç”¨ï¼Œè¿˜æ˜¯ä¼šå¤šäº†äº›æ­¥éª¤ã€‚</p>
<h3 id="xiao-jie">å°ç»“</h3>
<p>åŸºäº Operation æ¥æ¶æ„çš„æ€æƒ³è¿˜æ˜¯è›®æ–°é¢–çš„ï¼Œå¯ä»¥å°†å¤æ‚çš„ä»»åŠ¡æ‹†åˆ†æˆç²’åº¦æ›´ç»†çš„ Operationï¼Œç„¶åå†ç»„è£…ã€‚ä½†å®é™…ä½¿ç”¨èµ·æ¥ä¹Ÿä¼šæœ‰ä¸å°‘é—®é¢˜ï¼Œæ¯”å¦‚ä¹‹å‰æåˆ°çš„å†™èµ·æ¥ä¼šå¤æ‚äº›ï¼Œè°ƒè¯•æ—¶çœ‹ backtrace ä¼šå¾ˆç´¯ï¼Œä¸ç¡®å®šæ˜¯å¦ä¼šå¸¦æ¥æ›´å¥½çš„å¯ç»´æŠ¤æ€§ç­‰ç­‰ã€‚ä¸è¿‡æ—¢ç„¶è‹¹æœéƒ½å·²ç»æŠŠå®ƒç”¨åˆ°äº†çº¿ä¸Šçš„ Appï¼Œè‡³å°‘è¯´æ˜æ˜¯å¯è¡Œçš„ï¼Œè‡³äºä¸å·²æœ‰çš„æ¶æ„ç›¸æ¯”ä¼šå¸¦æ¥æ€æ ·çš„æå‡ï¼Œå¯èƒ½éœ€è¦å®é™…å†™èµ·æ¥æ‰çŸ¥é“ã€‚</p>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/ios/">iOS</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // éƒ½æ˜¯ä¸ºäº† iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>