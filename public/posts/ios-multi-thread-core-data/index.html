<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <link rel="icon" href="https://fav.farm/ğŸ‘»" />
  <title>
è¯´è¯´iOSçš„å¤šçº¿ç¨‹Core Data
</title>
  <link rel="stylesheet" href="/assets/main.css?9zs&#x2F;BXhW+t7PNacyPraNbWdNoN&#x2F;V7G9VhdTj5z3mo8A=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/ios-multi-thread-core-data/">

<meta name="twitter:title" content="è¯´è¯´iOSçš„å¤šçº¿ç¨‹Core Data">
<meta property="og:title" content="è¯´è¯´iOSçš„å¤šçº¿ç¨‹Core Data">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center bg-zinc-700 h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;ios-multi-thread-core-data&#x2F;">è¯´è¯´iOSçš„å¤šçº¿ç¨‹Core Data</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2013-06-16</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <p>Core Data æ˜¯ iOS ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¯ä»¥ç†è§£ä¸ºåŸºäº SQLite(å½“ç„¶ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ Storageï¼Œå¦‚ In-memoryï¼Œåªæ˜¯ SQLite æ¯”è¾ƒå¸¸è§)çš„ä¸€ä¸ª ORM å®ç°ï¼Œæ‰€ä»¥æœ‰å…³ç³»æ•°æ®åº“çš„ç‰¹æ€§ï¼Œåˆä¸ç”¨å†™ SQLã€‚é¡ºä¾¿åä¸€ä¸‹æ§½ï¼Œå®˜æ–¹è¯´æ³•æ˜¯ä½¿ç”¨ Core Data èƒ½å‡å°‘ 50%-70%çš„ä»£ç é‡ï¼Œä½†ç›¸ä¿¡ç”¨è¿‡çš„äººåº”è¯¥éƒ½å¿ƒé‡Œæ˜ç™½ï¼ŒCore Data ä½¿ç”¨èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰ä¸å°‘çš„ç¬¬ä¸‰æ–¹ç±»åº“æ¥ä»£æ›¿/äºŒæ¬¡åŒ…è£… Core Dataã€‚</p>
<p>ç¨å¾®å¤æ‚çš„åº”ç”¨å°±æœ‰å¯èƒ½å‡ºç°åŒæ—¶å¤„ç†å¤šä»½æ•°æ®çš„æƒ…å†µï¼Œè¿™å°±éœ€è¦ç”¨åˆ°å¤šçº¿ç¨‹ Core Dataã€‚åœ¨ iOS 5 ä¹‹å‰ï¼Œå®˜æ–¹æ¨èçš„æ˜¯ä½¿ç”¨ã€ŒThread Confinementã€ï¼Œå°±æ˜¯æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„ MOC(managed object context)ï¼Œç„¶åå…±äº«ä¸€ä¸ª PSC(persistent store coordinator)ã€‚åŒæ—¶åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®æ—¶ï¼Œè¦ä¼ é€’ objectIDï¼Œè€Œä¸æ˜¯ objectï¼Œå› ä¸ºå‰è€…æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåè€…ä¸æ˜¯ã€‚</p>
<p>å¦‚æœ A çº¿ç¨‹é‡Œï¼Œå¯¹ PSC æ‰§è¡Œäº† CUD(create, update, delete)æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹å¦‚ä½•æ„ŸçŸ¥å‘¢ï¼Ÿè¿™å°±éœ€è¦é€šè¿‡ç›‘å¬äº‹ä»¶æ¥å®ç°ã€‚æ¯”å¦‚åœ¨çº¿ç¨‹ A ä¸­ç›‘å¬ã€ŒNSManagedObjectContextDidSaveNotificationã€äº‹ä»¶ï¼Œå¦‚æœçº¿ç¨‹ B ä¸­æ‰§è¡Œäº† CUD æ“ä½œï¼Œçº¿ç¨‹ A å°±èƒ½æ„ŸçŸ¥åˆ°ï¼Œå¹¶è§¦å‘å“åº”çš„ actionï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ noti userinfo æ¥è·å– managed objectsï¼Œä½†å› ä¸ºå®ƒä»¬æ˜¯å…³è”åˆ°å¦ä¸€ä¸ª MOCï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥æ“ä½œå®ƒä»¬ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯è°ƒç”¨ã€ŒmergeChangesFromContextDidSaveNotification:ã€æ–¹æ³•ã€‚</p>
<p>ç”¨ä¸€å¼ å›¾æ¥å½¢å®¹çš„è¯ï¼Œå¤§ä½“å°±æ˜¯è¿™æ ·ï¼š</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;ios-multi-thread-core-data&#x2F;multi_thread_core_data.png"
        width="510" /></p><pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)_setupCoreDataStack
</span><span>{
</span><span>     </span><span style="color:#8e908c;">// setup managed object model
</span><span>     </span><span style="color:#c99e00;">NSURL </span><span style="color:#3e999f;">*</span><span>modelURL </span><span style="color:#3e999f;">= </span><span>[[</span><span style="color:#c99e00;">NSBundle </span><span style="color:#4271ae;">mainBundle</span><span>] URLForResource</span><span style="color:#3e999f;">:</span><span style="color:#839c00;">@&quot;Database&quot;</span><span> withExtension</span><span style="color:#3e999f;">:</span><span style="color:#839c00;">@&quot;momd&quot;</span><span>];
</span><span>     _managedObjectModel </span><span style="color:#3e999f;">= </span><span>[[NSManagedObjectModel </span><span style="color:#4271ae;">alloc</span><span>] initWithContentsOfURL</span><span style="color:#3e999f;">:</span><span>modelURL];
</span><span>
</span><span>     </span><span style="color:#8e908c;">// setup persistent store coordinator
</span><span>     </span><span style="color:#c99e00;">NSURL </span><span style="color:#3e999f;">*</span><span>storeURL </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c99e00;">NSURL </span><span style="color:#4271ae;">fileURLWithPath:[[</span><span style="color:#c99e00;">NSString </span><span style="color:#4271ae;">cachesPath] stringByAppendingPathComponent</span><span style="color:#3e999f;">:</span><span style="color:#839c00;">@&quot;Database.db&quot;</span><span style="color:#4271ae;">]</span><span>];
</span><span>
</span><span>     </span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span>error </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">nil</span><span>;
</span><span>     _persistentStoreCoordinator </span><span style="color:#3e999f;">= </span><span>[[NSPersistentStoreCoordinator </span><span style="color:#4271ae;">alloc</span><span>] initWithManagedObjectModel</span><span style="color:#3e999f;">:</span><span>_managedObjectModel];
</span><span>
</span><span>     </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#3e999f;">!</span><span>[_persistentStoreCoordinator </span><span style="color:#4271ae;">addPersistentStoreWithType:NSSQLiteStoreType configuration:</span><span style="color:#f07219;">nil </span><span style="color:#4271ae;">URL:storeURL options:</span><span style="color:#f07219;">nil </span><span style="color:#4271ae;">error:</span><span style="color:#3e999f;">&amp;</span><span style="color:#4271ae;">amp;error</span><span>]) {
</span><span>   	     </span><span style="color:#8e908c;">// handle error
</span><span>   }
</span><span>
</span><span>     </span><span style="color:#8e908c;">// create MOC
</span><span>     _managedObjectContext </span><span style="color:#3e999f;">= </span><span>[[NSManagedObjectContext </span><span style="color:#4271ae;">alloc</span><span>] init];
</span><span>     [_managedObjectContext </span><span style="color:#4271ae;">setPersistentStoreCoordinator:_persistentStoreCoordinator</span><span>];
</span><span>
</span><span>     </span><span style="color:#8e908c;">// subscribe to change notifications
</span><span>     [[</span><span style="color:#c99e00;">NSNotificationCenter </span><span style="color:#4271ae;">defaultCenter</span><span>] addObserver</span><span style="color:#3e999f;">:</span><span style="color:#c82728;">self</span><span> selector</span><span style="color:#3e999f;">:</span><span style="color:#8959a8;">@selector</span><span>(</span><span style="color:#4271ae;">_mocDidSaveNotification:</span><span>) name</span><span style="color:#3e999f;">:</span><span>NSManagedObjectContextDidSaveNotification object</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">nil</span><span>];
</span><span>}
</span></code></pre>
<p>å†æ¥çœ‹çœ‹ Notification Handlerï¼Œä¸»è¦ä½œç”¨å°±æ˜¯åˆå¹¶æ–°çš„å˜åŒ–ã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)_mocDidSaveNotification</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#f07219;">NSNotification </span><span style="color:#3e999f;">*</span><span>)notification
</span><span>{
</span><span>     NSManagedObjectContext </span><span style="color:#3e999f;">*</span><span>savedContext </span><span style="color:#3e999f;">= </span><span>[notification </span><span style="color:#4271ae;">object</span><span>];
</span><span>
</span><span>     </span><span style="color:#8e908c;">// ignore change notifications for the main MOC
</span><span>     </span><span style="color:#8959a8;">if </span><span>(_managedObjectContext </span><span style="color:#3e999f;">==</span><span> savedContext) {
</span><span>          </span><span style="color:#8959a8;">return</span><span>;
</span><span>     }
</span><span>
</span><span>     </span><span style="color:#c82728;">dispatch_sync</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">dispatch_get_main_queue</span><span style="color:#4271ae;">(), </span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">{
</span><span style="color:#4271ae;">      [_managedObjectContext mergeChangesFromContextDidSaveNotification:notification];
</span><span style="color:#4271ae;">     })</span><span>;
</span><span>}
</span></code></pre>
<p>è¿™ç§æ–¹å¼å®ç°èµ·æ¥å’Œç»´æŠ¤èµ·æ¥éƒ½æœ‰ç‚¹éº»çƒ¦ï¼Œæ‰€ä»¥ iOS 5 ä¸­å°±å‡ºç°äº†æ›´åŠ æ–¹ä¾¿å’Œçµæ´»çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯ã€ŒNested MOCã€ã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>[[NSManagedObjectContext </span><span style="color:#4271ae;">alloc</span><span>] initWithConcurrencyType</span><span style="color:#3e999f;">:</span><span>NSMainQueueConcurrencyType];
</span></code></pre>
<p>å¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥é€‰æ‹© ConcurrencyTypeï¼Œå¯é€‰çš„æœ‰ 3 ä¸ªï¼š</p>
<h3 id="nsconfinementconcurrencytype">NSConfinementConcurrencyType</h3>
<p>è¿™ä¸ªæ˜¯é»˜è®¤é¡¹ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªç‹¬ç«‹çš„ Contextï¼Œä¸»è¦æ˜¯ä¸ºäº†å…¼å®¹ä¹‹å‰çš„è®¾è®¡ã€‚</p>
<h3 id="nsprivatequeueconcurrencytype">NSPrivateQueueConcurrencyType</h3>
<p>åˆ›å»ºä¸€ä¸ª private queue(ä½¿ç”¨ GCD)ï¼Œè¿™æ ·å°±ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p>
<h3 id="nsmainqueueconcurrencytype">NSMainQueueConcurrencyType</h3>
<p>åˆ›å»ºä¸€ä¸ª main queueï¼Œä½¿ç”¨ä¸»çº¿ç¨‹ï¼Œä¼šé˜»å¡ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å˜åŒ–æ˜¯ MOC å¯ä»¥æŒ‡å®š parentã€‚æœ‰äº† parent åï¼ŒCUD æ“ä½œä¼šå†’æ³¡åˆ° parentã€‚ä¸€ä¸ª parent å¯ä»¥æœ‰å¤šä¸ª childã€‚parent è¿˜å¯ä»¥æœ‰ parentã€‚</p>
<p>å› ä¸º UI ç›¸å…³çš„æ•°æ®å¿…é¡»åœ¨ä¸»çº¿ç¨‹è·å–ï¼ŒåŒæ—¶åˆè¦é¿å…æ•°æ®åº“çš„ I/O æ“ä½œé˜»å¡ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸‹é¢è¿™ä¸ªæ¨¡å‹ï¼š</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;ios-multi-thread-core-data&#x2F;multi_thread_core_data_nested.png"
        width="511" /></p>
<p>æˆ‘å¯¹è¿™ç§å®ç°æ–¹å¼çš„ä¸€ä¸ªå›°æƒ‘æ˜¯ï¼šchild æ— æ³•å¾—çŸ¥ parent çš„å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ NSFetchedResultsController ç»‘å®šäº† Main MOCï¼Œå½“ Background Write MOC save æ—¶ï¼ŒNSFetchedResultsController ä¸ºä½•èƒ½çŸ¥æ™“ï¼Ÿæ±‚æŒ‡ç‚¹ã€‚</p>
<p>è¿™ç§æ–¹å¼æ¯”ã€ŒThread Confinementã€ç¨å¾®ç®€å•äº†ç‚¹ï¼Œä¹Ÿæ›´æ˜äº†ã€‚ä¸è¿‡ä¸ªäººè¿˜æ˜¯æ¨èä½¿ç”¨ MagicalRecordï¼Œå› ä¸ºå®ç°èµ·æ¥æ›´åŠ ç®€å•ï¼Œç­‰æœ‰ç©ºå†å†™ä¸€ç¯‡ã€‚</p>
<p>å†™äº†ä¸€ä¸ªä½¿ç”¨äº†è¿™ä¸ªæ¨¡å‹çš„ demoï¼Œé…åˆ TableView å’Œ NSFetchedResultsControllerï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹ï¼š<a href="https://github.com/limboy/coredata-with-tableview">https://github.com/limboy/coredata-with-tableview</a></p>
<h3 id="2013-06-17-geng-xin">2013/06/17 æ›´æ–°</h3>
<p>ä¹‹å‰çš„å›°æƒ‘å·²æ¶ˆé™¤ï¼Œ<code>NSFetchedResultsController</code>è·Ÿ PSC æ— å…³ï¼Œåªè¦ç»‘å®šçš„ MOC æœ‰äº†<code>save</code>åŠ¨ä½œï¼Œ<code>NSFetchedResultsController</code>å°±ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œæ— è®ºè¿™ä¸ª<code>save</code>æ“ä½œæœ‰æ²¡æœ‰å†™å…¥åˆ°æŒä¹…å±‚ã€‚</p>
<h3 id="can-kao">å‚è€ƒ</h3>
<ul>
<li><a href="http://www.cocoanetics.com/2012/07/multi-context-coredata/">http://www.cocoanetics.com/2012/07/multi-context-coredata/</a></li>
<li><a href="http://www.slideshare.net/Inferis/adventures-in-multithreaded-core-data">http://www.slideshare.net/Inferis/adventures-in-multithreaded-core-data</a></li>
</ul>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/ios/">iOS</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // éƒ½æ˜¯ä¸ºäº† iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>