<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <link rel="icon" href="https://fav.farm/ğŸ‘»" />
  <title>
åŸºäºAFNetworking2.0å’ŒRACçš„iOS REST Client
</title>
  <link rel="stylesheet" href="/assets/main.css?9zs&#x2F;BXhW+t7PNacyPraNbWdNoN&#x2F;V7G9VhdTj5z3mo8A=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/ios-rest-client-implementation/">

<meta name="twitter:title" content="åŸºäºAFNetworking2.0å’ŒRACçš„iOS REST Client">
<meta property="og:title" content="åŸºäºAFNetworking2.0å’ŒRACçš„iOS REST Client">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center bg-zinc-700 h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;ios-rest-client-implementation&#x2F;">åŸºäºAFNetworking2.0å’ŒRACçš„iOS REST Client</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2014-01-05</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <p>åœ¨å¼€å‘ iOS App æ—¶ç»å¸¸ä¼šé‡åˆ°è·Ÿåç«¯ REST API é€šä¿¡çš„æƒ…å†µã€‚è¿™å°±æ¶‰åŠåˆ°é”™è¯¯å¤„ç†ï¼ŒNSDictionary ä¸ Model çš„æ˜ å°„ï¼Œç”¨æˆ·ç™»å½•ä¸ç™»å‡ºï¼Œæƒé™éªŒè¯ï¼ŒArchive/UnArchiveï¼ŒCopyï¼ŒAccessToken è¿‡æœŸå¤„ç†ç­‰ç­‰ï¼Œå¦‚æœæ²¡æœ‰å¾ˆå¥½åœ°å¤„ç†è¿™äº›ç‚¹ï¼Œå°±å®¹æ˜“å‡ºç°ä»£ç å¤æ‚åº¦å¢å¤§ï¼Œç»“æ„æ•£ä¹±ï¼Œä¸æ–¹ä¾¿åæœŸç»´æŠ¤çš„ç°è±¡ã€‚</p>
<p>æ­£å¥½æœ€è¿‘åœ¨çœ‹ AFNetworking2.0 å’Œ ReactiveCocoa2.1ï¼Œå‚è€ƒäº† github çš„<a href="https://github.com/octokit/octokit.objc">octokit</a>ï¼Œé‡å†™äº†èŠ±ç“£çš„ iOS REST APIï¼Œåˆ†äº«äº›å¿ƒå¾—ã€‚</p>
<h3 id="ji-ben-jie-gou">åŸºæœ¬ç»“æ„</h3>
<pre data-lang="bash" style="background-color:#f9f9f9;color:#111111;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPAPI.h
</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> Classes
</span><span>	</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPAPIManager.h
</span><span>	</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPAPIManager.m
</span><span>	</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> Models
</span><span>		</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPObject.h
</span><span>		</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPObject.m
</span><span>		</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPUser.h
</span><span>		</span><span style="color:#3e999f;">|</span><span style="color:#c82728;">-</span><span style="color:#4271ae;"> HBPUser.m
</span><span>		</span><span style="color:#c82728;">...
</span></code></pre>
<p>ä½¿ç”¨æ—¶ï¼Œç›´æ¥å¼•ç”¨<code>HBPAPI.h</code>å³å¯ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰çš„ Classã€‚å› ä¸ºä½¿ç”¨äº† AFNetworking2.0ï¼Œæ‰€ä»¥ä¸å†æ˜¯ HBPClientï¼Œè€Œæ˜¯ HBPManagerã€‚ HBPAPIManager åŒ…å«äº†æ‰€æœ‰çš„è·ŸæœåŠ¡ç«¯é€šä¿¡çš„æ–¹æ³•ï¼Œé€šè¿‡ Category æ¥åŒºåˆ†ã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">#pragma mark </span><span>- HBPAPIManager (Private)
</span><span>
</span><span style="color:#8959a8;">@interface </span><span>HBPAPIManager (Private)
</span><span>
</span><span style="color:#8e908c;">// å†…éƒ¨ç»Ÿä¸€ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚
</span><span style="color:#8e908c;">//
</span><span style="color:#8e908c;">// resultClass - ä»æœåŠ¡ç«¯è·å–åˆ°JSONæ•°æ®åï¼Œä½¿ç”¨å“ªä¸ªClassæ¥å°†JSONè½¬æ¢ä¸ºOCçš„Model
</span><span style="color:#8e908c;">// listKey - å¦‚æœä¸æŒ‡å®šï¼Œè¡¨ç¤ºè¿”å›çš„æ˜¯ä¸€ä¸ªobjectï¼Œå¦‚userï¼Œå¦‚æœæŒ‡å®šè¡¨ç¤ºè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒlistKeyå°±è¡¨ç¤ºè¿™ä¸ªåˆ—è¡¨çš„keynameï¼Œå¦‚{&#39;users&#39;:[]}, é‚£ä¹ˆlistNameå°±ä¸º&#39;user&#39;
</span><span>- (RACSignal </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#4271ae;">requestWithMethod:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">method </span><span style="color:#4271ae;">relativePath:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">relativePath </span><span style="color:#4271ae;">parameters:</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">parameters </span><span style="color:#4271ae;">resultClass:</span><span>(</span><span style="color:#8959a8;">Class</span><span>)</span><span style="color:#f07219;">resultClass </span><span style="color:#4271ae;">listKey:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">listKey</span><span>;
</span><span style="color:#8959a8;">@end
</span><span>
</span><span>
</span><span style="color:#8959a8;">#pragma mark </span><span>- HBPAPIManager (User)
</span><span>
</span><span style="color:#8959a8;">@interface </span><span>HBPAPIManager (User)
</span><span>
</span><span style="color:#8e908c;">// signalä¼šsend userï¼Œå¦‚æœæ²¡æœ‰userï¼Œå°±ä¼šsendError
</span><span style="color:#8e908c;">// å¿…é¡»å½“å‰ç”¨æˆ·å·²ç»ç™»å½•çš„æƒ…å†µä¸‹è°ƒç”¨
</span><span>- (RACSignal </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#4271ae;">fetchUserInfo</span><span>;
</span><span>
</span><span style="color:#8e908c;">// ...
</span><span style="color:#8959a8;">@end
</span><span>
</span><span>
</span><span style="color:#8959a8;">#pragma mark </span><span>- HBPAPIManager (Friendship)
</span><span style="color:#8e908c;">// ...
</span></code></pre>
<p>Models Group åŒ…å«äº†æ‰€æœ‰è·ŸæœåŠ¡ç«¯ API å¯¹åº”çš„ Modelï¼Œæ¯”å¦‚<code>HBPComment</code></p>
<p>HBPComment.h</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&quot;HBPObject.h&quot;
</span><span>
</span><span style="color:#8959a8;">@class</span><span> HBPUser;
</span><span>
</span><span style="color:#8959a8;">@interface </span><span>HBPComment : </span><span style="color:#839c00;">HBPObject
</span><span style="color:#8959a8;">@property </span><span>(</span><span style="color:#8959a8;">nonatomic</span><span>, </span><span style="color:#8959a8;">assign</span><span>) </span><span style="color:#c99e00;">NSInteger</span><span> commentID;
</span><span style="color:#8959a8;">@property </span><span>(</span><span style="color:#8959a8;">nonatomic</span><span>, </span><span style="color:#8959a8;">copy</span><span>) </span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>createdAt;
</span><span style="color:#8959a8;">@property </span><span>(</span><span style="color:#8959a8;">nonatomic</span><span>, </span><span style="color:#8959a8;">strong</span><span>) HBPUser </span><span style="color:#3e999f;">*</span><span>user;
</span><span style="color:#8e908c;">//...
</span><span style="color:#8959a8;">@end
</span><span>
</span></code></pre>
<p>HBPComment.m</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&quot;HBPComment.h&quot;
</span><span>
</span><span style="color:#8959a8;">@implementation </span><span>HBPComment
</span><span>
</span><span>- (</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#4271ae;">JSONKeysToPropertyKeys
</span><span>{
</span><span>    </span><span style="color:#8959a8;">return</span><span> @{
</span><span>             </span><span style="color:#839c00;">@&quot;comment_id&quot;</span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;commentID&quot;</span><span>,
</span><span>             </span><span style="color:#839c00;">@&quot;user_id&quot;</span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;userID&quot;</span><span>,
</span><span>             </span><span style="color:#839c00;">@&quot;created_at&quot;</span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;createdAt&quot;</span><span>,
</span><span>			 </span><span style="color:#8e908c;">//...
</span><span>             };
</span><span>}
</span><span>
</span><span style="color:#8959a8;">@end
</span></code></pre>
<h3 id="archive-unarchive-copy">Archive / UnArchive / Copy</h3>
<p>æ¯ä¸€ä¸ª Object éƒ½è¦æ”¯æŒ Archive / UnArchive / Copyï¼Œä¹Ÿå°±æ˜¯è¦å®ç°<code>&lt;NSCoding&gt;</code>å’Œ<code>&lt;NSCopying&gt;</code>åè®®ï¼Œè¿™ä¸¤ä¸ªåè®®çš„å†…å®¹å…¶å®å°±æ˜¯å¯¹ Object çš„ Property åšäº›å¤„ç†ï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥åœ¨åŸºç±»é‡ŒæŠŠè¿™äº›äº‹éƒ½ç»Ÿä¸€å¤„ç†ï¼Œå°±ä¼šæ–¹ä¾¿è®¸å¤šã€‚octokit ä½¿ç”¨<a href="https://github.com/MantleFramework/Mantle">Mantle</a>æ¥åšè¿™äº›äº‹æƒ…ï¼Œä¸è¿‡æˆ‘è§‰å¾— Mantle è¿˜æ˜¯æœ‰äº›éº»çƒ¦ï¼Œäºæ˜¯å†™äº†ä¸ªé€šè¿‡è¿è¡Œæ—¶æ¥è·å– propertyï¼Œå¹¶å®ç°<code>&lt;NSCoding&gt;</code> å’Œ <code>&lt;NSCopying&gt;</code>çš„åŸºç±»ï¼Œåªæœ‰ä¸¤ä¸ªå…¬å…±æ–¹æ³•ï¼š</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">#import </span><span style="color:#839c00;">&lt;Foundation/Foundation.h&gt;
</span><span>
</span><span style="color:#8959a8;">@interface </span><span>HBPObject : </span><span style="color:#839c00;">NSObject </span><span>&lt;NSCopying, NSCoding&gt;
</span><span>
</span><span style="color:#8e908c;">// è§£æAPIè¿”å›çš„JSONï¼Œè¿”å›å¯¹åº”çš„Model
</span><span>- (</span><span style="color:#8959a8;">id</span><span>)</span><span style="color:#4271ae;">initWithDictionary:</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">JSON</span><span>;
</span><span>
</span><span style="color:#8e908c;">// JSON keyåˆ°propertyçš„æ˜ å°„å…³ç³»
</span><span>- (</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#4271ae;">JSONKeysToPropertyKeys</span><span>;
</span><span style="color:#8959a8;">@end
</span></code></pre>
<p>å…¶ä¸­<code>- (id)initWithDictionary:(NSDictionary *)JSON</code>çš„ä½œç”¨æ˜¯éå† Object çš„ Propertyï¼Œå¦‚æœ Property çš„ Class æ˜¯<code>HBPObject</code>ï¼Œé‚£ä¹ˆå°±è°ƒç”¨<code>- (id)initWithDictionary:(NSDictionary *)JSO</code>ï¼Œä¸ç„¶å°±é€šè¿‡ KVC çš„<code>setValue:forKey:</code>æ¥è®¾å®šå€¼ã€‚</p>
<p><code>- (NSDictionary *)JSONKeysToPropertyKeys</code>çš„å†…å®¹å¤§æ¦‚æ˜¯è¿™æ ·ï¼š</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)JSONKeysToPropertyKeys
</span><span>{
</span><span>    </span><span style="color:#8959a8;">return</span><span> @{
</span><span>             </span><span style="color:#839c00;">@&quot;id&quot;</span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;ID&quot;</span><span>,
</span><span>             </span><span style="color:#839c00;">@&quot;nav_link&quot;</span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;navLink&quot;</span><span>,
</span><span>             };
</span><span>}
</span></code></pre>
<p>è¿™æ ·é€šè¿‡ä¸€ä¸ª<code>HBPObject</code>åŸºç±»å°±å®Œæˆäº† Archive / UnArchive / Copy ã€‚</p>
<h3 id="yong-hu-de-deng-lu-yu-deng-chu">ç”¨æˆ·çš„ç™»å½•ä¸ç™»å‡º</h3>
<p>å…ˆæ¥è¯´è¯´ç™»å½•ï¼Œç”±äºä½¿ç”¨ RACï¼Œåœ¨æ„é€  API æ—¶ï¼Œå°±ä¸éœ€è¦ä¼ å…¥ Block äº†ï¼Œéšä¹‹è€Œæ¥çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦åœ¨æ³¨é‡Šä¸­è¯´æ˜<code>sendNext</code>æ—¶ä¼šå‘é€ä»€ä¹ˆå†…å®¹ã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">+ </span><span>(RACSignal </span><span style="color:#3e999f;">*</span><span>)signInUsingUsername</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)username passowrd</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)password
</span><span>{
</span><span>    NSAssert(API_CLIENT_ID </span><span style="color:#3e999f;">&amp;&amp;</span><span> API_CLIENT_SECRET, </span><span style="color:#839c00;">@&quot;API_CLIENT_ID and API_CLIENT_SECRET must be setted&quot;</span><span>);
</span><span>    </span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>parameters </span><span style="color:#3e999f;">=</span><span> @{
</span><span>                                 </span><span style="color:#839c00;">@&quot;grant_type&quot;</span><span style="color:#3e999f;">: </span><span style="color:#839c00;">@&quot;password&quot;</span><span>,
</span><span>                                 </span><span style="color:#839c00;">@&quot;username&quot;</span><span style="color:#3e999f;">:</span><span> username,
</span><span>                                 </span><span style="color:#839c00;">@&quot;password&quot;</span><span style="color:#3e999f;">:</span><span> password,
</span><span>                                 };
</span><span>    HBPAPIManager </span><span style="color:#3e999f;">*</span><span>manager </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">createManager</span><span>];
</span><span>
</span><span>    </span><span style="color:#8959a8;">return </span><span>[[manager </span><span style="color:#4271ae;">fetchTokenWithParameters:parameters</span><span>]
</span><span>            setNameWithFormat</span><span style="color:#3e999f;">:</span><span style="color:#839c00;">@&quot;+signInUsingUsername:</span><span>%@</span><span style="color:#839c00;"> password:</span><span>%@</span><span style="color:#839c00;">&quot;</span><span>, username, password];
</span><span>}
</span></code></pre>
<p>çœ‹ç€è¿˜æŒºç®€å•çš„å§ï¼Œå› ä¸ºä¸»è¦å·¥ä½œéƒ½æ˜¯<code>+fetchMoreData:parameters</code>åœ¨åšï¼Œçœ‹çœ‹å®ƒçš„å®ç°</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(RACSignal </span><span style="color:#3e999f;">*</span><span>)fetchTokenWithParameters</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)parameters
</span><span>{
</span><span>    </span><span style="color:#8959a8;">return </span><span>[[[[[[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">rac_POST:</span><span style="color:#839c00;">@&quot;oauth/access_token&quot; </span><span style="color:#4271ae;">parameters:parameters</span><span>]
</span><span>             </span><span style="color:#8e908c;">// reduceEachçš„ä½œç”¨æ˜¯ä¼ å…¥å¤šä¸ªå‚æ•°ï¼Œè¿”å›å•ä¸ªå‚æ•°ï¼Œæ˜¯åŸºäº`map`çš„ä¸€ç§å®ç°
</span><span>             reduceEach</span><span style="color:#3e999f;">:^</span><span style="color:#8959a8;">id</span><span>(AFHTTPRequestOperation </span><span style="color:#3e999f;">*</span><span>operation, </span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>response){
</span><span>			     </span><span style="color:#8e908c;">// æ‹¿åˆ°tokenåï¼Œå°±è®¾ç½®token property
</span><span>				 </span><span style="color:#8e908c;">// setToken:æ–¹æ³•ä¼šè¢«è§¦å‘ï¼Œåœ¨é‚£é‡Œä¼šè®¾ç½®è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼Œå¦‚Authorizationã€‚
</span><span>                 HBPAccessToken </span><span style="color:#3e999f;">*</span><span>token </span><span style="color:#3e999f;">= </span><span>[[HBPAccessToken </span><span style="color:#4271ae;">alloc</span><span>] initWithDictionary</span><span style="color:#3e999f;">:</span><span>response];
</span><span>                 </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">token </span><span style="color:#3e999f;">=</span><span> token;
</span><span>                 </span><span style="color:#8959a8;">return </span><span style="color:#c82728;">self</span><span>;
</span><span>             }]
</span><span>             catch</span><span style="color:#3e999f;">:^</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>(</span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span>error) {
</span><span>			     </span><span style="color:#8e908c;">// å¯¹Errorè¿›è¡Œå¤„ç†ï¼Œæ–¹ä¾¿å¤–éƒ¨è¯†åˆ«
</span><span>                 </span><span style="color:#c99e00;">NSInteger</span><span> code </span><span style="color:#3e999f;">=</span><span> error.</span><span style="color:#c82728;">code </span><span style="color:#3e999f;">== -</span><span style="color:#f07219;">1001 </span><span style="color:#3e999f;">?</span><span> HBPAPIManagerErrorConnectionFailed </span><span style="color:#3e999f;">:</span><span> HBPAPIManagerErrorAuthenticatedFailed;
</span><span>                 </span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span>apiError </span><span style="color:#3e999f;">= </span><span>[[</span><span style="color:#c99e00;">NSError </span><span style="color:#4271ae;">alloc</span><span>] initWithDomain</span><span style="color:#3e999f;">:</span><span>HBPAPIManagerErrorDomain code</span><span style="color:#3e999f;">:</span><span>code userInfo</span><span style="color:#3e999f;">:</span><span style="color:#f07219;">nil</span><span>];
</span><span>                 </span><span style="color:#8959a8;">return </span><span>[RACSignal </span><span style="color:#4271ae;">error:apiError</span><span>];
</span><span>             }]
</span><span>             then</span><span style="color:#3e999f;">:^</span><span>RACSignal </span><span style="color:#3e999f;">*</span><span>{
</span><span>			     </span><span style="color:#8e908c;">// ä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œé¡ºä¾¿è·å–ç”¨æˆ·ä¿¡æ¯
</span><span>                 </span><span style="color:#8959a8;">return </span><span>[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">fetchUserInfo</span><span>];
</span><span>             }]
</span><span>             doNext</span><span style="color:#3e999f;">:^</span><span>(HBPUser </span><span style="color:#3e999f;">*</span><span>user) {
</span><span>			     </span><span style="color:#8e908c;">// doNextç›¸å½“äºä¸€ä¸ªé’©å­ï¼Œæ˜¯åœ¨sendNextæ—¶ä¼šè¢«æ‰§è¡Œçš„ä¸€æ®µä»£ç 
</span><span>                 </span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">user </span><span style="color:#3e999f;">=</span><span> user;
</span><span>             }]
</span><span>			 </span><span style="color:#8e908c;">// æŠŠå‘é€å†…å®¹æ¢æˆself
</span><span>             mapReplace</span><span style="color:#3e999f;">:</span><span style="color:#c82728;">self</span><span>]
</span><span>			 </span><span style="color:#8e908c;">// é¿å…side effect
</span><span>             replayLazily];
</span><span>}
</span></code></pre>
<p>è¿™é‡Œå¯¹ signal è¿›è¡Œäº† chain / modify / hook ç­‰æ“ä½œï¼Œä¸»è¦ä½œç”¨æ˜¯è·å– access token å’Œç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>ç”¨æˆ·çš„ç™»å‡ºå°±ç®€å•äº†ï¼Œç›´æ¥è®¾ç½®<code>user</code>å’Œ<code>token</code>ä¸º<code>nil</code>å°±è¡Œäº†ã€‚</p>
<h3 id="she-zhi-chao-shi-shi-jian-he-huan-cun-ce-lue">è®¾ç½®è¶…æ—¶æ—¶é—´å’Œç¼“å­˜ç­–ç•¥</h3>
<p>å› ä¸º AF2.0 ä½¿ç”¨äº†æ–°çš„æ¶æ„ï¼Œå¯¼è‡´è¦è®¾ç½® Request çš„è¶…æ—¶å’Œç¼“å­˜ç¨å¾®æœ‰äº›éº»çƒ¦ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ªç»§æ‰¿è‡ª<code>AFHTTPRequestSerializer</code>çš„ Class</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">@interface </span><span>HBPAPIRequestSerializer : </span><span style="color:#839c00;">AFHTTPRequestSerializer </span><span style="color:#8959a8;">@end
</span><span>
</span><span style="color:#8959a8;">@implementation </span><span>HBPAPIRequestSerializer
</span><span>
</span><span>- (</span><span style="color:#c99e00;">NSMutableURLRequest </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#4271ae;">requestWithMethod:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">method </span><span style="color:#4271ae;">URLString:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">URLString </span><span style="color:#4271ae;">parameters:</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">parameters
</span><span>{
</span><span>    </span><span style="color:#c99e00;">NSMutableURLRequest </span><span style="color:#3e999f;">*</span><span>request </span><span style="color:#3e999f;">= </span><span>[</span><span style="color:#c82728;">super </span><span style="color:#4271ae;">requestWithMethod:method URLString:URLString parameters:parameters</span><span>];
</span><span>    request.</span><span style="color:#c82728;">timeoutInterval </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">10</span><span>;
</span><span>    request.</span><span style="color:#c82728;">cachePolicy </span><span style="color:#3e999f;">=</span><span> NSURLRequestReloadIgnoringLocalCacheData;
</span><span>    </span><span style="color:#8959a8;">return</span><span> request;
</span><span>}
</span><span>
</span><span style="color:#8959a8;">@end
</span></code></pre>
<p>ç„¶åå°†è¿™ä¸ª class è®¾ç½®ä¸º manager.requestSerializer</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span>HBPAPIManager </span><span style="color:#3e999f;">*</span><span>manager </span><span style="color:#3e999f;">= </span><span>[[HBPAPIManager </span><span style="color:#4271ae;">alloc</span><span>] initWithBaseURL</span><span style="color:#3e999f;">:</span><span>[</span><span style="color:#c99e00;">NSURL </span><span style="color:#4271ae;">URLWithString:API_SERVER</span><span>]];
</span><span>manager.</span><span style="color:#c82728;">requestSerializer </span><span style="color:#3e999f;">= </span><span>[HBPAPIRequestSerializer </span><span style="color:#4271ae;">serializer</span><span>];
</span></code></pre>
<p>è¿™æ ·å°±è¡Œäº†</p>
<h3 id="quan-xian-yan-zheng">æƒé™éªŒè¯</h3>
<p>è¿™ä¸ªæ¯”è¾ƒç®€å•äº›ï¼Œç›´æ¥åœ¨æ–¹æ³•é‡Œé¢åŠ ä¸Šåˆ¤æ–­</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(RACSignal </span><span style="color:#3e999f;">*</span><span>)createCommentWithPinID</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSInteger</span><span>)pinID text</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)text
</span><span>{
</span><span>    </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#3e999f;">!</span><span style="color:#c82728;">self</span><span>.</span><span style="color:#c82728;">isAuthenticated</span><span>) </span><span style="color:#8959a8;">return </span><span>[RACSignal </span><span style="color:#4271ae;">error:[</span><span style="color:#c82728;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">class</span><span style="color:#4271ae;"> authenticatedError]</span><span>];
</span><span>
</span><span>    </span><span style="color:#8959a8;">return </span><span>[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">requestWithMethod:</span><span style="color:#839c00;">@&quot;POST&quot; </span><span style="color:#4271ae;">relativePath:[</span><span style="color:#c99e00;">NSString </span><span style="color:#4271ae;">stringWithFormat:</span><span style="color:#839c00;">@&quot;pins/</span><span>%d</span><span style="color:#839c00;">/comments&quot;</span><span style="color:#4271ae;">, pinID] parameters:@{</span><span style="color:#839c00;">@&quot;text&quot;</span><span style="color:#3e999f;">:</span><span style="color:#4271ae;"> text} resultClass:[HBPComment class] listKey:</span><span style="color:#839c00;">@&quot;comment&quot;</span><span>];
</span><span>}
</span></code></pre>
<h3 id="accesstoken-guo-qi-de-chu-li">AccessToken è¿‡æœŸçš„å¤„ç†</h3>
<p>AccessToken è¿‡æœŸå’Œè·å–æ–°çš„ AccessToken å¯ä»¥äº¤ç»™ä½¿ç”¨è€…æ¥åšï¼Œä½†æ˜¯ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯è¿‡æœŸåè‡ªåŠ¨å»è·å–æ–°çš„ AccessTokenï¼Œæ‹¿åˆ° Token åè‡ªåŠ¨å»æ‰§è¡Œä¹‹å‰å¤±è´¥çš„è¯·æ±‚ï¼Œè¿™å—æˆ‘æ˜¯è¿™ä¹ˆå¤„ç†çš„</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(RACSignal </span><span style="color:#3e999f;">*</span><span>)requestWithMethod</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)method relativePath</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)relativePath parameters</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)parameters resultClass</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#8959a8;">Class</span><span>)resultClass listKey</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSString </span><span style="color:#3e999f;">*</span><span>)listKey
</span><span>{
</span><span>    RACSignal </span><span style="color:#3e999f;">*</span><span>requestSignal;
</span><span>	</span><span style="color:#8e908c;">// create requestSignal
</span><span>	</span><span style="color:#8e908c;">// ...
</span><span>
</span><span>	</span><span style="color:#8959a8;">return </span><span>[requestSignal </span><span style="color:#4271ae;">catch:</span><span style="color:#3e999f;">^</span><span style="color:#4271ae;">RACSignal </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">(</span><span style="color:#c99e00;">NSError </span><span style="color:#3e999f;">*</span><span style="color:#4271ae;">error) {
</span><span style="color:#4271ae;">        </span><span style="color:#8959a8;">if </span><span style="color:#4271ae;">(error.</span><span style="color:#c82728;">code </span><span style="color:#3e999f;">==</span><span style="color:#4271ae;"> HBPAPIManagerErrorInvalidAccessToken) {
</span><span style="color:#4271ae;">            </span><span style="color:#8959a8;">return </span><span style="color:#4271ae;">[[[</span><span style="color:#c82728;">self </span><span style="color:#4271ae;">refreshToken] ignoreValues] concat</span><span style="color:#3e999f;">:</span><span style="color:#4271ae;">requestSignal];
</span><span style="color:#4271ae;">        }
</span><span style="color:#4271ae;">        </span><span style="color:#8959a8;">return </span><span style="color:#4271ae;">[RACSignal error:error];
</span><span style="color:#4271ae;">    }</span><span>];
</span><span>}
</span></code></pre>
<h3 id="hbpobject-subclass">HBPObject SubClass</h3>
<p>é‚£äº›ç»§æ‰¿è‡ª<code>HBPObject</code>çš„å­ç±»ï¼Œæœ‰äº›äº‹æƒ…æ˜¯<code>HBPObject</code>æ— æ³•å¤„ç†çš„ï¼Œæ¯”å¦‚ NSArray çš„ Propertyï¼Œå› ä¸º Objective-C ä¸æ”¯æŒ genericï¼Œæ‰€ä»¥æ— æ³•çŸ¥é“è¿™ä¸ªæ•°ç»„åŒ…å«çš„ç©¶ç«Ÿæ˜¯æ€æ ·çš„ Classï¼Œè¿™æ—¶å°±éœ€è¦åœ¨å­ç±»å¯¹è¿™äº› property åšå¤„ç†ã€‚</p>
<p>æ¯”å¦‚ç”»æ¿(HBPBoard)æœ‰ä¸€ä¸ªå«<code>pins</code>çš„ NSArray å±æ€§ï¼Œå› ä¸ºåœ¨<code>HBPObject</code>ä¸­ä½¿ç”¨äº† KVCï¼Œæ‰€ä»¥å¦‚æœå­ç±»æœ‰ç±»ä¼¼<code>setXXX:</code>çš„æ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå°±å¯ä»¥å¤„ç†é‚£äº›ç‰¹æ®Šæƒ…å†µã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#8959a8;">@implementation </span><span>HBPBoard
</span><span>
</span><span>- (</span><span style="color:#8959a8;">void</span><span>)</span><span style="color:#4271ae;">setPins:</span><span>(</span><span style="color:#c99e00;">NSArray </span><span style="color:#3e999f;">*</span><span>)</span><span style="color:#f07219;">pins
</span><span>{
</span><span>    _pins </span><span style="color:#3e999f;">= </span><span>[[pins.</span><span style="color:#c82728;">rac_sequence</span><span> map</span><span style="color:#3e999f;">:^</span><span style="color:#8959a8;">id</span><span>(</span><span style="color:#8959a8;">id </span><span>value) {
</span><span>        </span><span style="color:#8959a8;">return </span><span>[[HBPPin </span><span style="color:#4271ae;">alloc</span><span>] initWithDictionary</span><span style="color:#3e999f;">:</span><span>value];
</span><span>    }] array];
</span><span>}
</span><span>
</span><span style="color:#8959a8;">@end
</span></code></pre>
<p>å†æ¯”å¦‚ï¼Œè¿”å›çš„ JSON å†…å®¹ä¸­ï¼Œæœ‰ä¸€ä¸ªå«<code>content</code>çš„ keyï¼Œå…¶ä¸­æœ‰ type / date / color ç­‰ sub keyï¼Œè€Œä½ åªæƒ³è¦<code>type</code>ä¿¡æ¯ï¼Œåªéœ€æ·»åŠ ä¸€ä¸ª<code>type</code> propertyï¼Œç„¶ååœ¨<code>setContent</code>æ—¶ï¼Œè®¾ç½®ä¸€ä¸‹<code>type</code>å³å¯ã€‚</p>
<pre data-lang="m" style="background-color:#f9f9f9;color:#111111;" class="language-m "><code class="language-m" data-lang="m"><span style="color:#3e999f;">- </span><span>(</span><span style="color:#8959a8;">void</span><span>)setContent</span><span style="color:#3e999f;">:</span><span>(</span><span style="color:#c99e00;">NSDictionary </span><span style="color:#3e999f;">*</span><span>)content
</span><span>{
</span><span>    _type </span><span style="color:#3e999f;">=</span><span> content[</span><span style="color:#839c00;">@&quot;type&quot;</span><span>];
</span><span>}
</span></code></pre>
<hr />
<p>ä»¥ä¸Šå°±æ˜¯æˆ‘åœ¨ä½¿ç”¨ AFNetworking2.0 å’Œ ReactiveCocoa2.1 æ„å»º iOS REST Client æ—¶çš„ä¸€äº›å°å¿ƒå¾—ï¼Œç¡®å®èƒ½æ„Ÿè§‰åˆ° RAC å¸¦äº†ä¸å°‘æ–¹ä¾¿ï¼Œè™½ç„¶ä¹ŸåŒæ—¶å¸¦æ¥äº†ä¸€äº›å¼Šç«¯ï¼ˆå¦‚è¿”å›çš„å†…å®¹ä¸æ˜ç¡®ï¼Œå­¦ä¹ æˆæœ¬é«˜ï¼‰ï¼Œä½†è¿˜æ˜¯åˆ©å¤§äºå¼Šã€‚</p>
<p>æœ‰ä»€ä¹ˆé—®é¢˜å’Œæƒ³æ³•ï¼Œæ¬¢è¿äº¤æµã€‚</p>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/ios/">iOS</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // éƒ½æ˜¯ä¸ºäº† iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>