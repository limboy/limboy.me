<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <link rel="icon" href="https://fav.farm/ğŸ‘»" />
  <title>
php çš„å¤šè¿›ç¨‹
</title>
  <link rel="stylesheet" href="/assets/main.css?6&#x2F;2ShUT3RYeReiJdlrDhZN+03rWSUD7DPccwza9UdPM=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/php-process-control/">

<meta name="twitter:title" content="php çš„å¤šè¿›ç¨‹">
<meta property="og:title" content="php çš„å¤šè¿›ç¨‹">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center opacity-80 bg-black h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;php-process-control&#x2F;">php çš„å¤šè¿›ç¨‹</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2010-08-27</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <p>ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ PHP è‡ªå¸¦çš„ pcntl_*å‡½æ•°(ä»…é™ linux)ï¼Œå¦ä¸€ç§å°±æ˜¯ä½¿ç”¨ popen/proc_openï¼Œç„¶ååœ¨ php å†…éƒ¨æ§åˆ¶è¿›ç¨‹æ•°é‡ã€‚</p>
<h3 id="shi-yong-pcntl-han-shu">ä½¿ç”¨ pcntl_*å‡½æ•°</h3>
<p>PHP æä¾›äº†ä¸€ç³»åˆ—çš„ pcntl_*å‡½æ•°ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ process control functionsï¼Œä¸“é—¨ç”¨æ¥ç®¡ç†è¿›ç¨‹çš„ã€‚æœ€å¸¸ç”¨çš„å°±æ˜¯ pcntl_fork å’Œ pcntl_waitã€‚</p>
<p>pcntl_fork çš„ä½œç”¨å°±æ˜¯ä»å½“å‰çš„è¿›ç¨‹å†æ´¾ç”Ÿå‡ºä¸€ä¸ªå­è¿›ç¨‹ã€‚pcntl_wait çš„ä½œç”¨æ˜¯æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°ä¸€ä¸ªå­è¿›ç¨‹ä¸­æ­¢ã€‚</p>
<pre data-lang="php" style="background-color:#f9f9f9;color:#111111;" class="language-php "><code class="language-php" data-lang="php"><span style="color:#f07219;">&lt;?php
</span><span style="color:#8e908c;">//é…åˆpcntl_signalä½¿ç”¨
</span><span style="color:#8959a8;">declare</span><span>(ticks</span><span style="color:#3e999f;">=</span><span style="color:#f07219;">1</span><span>);
</span><span style="color:#8e908c;">//æœ€å¤§çš„å­è¿›ç¨‹æ•°é‡
</span><span style="color:#c82728;">$max </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">5</span><span>;
</span><span style="color:#8e908c;">//å½“å‰çš„å­è¿›ç¨‹æ•°é‡
</span><span style="color:#c82728;">$child </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span>;
</span><span>
</span><span style="color:#8e908c;">//å½“å­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œä¼šè§¦å‘è¯¥å‡½æ•°
</span><span style="color:#8959a8;">function </span><span style="color:#4271ae;">sig_handler</span><span>(</span><span style="color:#f07219;">$sig</span><span>) {
</span><span>	</span><span style="color:#8959a8;">global </span><span style="color:#c82728;">$child</span><span>;
</span><span>	</span><span style="color:#8959a8;">switch</span><span>(</span><span style="color:#c82728;">$sig</span><span>) {
</span><span>		</span><span style="color:#8959a8;">case </span><span>SIGCHLD:
</span><span>			</span><span style="color:#4271ae;">echo </span><span style="color:#839c00;">&#39;SIGCHLD received&#39;</span><span style="color:#3e999f;">.</span><span style="color:#839c00;">&quot;</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;</span><span>;
</span><span>			</span><span style="color:#c82728;">$child</span><span style="color:#3e999f;">--</span><span>;
</span><span>	}
</span><span>}
</span><span>
</span><span style="color:#8e908c;">//æ³¨å†Œå­è¿›ç¨‹é€€å‡ºæ—¶è°ƒç”¨çš„å‡½æ•°
</span><span style="color:#4271ae;">pcntl_signal(</span><span>SIGCHLD</span><span style="color:#4271ae;">, </span><span style="color:#839c00;">&quot;sig_handler&quot;</span><span style="color:#4271ae;">)</span><span>;
</span><span>
</span><span style="color:#8959a8;">while</span><span>(</span><span style="color:#f07219;">true</span><span>) {
</span><span>	</span><span style="color:#c82728;">$child</span><span style="color:#3e999f;">++</span><span>;
</span><span>	</span><span style="color:#8e908c;">/**
</span><span style="color:#8e908c;">	 * è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªä¸º0ï¼Œè¡¨ç¤ºå­è¿›ç¨‹ï¼›ä¸€ä¸ªä¸ºæ­£æ•´æ•°è¡¨ç¤ºå­è¿›ç¨‹çš„id
</span><span style="color:#8e908c;">	 * æ‰€ä»¥ifå’Œelseé‡Œçš„ä¸¤æ®µä»£ç éƒ½ä¼šæ‰§è¡Œ
</span><span style="color:#8e908c;">	 * ifé‡Œçš„ä»£ç æ˜¯çˆ¶è¿›ç¨‹æ‰§è¡Œçš„
</span><span style="color:#8e908c;">	 * elseé‡Œçš„ä»£ç æ˜¯å­è¿›ç¨‹æ‰§è¡Œçš„
</span><span style="color:#8e908c;">	 */
</span><span>	</span><span style="color:#c82728;">$pid </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">pcntl_fork()</span><span>;
</span><span>	</span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">$pid</span><span>) {
</span><span>		</span><span style="color:#8e908c;">//è¿™é‡Œæ˜¯çˆ¶è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
</span><span>		</span><span style="color:#8e908c;">//å¦‚æœå­è¿›ç¨‹æ•°è¶…è¿‡äº†æœ€å¤§å€¼ï¼Œåˆ™æŒ‚èµ·çˆ¶è¿›ç¨‹
</span><span>		</span><span style="color:#8e908c;">//ä¹Ÿå°±æ˜¯è¯´whileè¯­å¥ä¸ä¼šç»§ç»­æ‰§è¡Œ
</span><span>		</span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">$child </span><span style="color:#3e999f;">&gt;= </span><span style="color:#c82728;">$max</span><span>) {
</span><span>			</span><span style="color:#4271ae;">pcntl_wait(</span><span style="color:#c82728;">$status</span><span style="color:#4271ae;">)</span><span>;
</span><span>		}
</span><span>	}
</span><span>	</span><span style="color:#8959a8;">else </span><span>{
</span><span>		</span><span style="color:#8e908c;">//è¿™é‡Œæ˜¯å­è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
</span><span>		</span><span style="color:#8e908c;">//å¦‚æœè¦æ‰§è¡Œå…¶ä»–å‘½ä»¤çš„è¯ï¼Œä½¿ç”¨pcntl_exec
</span><span>		</span><span style="color:#4271ae;">echo </span><span style="color:#839c00;">&quot;starting new child | now we have </span><span style="color:#c82728;">$child</span><span style="color:#839c00;"> child process</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;</span><span>;
</span><span>		</span><span style="color:#4271ae;">sleep(rand(</span><span style="color:#f07219;">3</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">5</span><span style="color:#4271ae;">))</span><span>;
</span><span>		</span><span style="color:#8959a8;">exit</span><span>;
</span><span>	}
</span><span>}
</span></code></pre>
<p>ä¸Šé¢è¿™æ®µä»£ç å°±æ˜¯ä¿è¯æœ‰ 5 ä¸ªå­è¿›ç¨‹ä¸€ç›´åœ¨å¹²æ´»ï¼Œå¦‚æœ$childæ•°é‡å¤§äº$maxï¼Œå°±ç­‰å­è¿›ç¨‹ç»“æŸåå†ç»§ç»­è¿è¡Œã€‚å­è¿›ç¨‹ç»“æŸåä¼šè°ƒç”¨ sig_handler å‡½æ•°ï¼Œsig_handler ä¼šå°†$child æ•°é‡å‡ 1ï¼Œé‚£è¾¹ while ç»§ç»­æ‰§è¡Œã€‚</p>
<h3 id="shi-yong-popen-proc-open">ä½¿ç”¨ popen/proc_open</h3>
<p>popen ä¼šåˆ›å»ºä¸€ä¸ªç®¡é“æ¥è¿æ¥è¯¥è¿›ç¨‹ï¼Œç„¶åä½¿ç”¨ fread/fgets/stream_get_contents æ¥è¯»å–è¯¥è¿›ç¨‹è¿”å›çš„ç»“æœã€‚è·Ÿ exec æˆ– system ä¹‹ç±»çš„å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œexec ä¼šç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œå†è¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œä½† popen ä¸ä¼šã€‚proc_open åˆæ›´åŠ å¼ºå¤§ä¸€äº›ï¼Œæ”¯æŒ stdin å’Œ stdoutï¼Œè·¯å¾„è®¾ç½®ç­‰ç­‰ã€‚</p>
<p>å› ä¸ºè¿™äº›å‡½æ•°åªè´Ÿè´£åˆ›å»ºï¼Œæ²¡æœ‰ç›¸åº”çš„ç®¡ç†æ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½åœ¨ PHP æ–‡ä»¶å†…éƒ¨è‡ªå·±æ¥å®ç°ã€‚
demo(å¼•ç”¨è‡ªå¼ å®´â€”â€”<a href="http://blog.s135.com/post/311/">PHP å¤šè¿›ç¨‹å¹¶å‘æ§åˆ¶çš„æµ‹è¯•ç”¨ä¾‹</a>)</p>
<pre data-lang="php" style="background-color:#f9f9f9;color:#111111;" class="language-php "><code class="language-php" data-lang="php"><span style="color:#f07219;">&lt;?php
</span><span style="color:#8959a8;">function </span><span style="color:#4271ae;">run</span><span>(</span><span style="color:#f07219;">$input</span><span>)
</span><span>{
</span><span>    </span><span style="color:#8959a8;">global </span><span style="color:#c82728;">$p_number</span><span>;
</span><span>    </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">&lt;= </span><span style="color:#f07219;">0</span><span>)
</span><span>    {
</span><span>        </span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">worker_processes</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">$p_number</span><span style="color:#4271ae;">)</span><span>;
</span><span>    }
</span><span>    </span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">- </span><span style="color:#f07219;">1</span><span>;
</span><span>    </span><span style="color:#c82728;">$out </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">popen(</span><span style="color:#839c00;">&quot;/bin/sh /opt/zhangyan.sh </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">{</span><span style="color:#c82728;">$input</span><span style="color:#839c00;">}</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;"> &amp;&quot;</span><span style="color:#4271ae;">, </span><span style="color:#839c00;">&quot;r&quot;</span><span style="color:#4271ae;">)</span><span>;
</span><span>    </span><span style="color:#4271ae;">pclose(</span><span style="color:#c82728;">$out</span><span style="color:#4271ae;">)</span><span>;
</span><span>}
</span><span>
</span><span style="color:#8959a8;">function </span><span style="color:#4271ae;">worker_processes</span><span>(</span><span style="color:#f07219;">$p_number</span><span>)
</span><span>{
</span><span>    </span><span style="color:#c82728;">$limit </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">500</span><span>;</span><span style="color:#8e908c;">//å…è®¸æ¨åˆ°åå°çš„æœ€å¤§è¿›ç¨‹æ•°
</span><span>    </span><span style="color:#8959a8;">while </span><span>(</span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">&lt;= </span><span style="color:#f07219;">0</span><span>)
</span><span>    {
</span><span>        </span><span style="color:#c82728;">$cmd </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">popen(</span><span style="color:#839c00;">&quot;ps -ef | grep </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">/opt/zhangyan.sh</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;"> | grep -v grep | wc -l&quot;</span><span style="color:#4271ae;">, </span><span style="color:#839c00;">&quot;r&quot;</span><span style="color:#4271ae;">)</span><span>;
</span><span>        </span><span style="color:#c82728;">$line </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">fread(</span><span style="color:#c82728;">$cmd</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">512</span><span style="color:#4271ae;">)</span><span>;
</span><span>        </span><span style="color:#4271ae;">pclose(</span><span style="color:#c82728;">$cmd</span><span style="color:#4271ae;">)</span><span>;
</span><span>        </span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">$limit </span><span style="color:#3e999f;">- </span><span style="color:#c82728;">$line</span><span>;
</span><span>        </span><span style="color:#8959a8;">if </span><span>(</span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">&lt;= </span><span style="color:#f07219;">0</span><span>)
</span><span>        {
</span><span>            </span><span style="color:#4271ae;">sleep(</span><span style="color:#f07219;">1</span><span style="color:#4271ae;">)</span><span>;</span><span style="color:#8e908c;">//æš‚åœ1ç§’é’Ÿ
</span><span>        }
</span><span>    }
</span><span>    </span><span style="color:#8959a8;">return </span><span style="color:#c82728;">$p_number</span><span>;
</span><span>}
</span><span>
</span><span style="color:#c82728;">$input </span><span style="color:#3e999f;">= </span><span style="color:#839c00;">&quot;http://blog.s135.com&quot;</span><span>; </span><span style="color:#8e908c;">//æ¨¡æ‹Ÿä»é˜Ÿåˆ—æ–‡ä»¶ä¸­è¯»å–åˆ°çš„æ•°æ®
</span><span style="color:#8959a8;">for </span><span>(</span><span style="color:#c82728;">$i </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">1</span><span>; </span><span style="color:#c82728;">$i </span><span style="color:#3e999f;">&lt;= </span><span style="color:#f07219;">1000</span><span>; </span><span style="color:#c82728;">$i</span><span style="color:#3e999f;">++</span><span>)
</span><span>{
</span><span>    </span><span style="color:#c82728;">run</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">$input</span><span style="color:#4271ae;">)</span><span>;
</span><span>    </span><span style="color:#4271ae;">echo </span><span style="color:#839c00;">&quot;Idle process number: &quot; </span><span style="color:#3e999f;">. </span><span style="color:#c82728;">$p_number </span><span style="color:#3e999f;">. </span><span style="color:#839c00;">&quot;</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;</span><span>;
</span><span>}
</span><span style="color:#f07219;">?&gt;
</span></code></pre>
<h3 id="cheng-xu-de-luo-ji">ç¨‹åºçš„é€»è¾‘ï¼š</h3>
<ol>
<li>
<p>è®¾ç½®/opt/zhangyan.php æœ€å¤šå…è®¸ç”Ÿæˆ 500 ä¸ªå­è¿›ç¨‹ï¼›</p>
</li>
<li>
<p>å½“/opt/zhangyan.php è¯»å–åˆ°ä¸€æ¡æ•°æ®åï¼Œå°†å…è®¸ç”Ÿæˆçš„å­è¿›ç¨‹æ•°å‡ 1ï¼ˆç©ºé—²è¿›ç¨‹æ•°$p_number=500-1=499ï¼‰ï¼Œç„¶åå°†æ•°æ®äº¤ç»™/opt/zhangyan.sh å»åå°å¤„ç†ï¼Œä¸ç­‰å¾…/opt/zhangyan.sh å¤„ç†ç»“æŸï¼Œç»§ç»­è¯»å–ä¸‹ä¸€æ¡æ•°æ®ï¼›</p>
</li>
<li>
<p>å½“å…è®¸ç”Ÿæˆçš„å­è¿›ç¨‹æ•°å‡è‡³ 0 æ—¶ï¼ˆç©ºé—²è¿›ç¨‹æ•°$p_number=0ï¼‰ï¼Œ/opt/zhangyan.php ä¼šç­‰å¾… 1 ç§’é’Ÿï¼Œç„¶åæ£€æŸ¥åå°è¿˜æœ‰å¤šå°‘ä¸ª/opt /zhangyan.sh å­è¿›ç¨‹å°šæœªå¤„ç†ç»“æŸï¼›</p>
</li>
<li>
<p>å¦‚æœ 1 ç§’é’Ÿä¹‹å/opt/zhangyan.php å‘ç°åå°çš„/opt /zhangyan.sh å­è¿›ç¨‹æ•°è¿˜æ˜¯ 500ï¼ˆç©ºé—²è¿›ç¨‹æ•°$p_number=0ï¼‰ï¼Œä¼šç»§ç»­ç­‰å¾… 1 ç§’é’Ÿï¼Œå¦‚æ­¤åå¤ï¼›</p>
</li>
<li>
<p>å¦‚æœ/opt /zhangyan.php å‘ç°åå°å°šæœªå¤„ç†ç»“æŸçš„/opt/zhangyan.sh å­è¿›ç¨‹æ•°å‡å°‘åˆ° 300 ä¸ªäº†ï¼ˆç©ºé—²è¿›ç¨‹æ•°$p_number=500-300=200ï¼‰ï¼Œé‚£ä¹ˆ/opt/zhangyan.php ä¼šå†å¾€åå°æ¨é€ 200 ä¸ª/opt/zhangyan.sh å­è¿›ç¨‹ï¼›</p>
</li>
</ol>
<p>æ€»ä½“æ¥è¯´è¿˜æ˜¯ä½¿ç”¨ pcntl_*ç³»å‡½æ•°æ›´æ–¹ä¾¿ä¸€äº›ï¼Œé€»è¾‘ä¹Ÿæ›´æ¸…æ¥šã€‚</p>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/php/">php</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // éƒ½æ˜¯ä¸ºäº† iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>