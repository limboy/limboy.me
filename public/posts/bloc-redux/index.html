<!DOCTYPE html>
<html>

<head>
  <meta content="width=device-width,initial-scale=1" name="viewport" />
  <meta charset="UTF-8">
  <link rel="icon" href="https://fav.farm/ğŸ‘»" />
  <title>
Architecture Flutter App the Bloc_Redux Way
</title>
  <link rel="stylesheet" href="/assets/main.css?gkCPK9ibGk2PIXzFp9c+CG7gIjpFY2pNyZ+E7aXMGlU=" />
  <script async defer data-domain="limboy.me" src="https://analytics.limboy.me/js/plausible.js"></script>
  
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content="@_limboy">
<meta name="twitter:site" content="@_limboy">
<meta property="og:url" content="https://limboy.me/posts/bloc-redux/">

<meta name="twitter:title" content="Architecture Flutter App the Bloc_Redux Way">
<meta property="og:title" content="Architecture Flutter App the Bloc_Redux Way">

<meta property="og:description" content="">
<meta name="twitter:description" content="">



</head>

<body class="  ">
  <nav class="flex justify-center items-center opacity-80 bg-black h-12 py-0 ">
    <div class="inner flex justify-between flex-row mx-1">
      <ul class="color-white flex flex-row justify-start gap-4">
        <li><a class="nav-link opacity-90 text-2xl" href="/">Limboy</a></li>
        <!--<li><a class="nav-link" href="/coodle">Coodle</a></li>-->
      </ul>
      <ul class="color-white flex flex-row gap-4 items-center text-base">
        <!--<li> <a class="nav-link" href="/books" class="decoration-0"> Books </a> </li>-->
        <li> <a class="nav-link" href="/highlights" class="decoration-0"> Highlights </a> </li>
        <li> <a class="nav-link" href="/projects" class="decoration-0"> Projects </a> </li>
        <li> <a class="nav-link" href="/about" class="decoration-0"> About </a> </li>
      </ul>
    </div>
  </nav>

  <div class="flex flex-col">
    <div id="wrapper" class="flex justify-center" style="min-height: calc(100vh - 6.5rem);">
      <div class="inner mb-2">
        
<div class="mt-4 lg:mt-6">
  

  <h1 class="title font-medium text-3xl"><a href="https:&#x2F;&#x2F;limboy.me&#x2F;posts&#x2F;bloc-redux&#x2F;">Architecture Flutter App the Bloc_Redux Way</a></h1>
  <div class="flex gap-4 items-center my-1">
    <time class="text-gray-500">2019-01-05</time>

  </div>
  <hr class="border-t-[3px]" />

  <div class="prose lg:prose-xl max-w-full my-6">
    <p>è¿™æ˜¯<a href="https://github.com/lzyy/bloc_redux">é¡¹ç›®åœ°å€</a>ï¼Œä¸‹é¢æ¥é˜è¿°ä¸‹äº§ç”ŸèƒŒæ™¯å’Œå®ƒçš„ä¸€äº›ç‰¹ç‚¹ã€‚</p>
<p>æ¥è§¦ Flutter ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œåœ¨å¦‚ä½•ç®¡ç†çŠ¶æ€å’Œå¤„ç†æ•°æ®æµè¿™å—ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨çš„ç°æˆæ–¹æ¡ˆã€‚å¥½å§ï¼Œå…¶å®æœ‰ï¼Œä¸€ä¸ªæ˜¯ <a href="https://github.com/brianegan/flutter_redux">flutter_redux</a>ï¼Œä¸€ä¸ªæ˜¯ <a href="https://github.com/felangel/bloc">flutter_bloc</a>ã€‚å…ˆæ¥è¯´è¯´ flutter_reduxï¼Œè¿™ä¸ªå¯ä»¥ç®—æ˜¯ redux åœ¨ flutter çš„å®˜æ–¹å®ç°äº†ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆ: <code>StoreProvider</code> å’Œ <code>StoreConnector</code>ï¼Œå‰è€…ç”¨æ¥ä¿å­˜ storeï¼Œåè€…ç”¨æ¥å“åº”æ–°çš„ stateï¼Œçœ‹ä¸€ä¸ªä»£ç ç‰‡æ®µï¼š</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8e908c;">// Every time the button is tapped, an action is dispatched and
</span><span style="color:#8e908c;">// run through the reducer. After the reducer updates the state,
</span><span style="color:#8e908c;">// the Widget will be automatically rebuilt with the latest
</span><span style="color:#8e908c;">// count. No need to manually manage subscriptions or Streams!
</span><span style="color:#8959a8;">new </span><span style="color:#c99e00;">StoreConnector</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">int</span><span>, </span><span style="color:#c99e00;">String</span><span style="color:#3e999f;">&gt;</span><span>(
</span><span>  converter</span><span style="color:#3e999f;">:</span><span> (store) </span><span style="color:#3e999f;">=&gt;</span><span> store.state.</span><span style="color:#4271ae;">toString</span><span>(),
</span><span>  builder</span><span style="color:#3e999f;">:</span><span> (context, count) {
</span><span>    </span><span style="color:#8959a8;">return new </span><span style="color:#c99e00;">Text</span><span>(
</span><span>      count,
</span><span>      style</span><span style="color:#3e999f;">: </span><span style="color:#c99e00;">Theme</span><span>.</span><span style="color:#4271ae;">of</span><span>(context).textTheme.display1,
</span><span>    );
</span><span>  },
</span><span>)
</span></code></pre>
<p>è¿™æ®µä»£ç çš„é—®é¢˜åœ¨äºåªè¦ reducer æœ‰æ›´æ–° stateï¼Œé‚£ä¹ˆæ‰€æœ‰æ¶ˆè´¹è¯¥ Store çš„ Connector å°±ä¼šè¢« rebuildï¼Œå“ªæ€•è¿™ä¸ª state æœ‰ 10 ä¸ªå±æ€§ï¼Œè€Œ reducer åªæ˜¯æ”¹äº†å…¶ä¸­çš„ä¸€ä¸ª bool å€¼ã€‚</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8e908c;">// Creates the base [NextDispatcher].
</span><span style="color:#8e908c;">//
</span><span style="color:#8e908c;">// The base NextDispatcher will be called after all other middleware provided
</span><span style="color:#8e908c;">// by the user have been run. Its job is simple: Run the current state through
</span><span style="color:#8e908c;">// the reducer, save the result, and notify any subscribers.
</span><span style="color:#c99e00;">NextDispatcher </span><span style="color:#4271ae;">_createReduceAndNotify</span><span>(</span><span style="color:#c99e00;">bool</span><span> distinct) {
</span><span>  </span><span style="color:#8959a8;">return</span><span> (</span><span style="color:#c99e00;">dynamic</span><span> action) {
</span><span>    </span><span style="color:#8959a8;">final</span><span> state </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">reducer</span><span>(_state, action);
</span><span>
</span><span>    </span><span style="color:#8959a8;">if</span><span> (distinct </span><span style="color:#3e999f;">&amp;&amp;</span><span> state </span><span style="color:#3e999f;">==</span><span> _state) </span><span style="color:#8959a8;">return</span><span>;
</span><span>
</span><span>    _state </span><span style="color:#3e999f;">=</span><span> state;
</span><span>    _changeController.</span><span style="color:#4271ae;">add</span><span>(state);
</span><span>  };
</span><span>}
</span></code></pre>
<p>è¿™æ˜¯ redux è¿™ä¸ª library é‡Œçš„ Notify æœºåˆ¶ï¼Œé‡‡ç”¨çš„æ˜¯ <code>==</code> åˆ¤æ–­ï¼Œè¿™å°±æ˜¯é—®é¢˜ã€‚åœ¨ <a href="https://github.com/reduxjs/react-redux">react-redux</a> ä¸­ï¼Œè¿™å—æ˜¯æœ‰ä¼˜åŒ–çš„ï¼Œé€šè¿‡ <code>connect</code> çš„ <code>mapStateToProps</code>ï¼Œå¯ä»¥è®© Component æŒ‡å®šå…³å¿ƒ State çš„å“ªäº›å±æ€§ï¼Œç„¶ååœ¨ react-redux å†…éƒ¨ä¼šå¯¹ <code>mapStateToProps</code> çš„è¿”å›å€¼å’Œä¸Šæ¬¡ä¿å­˜çš„è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ä¸€æ ·å† rebuildï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åªæœ‰å½“ Component å…³å¿ƒçš„å“ªäº›å±æ€§çœŸçš„å˜åŒ–æ—¶æ‰è¿›è¡Œ renderã€‚è€Œ flutter_redux æ— æ³•åšåˆ°è¿™ç‚¹(å¯èƒ½è·Ÿ flutter ä¸è®©ç”¨åå°„æœ‰å…³)ï¼Œæ•ˆç‡ä¸Šå°±ä¼šæ‰“æŠ˜æ‰£ã€‚</p>
<p>å†æ¥çœ‹çœ‹ <a href="https://github.com/felangel/bloc">flutter_bloc</a>ï¼Œè¿™ä¹Ÿæ˜¯å…³æ³¨åº¦è›®é«˜çš„ä¸€ä¸ªé¡¹ç›®ï¼Œè¯´è¿™ä¸ªä¹‹å‰å…ˆè¯´è¯´ blocï¼Œè¿™æ˜¯ flutter æçš„ä¸€ä¸ªæ¦‚å¿µï¼Œè¿è¡Œæœºåˆ¶å¤§è‡´å¦‚ä¸‹ï¼š</p>

<p  style="text-align:center" ><img src="&#x2F;posts&#x2F;bloc-redux&#x2F;movie250-bloc.png"
        width="561" /></p>
<p>å®ƒæ›´åƒä¸€ä¸ªææ¡ˆï¼Œç¼ºå°‘æ ‡å‡†å’Œå®ç°ã€‚flutter_bloc å°±æ˜¯å¯¹è¿™ä¸ªææ¡ˆçš„ä¸€ä¸ªå®ç°ã€‚è¿™ä¸ªå®ç°æœ¬è´¨ä¸Šæ²¡è§‰å¾—è·Ÿ flutter_redux æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œè€Œå¤æ‚åº¦å€’æ˜¯å¢åŠ äº†ä¸å°‘ï¼Œè¿˜æå‡ºäº†ä¸€äº›æ–°çš„æ¦‚å¿µ(æ¯”å¦‚ BlocSupervisor, BlocDelegate, Transation)ï¼Œå¢åŠ äº†ç†è§£ä¸Šçš„å›°éš¾ã€‚åœ¨å¤„ç†æ ¸å¿ƒçš„ state é—®é¢˜ä¸Šä¾æ—§è·Ÿ flutter_redux ä¸€æ ·ï¼Œç”šè‡³éƒ½æ²¡æœ‰åš <code>==</code> checkã€‚</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8959a8;">void </span><span style="color:#4271ae;">_bindStateSubject</span><span>() {
</span><span>  </span><span style="color:#c99e00;">Event</span><span> currentEvent;
</span><span>
</span><span>  (</span><span style="color:#4271ae;">transform</span><span>(_eventSubject) </span><span style="color:#8959a8;">as </span><span style="color:#c99e00;">Observable</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">Event</span><span style="color:#3e999f;">&gt;</span><span>).</span><span style="color:#4271ae;">concatMap</span><span>((</span><span style="color:#c99e00;">Event</span><span> event) {
</span><span>    currentEvent </span><span style="color:#3e999f;">=</span><span> event;
</span><span>    </span><span style="color:#8959a8;">return </span><span style="color:#4271ae;">mapEventToState</span><span>(_stateSubject.value, event);
</span><span>  }).</span><span style="color:#4271ae;">forEach</span><span>(
</span><span>    (</span><span style="color:#c99e00;">State</span><span> nextState) {
</span><span>      </span><span style="color:#8959a8;">final</span><span> transition </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">Transition</span><span>(
</span><span>        currentState</span><span style="color:#3e999f;">:</span><span> _stateSubject.value,
</span><span>        event</span><span style="color:#3e999f;">:</span><span> currentEvent,
</span><span>        nextState</span><span style="color:#3e999f;">:</span><span> nextState,
</span><span>      );
</span><span>      </span><span style="color:#c99e00;">BlocSupervisor</span><span>().delegate</span><span style="color:#3e999f;">?</span><span>.</span><span style="color:#4271ae;">onTransition</span><span>(transition);
</span><span>      </span><span style="color:#4271ae;">onTransition</span><span>(transition);
</span><span>      _stateSubject.</span><span style="color:#4271ae;">add</span><span>(nextState);
</span><span>    },
</span><span>  );
</span><span>}
</span></code></pre>
<p>å¯ä»¥çœ‹åˆ°åœ¨å¾€ <code>_stateSubject</code> é‡Œå¡ nextState æ—¶ç”šè‡³éƒ½æ²¡æœ‰è·Ÿä¹‹å‰çš„ state è¿›è¡Œåˆ¤æ–­ã€‚åŒæ—¶ä»ä½œè€…çš„æ„å›¾ä¸Šæ˜¯å¸Œæœ›å¤šä¸ª bloc ä¸€èµ·ä½¿ç”¨çš„ï¼Œè¿™ä¹Ÿä¼šé€ æˆä½¿ç”¨ä¸Šçš„ä¸ä¾¿ï¼ˆæ¯”å¦‚æˆ‘è¿™ä¸ª Event åˆ°åº•åº”è¯¥ dispatch ç»™å“ªä¸ª blocï¼Ÿï¼‰ã€‚</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8959a8;">return </span><span style="color:#c99e00;">BlocBuilder</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">LoginEvent</span><span>, </span><span style="color:#c99e00;">LoginState</span><span style="color:#3e999f;">&gt;</span><span>(
</span><span>  bloc</span><span style="color:#3e999f;">:</span><span> widget.loginBloc,
</span><span>  builder</span><span style="color:#3e999f;">:</span><span> (
</span><span>    </span><span style="color:#c99e00;">BuildContext</span><span> context,
</span><span>    </span><span style="color:#c99e00;">LoginState</span><span> loginState,
</span><span>  ) {
</span><span>    </span><span style="color:#8959a8;">if</span><span> (</span><span style="color:#4271ae;">_loginSucceeded</span><span>(loginState)) {
</span><span>      widget.authBloc.</span><span style="color:#4271ae;">dispatch</span><span>(</span><span style="color:#c99e00;">Login</span><span>(token</span><span style="color:#3e999f;">:</span><span> loginState.token));
</span><span>      widget.loginBloc.</span><span style="color:#4271ae;">dispatch</span><span>(</span><span style="color:#c99e00;">LoggedIn</span><span>());
</span><span>    }
</span><span>  }
</span><span>);
</span></code></pre>
<p>ç»¼ä¸Šï¼Œè¿™ä¸¤æ ¼ Library éƒ½æ— æ³•æ»¡è¶³æˆ‘ï¼Œåªèƒ½å†é€ ä¸€ä¸ªè½®å­äº†ã€‚</p>
<h2 id="bloc-redux">Bloc_Redux</h2>
<p>å…¶å®åªè¦è®© flutter_redux èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°æŠŠçŠ¶æ€å˜åŒ–ä¼ é€’ç»™ widgetsï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚é‚£å¦‚ä½•åšå‘¢ï¼Ÿè¿”å›ä¸€ä¸ªæ–°çš„ stateï¼Œä¹Ÿå°±æ˜¯ reducer ä¹‹è·¯ï¼Œåº”è¯¥æ˜¯è¡Œä¸é€šäº†ï¼Œå› ä¸ºæ— æ³•é«˜æ•ˆåœ°æ‰¾åˆ°å˜åŒ–è¿‡çš„å±æ€§ï¼Œå³ä½¿å¯ä»¥ï¼Œè¿˜è¦ç»´æŠ¤ä¸€ä¸ªå±æ€§è·Ÿ widgets çš„ mapï¼Œå¤ªå¤æ‚äº†ã€‚æ¢ä¸€ä¸ªæƒ³æ³•ï¼ŒFlutter ä¸æ˜¯æä¾›äº† <code>StreamBuilder</code> ä¹ˆï¼Œé‚£è®© Widget è‡ªå·±é€‰æ‹© listen å“ªäº› streamï¼Œç„¶åå½“ä¸€ä¸ª action dispatch è¿‡æ¥åï¼Œè¿™äº› stream è·å¾—ç›¸åº”çš„æ”¹å˜ä¸å°±è¡Œäº†ä¹ˆï¼Ÿ</p>
<p><img src="https://raw.githubusercontent.com/limboy/bloc_redux/master/lib/bloc_redux/bloc_redux.png" alt="" /></p>
<p>å…¶ä¸­å¤„ç† action çš„ reducer è¢«æ›¿æ¢æˆäº† blocï¼Œæ¥çœ‹ä¸€ä¸‹æ ¸å¿ƒä»£ç ã€‚</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8e908c;">/// Action
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// every action should extends this class
</span><span style="color:#8959a8;">abstract class </span><span style="color:#c99e00;">BRAction</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">T</span><span style="color:#3e999f;">&gt;</span><span> {
</span><span>  </span><span style="color:#c99e00;">T</span><span> payload;
</span><span>}
</span><span>
</span><span style="color:#8e908c;">/// State
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// Input are used to change state.
</span><span style="color:#8e908c;">/// usually filled with StreamController / BehaviorSubject.
</span><span style="color:#8e908c;">/// handled by blocs.
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// implements disposable because stream controllers needs to be disposed.
</span><span style="color:#8e908c;">/// they will be called within store&#39;s dispose method.
</span><span style="color:#8959a8;">abstract class </span><span style="color:#c99e00;">BRStateInput </span><span style="color:#8959a8;">implements </span><span style="color:#c99e00;">Disposable</span><span> {}
</span><span>
</span><span style="color:#8e908c;">/// Output are streams.
</span><span style="color:#8e908c;">/// followed by input. like someController.stream
</span><span style="color:#8e908c;">/// UI will use it as data source.
</span><span style="color:#8959a8;">abstract class </span><span style="color:#c99e00;">BRStateOutput</span><span> {}
</span><span>
</span><span style="color:#8e908c;">/// State
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// Combine these two into one.
</span><span style="color:#8959a8;">abstract class </span><span style="color:#c99e00;">BRState</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">T </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStateInput</span><span>, </span><span style="color:#c99e00;">U </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStateOutput</span><span style="color:#3e999f;">&gt;</span><span> {
</span><span>  </span><span style="color:#c99e00;">T</span><span> input;
</span><span>  </span><span style="color:#c99e00;">U</span><span> output;
</span><span>}
</span><span>
</span><span style="color:#8e908c;">/// Bloc
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// like reducers in redux, but don&#39;t return a new state.
</span><span style="color:#8e908c;">/// when they found something needs to change, just update state&#39;s input
</span><span style="color:#8e908c;">/// then state&#39;s output will change accordingly.
</span><span style="color:#8959a8;">typedef </span><span style="color:#c99e00;">Bloc</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">T </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStateInput</span><span style="color:#3e999f;">&gt; = </span><span style="color:#8959a8;">void </span><span style="color:#c99e00;">Function</span><span>(</span><span style="color:#c99e00;">BRAction</span><span> action, </span><span style="color:#c99e00;">T</span><span> input);
</span><span>
</span><span style="color:#8e908c;">/// Store
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// widget use `store.dispatch` to send action
</span><span style="color:#8e908c;">/// store will iterate all blocs to handle this action
</span><span style="color:#8e908c;">///
</span><span style="color:#8e908c;">/// if this is an async action, blocs can dispatch another action
</span><span style="color:#8e908c;">/// after data has received from remote.
</span><span style="color:#8959a8;">abstract class </span><span style="color:#c99e00;">BRStore</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">T </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStateInput</span><span>, </span><span style="color:#c99e00;">U </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRState</span><span style="color:#3e999f;">&gt;
</span><span>    </span><span style="color:#8959a8;">implements </span><span style="color:#c99e00;">Disposable</span><span> {
</span><span>  </span><span style="color:#c99e00;">List</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">Bloc</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">T</span><span style="color:#3e999f;">&gt;&gt;</span><span> blocs;
</span><span>  </span><span style="color:#c99e00;">U</span><span> state;
</span><span>
</span><span>  </span><span style="color:#8959a8;">void </span><span style="color:#4271ae;">dispatch</span><span>(</span><span style="color:#c99e00;">BRAction</span><span> action) {
</span><span>    blocs.</span><span style="color:#4271ae;">forEach</span><span>((f) </span><span style="color:#3e999f;">=&gt; </span><span style="color:#4271ae;">f</span><span>(action, state.input));
</span><span>  }
</span><span>
</span><span>  </span><span style="color:#4271ae;">dispose</span><span>() {
</span><span>    state.input.</span><span style="color:#4271ae;">dispose</span><span>();
</span><span>  }
</span><span>}
</span></code></pre>
<p>å…¶ä¸­ State è¢«åˆ†æˆäº† StateInput å’Œ StateOutputï¼Œå…¶ä¸­ Input éƒ¨åˆ†ç»™ Blocï¼Œæ–¹ä¾¿æ›´æ–° Streamï¼›Output éƒ¨åˆ†ç»™ Widgetsï¼Œæ–¹ä¾¿æ¥æ”¶æœ€æ–°æ•°æ®ã€‚åŒæ—¶ Store ä¹Ÿæœ‰ä¸€ä¸ª dispose æ–¹æ³•ï¼Œå› ä¸ºåˆ°æ—¶ store ä¼šè¢«æ”¾åˆ° StoreProvider é‡Œï¼Œå½“å®ƒè¢« dispose æ—¶ï¼Œå¯ä»¥è®© store ä¹Ÿ disposeï¼Œè®©é‚£äº› stream å¯ä»¥è¢« closeã€‚</p>
<p>å°±è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª demoï¼š</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8e908c;">/// Actions
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">ColorActionSelect </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRAction</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">Color</span><span style="color:#3e999f;">&gt;</span><span> {}
</span><span>
</span><span style="color:#8e908c;">/// State
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">ColorStateInput </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStateInput</span><span> {
</span><span>  </span><span style="color:#8959a8;">final </span><span style="color:#c99e00;">BehaviorSubject</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">Color</span><span style="color:#3e999f;">&gt;</span><span> selectedColor </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">BehaviorSubject</span><span>();
</span><span>  </span><span style="color:#8959a8;">final </span><span style="color:#c99e00;">BehaviorSubject</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">List</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorModel</span><span style="color:#3e999f;">&gt;&gt;</span><span> colors </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">BehaviorSubject</span><span>();
</span><span>
</span><span>  </span><span style="color:#4271ae;">dispose</span><span>() {
</span><span>    selectedColor.</span><span style="color:#4271ae;">close</span><span>();
</span><span>    colors.</span><span style="color:#4271ae;">close</span><span>();
</span><span>  }
</span><span>}
</span><span>
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">ColorStateOutput </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStateOutput</span><span> {
</span><span>  </span><span style="color:#c99e00;">StreamWithInitialData</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">Color</span><span style="color:#3e999f;">&gt;</span><span> selectedColor;
</span><span>  </span><span style="color:#c99e00;">StreamWithInitialData</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">List</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorModel</span><span style="color:#3e999f;">&gt;&gt;</span><span> colors;
</span><span>
</span><span>  </span><span style="color:#c99e00;">ColorStateOutput</span><span>(</span><span style="color:#c99e00;">ColorStateInput</span><span> input) {
</span><span>    selectedColor </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">StreamWithInitialData</span><span>(
</span><span>        input.selectedColor.stream, input.selectedColor.value);
</span><span>    colors </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">StreamWithInitialData</span><span>(input.colors.stream, input.colors.value);
</span><span>  }
</span><span>}
</span><span>
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">ColorState </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRState</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorStateInput</span><span>, </span><span style="color:#c99e00;">ColorStateOutput</span><span style="color:#3e999f;">&gt;</span><span> {
</span><span>  </span><span style="color:#c99e00;">ColorState</span><span>() {
</span><span>    input </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">ColorStateInput</span><span>();
</span><span>    output </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">ColorStateOutput</span><span>(input);
</span><span>  }
</span><span>}
</span><span>
</span><span style="color:#8e908c;">/// Blocs
</span><span style="color:#c99e00;">Bloc</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorStateInput</span><span style="color:#3e999f;">&gt;</span><span> colorSelectHandler </span><span style="color:#3e999f;">=</span><span> (action, input) {
</span><span>  </span><span style="color:#8959a8;">if</span><span> (action </span><span style="color:#3e999f;">is </span><span style="color:#c99e00;">ColorActionSelect</span><span>) {
</span><span>    input.selectedColor.</span><span style="color:#4271ae;">add</span><span>(action.payload);
</span><span>    </span><span style="color:#8959a8;">var</span><span> colors </span><span style="color:#3e999f;">=</span><span> input.colors.value
</span><span>        .</span><span style="color:#4271ae;">map</span><span>((colorModel) </span><span style="color:#3e999f;">=&gt;</span><span> colorModel
</span><span>          ..isSelected </span><span style="color:#3e999f;">=</span><span> colorModel.color.value </span><span style="color:#3e999f;">==</span><span> action.payload.value)
</span><span>        .</span><span style="color:#4271ae;">toList</span><span>();
</span><span>    input.colors.</span><span style="color:#4271ae;">add</span><span>(colors);
</span><span>  }
</span><span>};
</span><span>
</span><span style="color:#8e908c;">/// Store
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">ColorStore </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">BRStore</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorStateInput</span><span>, </span><span style="color:#c99e00;">ColorState</span><span style="color:#3e999f;">&gt;</span><span> {
</span><span>  </span><span style="color:#c99e00;">ColorStore</span><span>() {
</span><span>    state </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">ColorState</span><span>();
</span><span>    blocs </span><span style="color:#3e999f;">=</span><span> [colorSelectHandler];
</span><span>
</span><span>    </span><span style="color:#8e908c;">// init
</span><span>    </span><span style="color:#8959a8;">var</span><span> _colors </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">List</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorModel</span><span style="color:#3e999f;">&gt;</span><span>.</span><span style="color:#4271ae;">generate</span><span>(
</span><span>        </span><span style="color:#f07219;">30</span><span>, (</span><span style="color:#c99e00;">int</span><span> index) </span><span style="color:#3e999f;">=&gt; </span><span style="color:#c99e00;">ColorModel</span><span>(</span><span style="color:#c99e00;">RandomColor</span><span>(index).</span><span style="color:#4271ae;">randomColor</span><span>()));
</span><span>    _colors[</span><span style="color:#f07219;">0</span><span>].isSelected </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">true</span><span>;
</span><span>    state.input.colors.</span><span style="color:#4271ae;">add</span><span>(_colors);
</span><span>    state.input.selectedColor.</span><span style="color:#4271ae;">add</span><span>(_colors[</span><span style="color:#f07219;">0</span><span>].color);
</span><span>  }
</span><span>}
</span></code></pre>
<p>Store å°±åƒäººçš„å¤§è„‘ï¼Œè´Ÿè´£æ¥æ”¶ä¿¡æ¯åšå‡ºå†³ç­–ï¼Œè€Œä¿¡æ¯çš„å¤„ç†è€…å°±æ˜¯ä¸€ä¸ªä¸ªçš„ Blocã€‚å†æ¥çœ‹çœ‹ Widget æ˜¯å¦‚ä½•æ¥æ”¶æ•°æ®ï¼Œå‘é€ action çš„ã€‚</p>
<pre data-lang="dart" style="background-color:#f9f9f9;color:#111111;" class="language-dart "><code class="language-dart" data-lang="dart"><span style="color:#8959a8;">class </span><span style="color:#c99e00;">ColorsWidget </span><span style="color:#8959a8;">extends </span><span style="color:#c99e00;">StatelessWidget</span><span> {
</span><span>  </span><span style="color:#8959a8;">@override
</span><span>  </span><span style="color:#c99e00;">Widget </span><span style="color:#4271ae;">build</span><span>(</span><span style="color:#c99e00;">BuildContext</span><span> context) {
</span><span>    </span><span style="color:#8959a8;">final</span><span> store </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">StoreProvider</span><span>.</span><span style="color:#4271ae;">of</span><span>&lt;</span><span style="color:#c99e00;">ColorStore</span><span style="color:#3e999f;">&gt;</span><span>(context);
</span><span>    </span><span style="color:#8959a8;">final</span><span> colors </span><span style="color:#3e999f;">=</span><span> store.state.output.colors;
</span><span>
</span><span>    </span><span style="color:#8959a8;">return </span><span style="color:#c99e00;">StreamBuilder</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">List</span><span style="color:#3e999f;">&lt;</span><span style="color:#c99e00;">ColorModel</span><span style="color:#3e999f;">&gt;&gt;</span><span>(
</span><span>      stream</span><span style="color:#3e999f;">:</span><span> colors.stream,
</span><span>      initialData</span><span style="color:#3e999f;">:</span><span> colors.initialData,
</span><span>      builder</span><span style="color:#3e999f;">:</span><span> (context, snapshot) {
</span><span>        </span><span style="color:#8959a8;">final</span><span> colors </span><span style="color:#3e999f;">=</span><span> snapshot.data;
</span><span>        </span><span style="color:#8959a8;">return </span><span style="color:#c99e00;">SliverGrid</span><span>.</span><span style="color:#4271ae;">count</span><span>(
</span><span>            crossAxisCount</span><span style="color:#3e999f;">: </span><span style="color:#f07219;">6</span><span>,
</span><span>            children</span><span style="color:#3e999f;">:</span><span> colors.</span><span style="color:#4271ae;">map</span><span>((colorModel) {
</span><span>              </span><span style="color:#8959a8;">return </span><span style="color:#c99e00;">GestureDetector</span><span>(
</span><span>                onTap</span><span style="color:#3e999f;">:</span><span> () {
</span><span>                  store.</span><span style="color:#4271ae;">dispatch</span><span>(
</span><span>                      </span><span style="color:#c99e00;">ColorActionSelect</span><span>()..payload </span><span style="color:#3e999f;">=</span><span> colorModel.color);
</span><span>                },
</span><span>                child</span><span style="color:#3e999f;">: </span><span style="color:#c99e00;">Container</span><span>(
</span><span>                  decoration</span><span style="color:#3e999f;">: </span><span style="color:#c99e00;">BoxDecoration</span><span>(
</span><span>                      color</span><span style="color:#3e999f;">:</span><span> colorModel.color,
</span><span>                      border</span><span style="color:#3e999f;">: </span><span style="color:#c99e00;">Border</span><span>.</span><span style="color:#4271ae;">all</span><span>(width</span><span style="color:#3e999f;">:</span><span> colorModel.isSelected </span><span style="color:#3e999f;">? </span><span style="color:#f07219;">4 </span><span style="color:#3e999f;">: </span><span style="color:#f07219;">0</span><span>)),
</span><span>                ),
</span><span>              );
</span><span>            }).</span><span style="color:#4271ae;">toList</span><span>());
</span><span>      },
</span><span>    );
</span><span>  }
</span><span>}
</span></code></pre>
<p>é€šè¿‡ <code>StreamBuilder</code> æ¥æ¶ˆè´¹ state outputï¼Œé€šè¿‡ <code>store.dispatch</code> æ¥å‘é€ actionï¼ŒIt's that simple.</p>
<p>æœ€åï¼Œé™„ä¸Šé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/limboy/bloc_redux">https://github.com/limboy/bloc_redux</a></p>

  </div>


  <ul class="tags flex flex-wrap justify-center items-center gap-4 mt-5 mb-8 text-lg">
    
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/programming/">programming</a>
    </li>
    
    <li
      class="px-4 pb-[2px] leading-8 rounded-full border text-gray-700 border-gray-700 hover:text-gray-100 hover:border-gray-900 hover:bg-gray-900 transition-all">
      <a class="inline-block" href="https://limboy.me/tags/flutter/">flutter</a>
    </li>
    
    
  </ul>

  
  <script src="https://giscus.app/client.js" data-repo="limboy/telescope"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODEwOTA2MTg=" data-category="General"
    data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDY2MTQy" data-mapping="title" data-reactions-enabled="1"
    data-emit-metadata="0" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
  

  

</div>

      </div>
    </div>
    
    <footer
      class="flex border-t border-gray-300 text-gray-600 bg-gray-50 items-center justify-center h-12 text-sm mt-2">
      <div class="flex inner justify-center gap-4">
        <a class="hover:underline" href="https://github.com/limboy" target="_blank">GitHub</a>
        <a class="hover:underline" href="https://twitter.com/_limboy" target="_blank">Twitter</a>
        <a class="hover:underline" href="https://limboy.me/index.xml">RSS</a>
      </div>
    </footer>
    
  </div>

  
  

  <script>
    // éƒ½æ˜¯ä¸ºäº† iOS...
    document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    window.addEventListener('resize', () => {
      document.querySelector("#wrapper").style.minHeight = `calc(${window.innerHeight}px - 6.5rem)`
    })
  </script>
</body>

</html>